import{a_ as ve,gI as xe,t1 as Re,iU as S,t2 as we,t3 as $e,t4 as ce,aA as Ce,gu as G,e as r,a as x,jV as Ve,kO as te,au as U,y as a,a1 as d,ol as _e,I as Ie,t5 as Ae,a3 as z,mP as k,t6 as He,L as Q,Z as se,ng as B,m_ as ue,j as re,iZ as j,m as Ne,ms as Z,Y as ie,nu as We,t7 as Be,t8 as Ge,dJ as Me,bZ as ne,bO as Ue,bP as pe,rZ as je,jO as be,jN as ke,jJ as Fe,jM as Je,t9 as ze,hC as Ze,dT as qe,V as D,dK as Ke,c_ as De,ad as Qe,q as Ye,al as Xe,kL as et,cA as tt,b4 as nt,cB as ot,ir as st,ta as rt,dP as it,dQ as at,M as lt,v as ct}from"./index.da161cf1.js";import{a as ut}from"./BlendLayer.eacc4944.js";import{t as pt}from"./ScaleRangeLayer.1a5bb9a6.js";import{t as dt}from"./resourceExtension.748c0ef1.js";import{o as ht}from"./BoundsStore.13c0920f.js";import{i as mt}from"./MediaElementView.27349382.js";import"./jsonUtils.1c231e28.js";import"./PooledRBush.b9188fbe.js";import"./quickselect.b8e0afc3.js";import"./normalizeUtilsSync.ade119bb.js";import"./normalizeUtilsCommon.87227ae2.js";const y=Ce(),A=G(),X=G(),de=G();function E(e,t,n){return ve(y,t[0],t[1],1),xe(y,y,Re(A,n)),y[2]===0?S(e,y[0],y[1]):S(e,y[0]/y[2],y[1]/y[2])}function ft(e,t,n){return he(X,t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7]),he(de,n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7]),we(e,$e(X,X),de),e[8]!==0&&(e[0]/=e[8],e[1]/=e[8],e[2]/=e[8],e[3]/=e[8],e[4]/=e[8],e[5]/=e[8],e[6]/=e[8],e[7]/=e[8],e[8]/=e[8]),e}function he(e,t,n,o,s,i,l,c,u){ce(e,t,o,i,n,s,l,1,1,1),ve(y,c,u,1),$e(A,e);const[m,g,v]=xe(y,y,Re(A,A));return ce(A,m,0,0,0,g,0,0,0,v),we(e,A,e)}let oe=class extends Ve{projectOrWarn(e,t){if(e==null)return e;const{geometry:n,pending:o}=te(e,t);return o?null:o||n?n:(U.getLogger(this).warn("geometry could not be projected to the spatial reference",{georeference:this,geometry:e,sourceSpatialReference:e.spatialReference,targetSpatialReference:t}),null)}};oe=r([x("esri.layers.support.GeoreferenceBase")],oe);const Y=oe,ee=G(),p=j();let F=class extends Ne{constructor(){super(...arguments),this.sourcePoint=null,this.mapPoint=null}};r([a()],F.prototype,"sourcePoint",void 0),r([a({type:d})],F.prototype,"mapPoint",void 0),F=r([x("esri.layers.support.ControlPoint")],F);let P=class extends _e(Y){constructor(e){super(e),this.controlPoints=null,this.height=0,this.type="control-points",this.width=0}readControlPoints(e,t){const n=Ie.fromJSON(t.spatialReference),o=Ae(...t.coefficients,1);return e.map(s=>(S(p,s.x,s.y),E(p,p,o),{sourcePoint:s,mapPoint:new d({x:p[0],y:p[1],spatialReference:n})}))}writeControlPoints(e,t,n,o){if(this.transform!=null)e!=null&&h(e[0])&&(t.controlPoints=e.map(s=>{const i=s.sourcePoint;return{x:i.x,y:i.y}}),t.spatialReference=e[0].mapPoint.spatialReference.toJSON(),t.coefficients=this.transform.slice(0,8));else{const s=new z("web-document-write:invalid-georeference","Invalid 'controlPoints', 'width', 'height' configuration.",{layer:o?.layer,georeference:this});o?.messages?o.messages.push(s):U.getLogger(this).error(s.name,s.message)}}get coords(){if(this.controlPoints==null)return null;const e=this._updateTransform(ee);if(e==null||!h(this.controlPoints[0]))return null;const t=this.controlPoints[0].mapPoint.spatialReference;return xt(e,this.width,this.height,t)}set coords(e){if(this.controlPoints==null||!h(this.controlPoints[0]))return;const t=this.controlPoints[0].mapPoint.spatialReference;if((e=this.projectOrWarn(e,t))==null)return;const{width:n,height:o}=this,{rings:[[s,i,l,c]]}=e,u={sourcePoint:k(0,o),mapPoint:new d({x:s[0],y:s[1],spatialReference:t})},m={sourcePoint:k(0,0),mapPoint:new d({x:i[0],y:i[1],spatialReference:t})},g={sourcePoint:k(n,0),mapPoint:new d({x:l[0],y:l[1],spatialReference:t})},v={sourcePoint:k(n,o),mapPoint:new d({x:c[0],y:c[1],spatialReference:t})};h(u)&&h(m)&&h(g)&&h(v)&&(me(ee,u,m,g,v),this.controlPoints=this.controlPoints.map(({sourcePoint:R})=>(S(p,R.x,R.y),E(p,p,ee),{sourcePoint:R,mapPoint:new d({x:p[0],y:p[1],spatialReference:t})})))}get inverseTransform(){return this.transform==null?null:He(G(),this.transform)}get transform(){return this._updateTransform()}toMap(e){if(e==null||this.transform==null||this.controlPoints==null||!h(this.controlPoints[0]))return null;S(p,e.x,e.y);const t=this.controlPoints[0].mapPoint.spatialReference;return E(p,p,this.transform),new d({x:p[0],y:p[1],spatialReference:t})}toSource(e){if(e==null||this.inverseTransform==null||this.controlPoints==null||!h(this.controlPoints[0]))return null;const t=this.controlPoints[0].mapPoint.spatialReference;return e=e.normalize(),(e=te(e,t).geometry)==null?null:(S(p,e.x,e.y),E(p,p,this.inverseTransform),k(p[0],p[1]))}_updateTransform(e){const{controlPoints:t,width:n,height:o}=this;if(!(t!=null&&n>0&&o>0))return null;const[s,i,l,c]=t;if(!h(s))return null;const u=s.mapPoint.spatialReference,m=this._projectControlPoint(i,u),g=this._projectControlPoint(l,u),v=this._projectControlPoint(c,u);if(!m.valid||!g.valid||!v.valid||!h(m.controlPoint))return null;e==null&&(e=G());let R=null;return R=h(g.controlPoint)&&h(v.controlPoint)?me(e,s,m.controlPoint,g.controlPoint,v.controlPoint):h(g.controlPoint)?gt(e,s,m.controlPoint,g.controlPoint):yt(e,s,m.controlPoint),R.every(Te=>Te===0)?null:R}_projectControlPoint(e,t){if(!h(e))return{valid:!0,controlPoint:e};const{sourcePoint:n,mapPoint:o}=e,{geometry:s,pending:i}=te(o,t);return i?{valid:!1,controlPoint:null}:i||s?{valid:!0,controlPoint:{sourcePoint:n,mapPoint:s}}:(U.getLogger(this).warn("map point could not be projected to the spatial reference",{georeference:this,controlPoint:e,sourceSpatialReference:o.spatialReference,targetSpatialReference:t}),{valid:!1,controlPoint:null})}};function h(e){return e!=null&&e.sourcePoint!=null&&e.mapPoint!=null}r([a({type:[F],json:{write:{allowNull:!1,isRequired:!0}}})],P.prototype,"controlPoints",void 0),r([Q("controlPoints")],P.prototype,"readControlPoints",null),r([se("controlPoints")],P.prototype,"writeControlPoints",null),r([a()],P.prototype,"coords",null),r([a({json:{write:!0}})],P.prototype,"height",void 0),r([a({readOnly:!0})],P.prototype,"inverseTransform",null),r([a({readOnly:!0})],P.prototype,"transform",null),r([a({json:{write:!0}})],P.prototype,"width",void 0),P=r([x("esri.layers.support.ControlPointsGeoreference")],P);const w=j(),$=j(),C=j(),O=j(),_=j(),I=j(),V=j(),T=j(),q=Math.PI/2;function M(e,t,n){S(e,n.sourcePoint.x,n.sourcePoint.y),S(t,n.mapPoint.x,n.mapPoint.y)}function yt(e,t,n){return M(w,_,t),M($,I,n),B(C,$,w,q),B(O,w,$,q),B(V,I,_,-q),B(T,_,I,-q),ae(e,w,$,C,O,_,I,V,T)}function gt(e,t,n,o){return M(w,_,t),M($,I,n),M(C,V,o),ue(O,w,$,.5),B(O,C,O,Math.PI),ue(T,_,I,.5),B(T,V,T,Math.PI),ae(e,w,$,C,O,_,I,V,T)}function me(e,t,n,o,s){return M(w,_,t),M($,I,n),M(C,V,o),M(O,T,s),ae(e,w,$,C,O,_,I,V,T)}const Pt=new Array(8).fill(0),vt=new Array(8).fill(0);function fe(e,t,n,o,s){return e[0]=t[0],e[1]=t[1],e[2]=n[0],e[3]=n[1],e[4]=o[0],e[5]=o[1],e[6]=s[0],e[7]=s[1],e}function ae(e,t,n,o,s,i,l,c,u){return ft(e,fe(Pt,t,n,o,s),fe(vt,i,l,c,u))}function xt(e,t,n,o){const s=Z(0,n),i=Z(0,0),l=Z(t,0),c=Z(t,n);return E(s,s,e),E(i,i,e),E(l,l,e),E(c,c,e),new re({rings:[[s,i,l,c,s]],spatialReference:o})}const Le=P;let b=class extends Y{constructor(e){super(e),this.bottomLeft=null,this.bottomRight=null,this.topLeft=null,this.topRight=null,this.type="corners"}get coords(){let{topLeft:e,topRight:t,bottomLeft:n,bottomRight:o}=this;if(e==null||t==null||n==null||o==null)return null;const s=e.spatialReference;return t=this.projectOrWarn(t,s),n=this.projectOrWarn(n,s),o=this.projectOrWarn(o,s),t==null||n==null||o==null?null:new re({rings:[[[n.x,n.y],[e.x,e.y],[t.x,t.y],[o.x,o.y],[n.x,n.y]]],spatialReference:s})}set coords(e){const{topLeft:t}=this;if(t==null)return;const n=t.spatialReference;if((e=this.projectOrWarn(e,n))==null)return;const{rings:[[o,s,i,l]]}=e;this.bottomLeft=new d({x:o[0],y:o[1],spatialReference:n}),this.topLeft=new d({x:s[0],y:s[1],spatialReference:n}),this.topRight=new d({x:i[0],y:i[1],spatialReference:n}),this.bottomRight=new d({x:l[0],y:l[1],spatialReference:n})}};r([a()],b.prototype,"coords",null),r([a({type:d})],b.prototype,"bottomLeft",void 0),r([a({type:d})],b.prototype,"bottomRight",void 0),r([a({type:d})],b.prototype,"topLeft",void 0),r([a({type:d})],b.prototype,"topRight",void 0),b=r([x("esri.layers.support.CornersGeoreference")],b);const Rt=b;let H=class extends Y{constructor(e){super(e),this.extent=null,this.rotation=0,this.type="extent-and-rotation"}get coords(){if(this.extent==null)return null;const{xmin:e,ymin:t,xmax:n,ymax:o,spatialReference:s}=this.extent;let i;if(this.rotation){const{x:l,y:c}=this.extent.center,u=ye(l,c,this.rotation);i=[u(e,t),u(e,o),u(n,o),u(n,t)],i.push(i[0])}else i=[[e,t],[e,o],[n,o],[n,t],[e,t]];return new re({rings:[i],spatialReference:s})}set coords(e){if(e==null||this.extent==null)return;const t=this.extent.spatialReference;if((e=this.projectOrWarn(e,t))==null||e.extent==null)return;const{rings:[[n,o,s]],extent:{center:{x:i,y:l}}}=e,c=We(Math.PI/2-Math.atan2(o[1]-n[1],o[0]-n[0])),u=ye(i,l,-c),[m,g]=u(n[0],n[1]),[v,R]=u(s[0],s[1]);this.extent=new ie({xmin:m,ymin:g,xmax:v,ymax:R,spatialReference:t}),this.rotation=c}};function ye(e,t,n){const o=Be(n),s=Math.cos(o),i=Math.sin(o);return(l,c)=>[s*(l-e)+i*(c-t)+e,s*(c-t)-i*(l-e)+t]}r([a()],H.prototype,"coords",null),r([a({type:ie})],H.prototype,"extent",void 0),r([a({type:Number})],H.prototype,"rotation",void 0),H=r([x("esri.layers.support.ExtentAndRotationGeoreference")],H);const wt=H,$t={key:"type",base:Y,typeMap:{"control-points":Le,corners:Rt,"extent-and-rotation":wt}};let N=class extends Ge(_e(Me)){constructor(e){super(e),this.georeference=null,this.opacity=1}readGeoreference(e){return Le.fromJSON(e)}};r([a({types:$t,json:{write:!0}})],N.prototype,"georeference",void 0),r([Q("georeference")],N.prototype,"readGeoreference",null),r([a()],N.prototype,"opacity",void 0),N=r([x("esri.layers.support.MediaElementBase")],N);const le=N;let L=class extends le{constructor(e){super(e),this.content=null,this.image=null,this.type="image",this.image=null}load(){const e=this.image;if(typeof e=="string"){const t=ne(e,{responseType:"image"}).then(({data:n})=>{this._set("content",n)});this.addResolvingPromise(t)}else if(e instanceof HTMLImageElement){const t=e.decode().then(()=>{this._set("content",e)});this.addResolvingPromise(t)}else e?this._set("content",e):this.addResolvingPromise(Promise.reject(new z("image-element:invalid-image-type","Invalid image type",{image:e})));return Promise.resolve(this)}readImage(e,t,n){return Ue(t.url,n)}writeImage(e,t,n,o){if(e==null)return;const s=o?.portalItem,i=o?.resources;if(!s||!i)return void(typeof e=="string"&&(t[n]=pe(e,o)));const l=typeof e!="string"||je(e)||be(e)?null:e;if(l){if(ke(l)==null)return void(t[n]=l);const c=pe(l,{...o,verifyItemRelativeUrls:o&&o.verifyItemRelativeUrls?{writtenUrls:o.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},Fe.NO);if(s&&c&&!Je(c))return i.toKeep.push({resource:s.resourceFromPath(c),compress:!1}),void(t[n]=c)}t[n]="<pending>",i.pendingOperations.push(Ee(e).then(c=>{const u=It(c,s);t[n]=u.itemRelativeUrl,i.toAdd.push({resource:u,content:c,compress:!1,finish:m=>{this.image=m.url}})}))}};r([a({readOnly:!0})],L.prototype,"content",void 0),r([a({json:{name:"url",type:String}})],L.prototype,"image",void 0),r([Q("image",["url"])],L.prototype,"readImage",null),r([se("image")],L.prototype,"writeImage",null),r([a({readOnly:!0,json:{name:"mediaType"}})],L.prototype,"type",void 0),L=r([x("esri.layers.support.ImageElement")],L);const Se=L;async function Ee(e){if(typeof e=="string"){if(be(e)){const{data:t}=await ne(e,{responseType:"blob"});return t}return je(e)?ze(e):Ee((await ne(e,{responseType:"image"})).data)}return new Promise(t=>_t(e).toBlob(t))}function _t(e){if(e instanceof HTMLCanvasElement)return e;const t=e instanceof HTMLImageElement?e.naturalWidth:e.width,n=e instanceof HTMLImageElement?e.naturalHeight:e.height,o=document.createElement("canvas"),s=o.getContext("2d");return o.width=t,o.height=n,e instanceof HTMLImageElement?s.drawImage(e,0,0,e.width,e.height):e instanceof ImageData&&s.putImageData(e,0,0),o}function It(e,t){const n=Ze(),o=`${qe("media",n)}.${dt(e)}`;return t.resourceFromPath(o)}let J=class extends le{constructor(e){super(e),this.content=null,this.type="video"}load(){const e=this.video;if(typeof e=="string"){const t=document.createElement("video");t.src=e,t.crossOrigin="anonymous",t.autoplay=!0,t.muted=!0,t.loop=!0,this.addResolvingPromise(this._loadVideo(t).then(()=>{this._set("content",t)}))}else e instanceof HTMLVideoElement?this.addResolvingPromise(this._loadVideo(e).then(()=>{this._set("content",e)})):this.addResolvingPromise(Promise.reject(new z("video-element:invalid-video-type","Invalid video type",{video:e})));return Promise.resolve(this)}set video(e){this.loadStatus==="not-loaded"?this._set("video",e):U.getLogger(this).error("#video","video cannot be changed after the element is loaded.")}_loadVideo(e){return new Promise((t,n)=>{e.oncanplay=()=>{e.oncanplay=null,e.play().then(t,n)},e.crossOrigin!=="anonymous"&&(e.crossOrigin="anonymous",e.src=e.src)})}};r([a({readOnly:!0})],J.prototype,"content",void 0),r([a()],J.prototype,"video",null),J=r([x("esri.layers.support.VideoElement")],J);const Oe=J,Mt={key:"type",defaultKeyValue:"image",base:le,typeMap:{image:Se,video:Oe}},ge=D.ofType(Mt);let W=class extends Me.LoadableMixin(Ke(De(Qe.EventedAccessor))){constructor(e){super(e),this._index=new ht,this._elementViewsMap=new Map,this._elementsIndexes=new Map,this._elementsChangedHandler=t=>{for(const o of t.removed){const s=this._elementViewsMap.get(o);this._elementViewsMap.delete(o),this._index.delete(s),this.handles.remove(s),s.destroy(),this.notifyChange("fullExtent")}const{spatialReference:n}=this;for(const o of t.added){if(this._elementViewsMap.get(o))continue;const s=new mt({spatialReference:n,element:o});this._elementViewsMap.set(o,s);const i=Ye(()=>s.coords,()=>this._updateIndexForElement(s,!1));this._updateIndexForElement(s,!0),this.handles.add(i,s)}this._elementsIndexes.clear(),this.elements.forEach((o,s)=>this._elementsIndexes.set(o,s)),this.emit("refresh")},this.elements=new ge}async load(e){if(Xe(e),!this.spatialReference){const t=this.elements.find(n=>n.georeference!=null&&n.georeference.coords!=null);this._set("spatialReference",t?t.georeference.coords.spatialReference:Ie.WGS84)}return this._elementsChangedHandler({added:this.elements.items,removed:[]}),this.handles.add(this.elements.on("change",this._elementsChangedHandler)),this}destroy(){this._index.clear(),this._elementViewsMap.clear(),this._elementsIndexes.clear()}set elements(e){this._set("elements",et(e,this._get("elements"),ge))}get fullExtent(){if(this.loadStatus==="not-loaded")return null;const e=this._index.fullBounds;return e==null?null:new ie({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:this.spatialReference})}set spatialReference(e){this.loadStatus==="not-loaded"?this._set("spatialReference",e):U.getLogger(this).error("#spatialReference","spatialReference cannot be changed after the source is loaded.")}async queryElements(e,t){await this.load(),await tt(e.spatialReference,this.spatialReference,null,t);const n=nt(e.spatialReference,this.spatialReference)?e:ot(e,this.spatialReference);if(!n)return[];const o=n.normalize(),s=[];for(const i of o)this._index.forEachInBounds(st(i),({normalizedCoords:l,element:c})=>{l!=null&&rt(i,l)&&s.push(c)});return s.sort((i,l)=>this._elementsIndexes.get(i)-this._elementsIndexes.get(l)),s}_updateIndexForElement(e,t){const n=e.normalizedBounds,o=this._index.has(e),s=n!=null;this._index.delete(e),s&&this._index.set(e,n),this.notifyChange("fullExtent"),t||(o!==s?this.emit("refresh"):this.emit("change",{element:e.element}))}};r([a()],W.prototype,"elements",null),r([a({readOnly:!0})],W.prototype,"fullExtent",null),r([a()],W.prototype,"spatialReference",null),W=r([x("esri.layers.support.LocalMediaElementSource")],W);const K=W;function Pe(e){return typeof e=="object"&&e!=null&&"type"in e}let f=class extends ut(pt(it(at(ct)))){constructor(e){super(e),this.effectiveSource=null,this.copyright=null,this.operationalLayerType="MediaLayer",this.spatialReference=null,this.type="media",this.source=new K}load(e){const t=this.source;if(!t)return this.addResolvingPromise(Promise.reject(new z("media-layer:source-missing","Set 'MediaLayer.source' before loading the layer."))),Promise.resolve(this);const n=Pe(t)?new K({elements:new D([t])}):t;this._set("effectiveSource",n),this.spatialReference&&(n.spatialReference=this.spatialReference);const o=n.load(e).then(()=>{this.spatialReference=n.spatialReference});return this.addResolvingPromise(o),Promise.resolve(this)}destroy(){this.effectiveSource?.destroy(),this.source?.destroy()}get fullExtent(){return this.loaded?this.effectiveSource.fullExtent:null}set source(e){this.loadStatus==="not-loaded"?this._set("source",e):U.getLogger(this).error("#source","source cannot be changed after the layer is loaded.")}castSource(e){return e?Array.isArray(e)?new K({elements:new D(e)}):e instanceof D?new K({elements:e}):e:null}readSource(e,t,n){const o=t.mediaType==="image"?new Se:t.mediaType==="video"?new Oe:null;return o?.read(t,n),o}writeSource(e,t,n,o){e&&Pe(e)&&e.type==="image"?e.write(t,o):o?.messages&&o?.messages?.push(new z("media-layer:unsupported-source","source must be an 'ImageElement'"))}};r([a({readOnly:!0})],f.prototype,"effectiveSource",void 0),r([a({type:String})],f.prototype,"copyright",void 0),r([a({readOnly:!0})],f.prototype,"fullExtent",null),r([a({type:["MediaLayer"]})],f.prototype,"operationalLayerType",void 0),r([a({type:["show","hide"]})],f.prototype,"listMode",void 0),r([a({nonNullable:!0,json:{write:{enabled:!0,allowNull:!1}}})],f.prototype,"source",null),r([lt("source")],f.prototype,"castSource",null),r([Q("source",["url"])],f.prototype,"readSource",null),r([se("source")],f.prototype,"writeSource",null),r([a()],f.prototype,"spatialReference",void 0),r([a({readOnly:!0})],f.prototype,"type",void 0),f=r([x("esri.layers.MediaLayer")],f);const Nt=f;export{Nt as default};
