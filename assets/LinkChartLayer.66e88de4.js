import{jE as V,ah as ct,e as o,y as l,a as v,m as pe,H as J,I as Gt,ao as tr,cd as Ue,ce as qe,a3 as _,k9 as it,cE as Rt,a1 as ye,cD as ee,j as me,au as le,bZ as ce,eu as rr,cA as St,jk as Le,cB as Nt,dO as nr,sW as ir,J as te,Q as yt,dU as ar,Y as ve,e3 as or,v as $t,V as mt,ag as ft,al as sr}from"./index.da161cf1.js";import{p as K}from"./geohashUtils.a46ddc15.js";import{e as gt}from"./sql.414b1952.js";import{b as ne}from"./Query.e586665e.js";import"./UniqueValueRenderer.0143139a.js";import{t as Se,p as lr}from"./jsonUtils.4745b876.js";import{m as pr}from"./FeatureStore.e774d369.js";import{e as dr}from"./QueryEngine.f42b4b13.js";import{c as ur,o as Ne}from"./clientSideDefaults.f7f5ffde.js";import{s as hr}from"./fieldProperties.174d0f24.js";import{a as jt}from"./BlendLayer.eacc4944.js";import{n as cr}from"./FeatureReductionLayer.9f7296a1.js";import{t as Pt}from"./ScaleRangeLayer.1a5bb9a6.js";import{d as yr}from"./FeatureSet.97dc0f24.js";import{p as mr}from"./popupUtils.f5ffced0.js";import"./ColorStop.f762bde8.js";import"./diffUtils.f0876598.js";import"./colorRamps.80cb140e.js";import"./DictionaryLoader.90c8c47c.js";import"./FieldsIndex.09813895.js";import"./heatmapUtils.32e9a30b.js";import"./BoundsStore.13c0920f.js";import"./PooledRBush.b9188fbe.js";import"./quickselect.b8e0afc3.js";import"./optimizedFeatureQueryEngineAdapter.b17e3ee2.js";import"./centroid.66ea1f85.js";import"./normalizeUtils.54c24a4d.js";import"./normalizeUtilsCommon.87227ae2.js";import"./WhereClause.c0b1e923.js";import"./executionError.10e29c03.js";import"./json.7bed7e43.js";import"./QueryEngineCapabilities.a6a6a20b.js";import"./utils.8873e24e.js";import"./generateRendererUtils.e8dfecdf.js";import"./defaultsJSON.a416f32c.js";import"./jsonUtils.1c231e28.js";import"./featureLayerUtils.0566dc37.js";import"./AttachmentQuery.c430db32.js";import"./RelationshipQuery.60e2b826.js";import"./LabelClass.1c6b8047.js";import"./defaults.83793da7.js";const fr="ESRI__DESTINATION_ID",gr="ESRI__ORIGIN_ID";class Q{constructor(){this._featureLookup=new Map}static getInstance(){return Q.instance||(Q.instance=new Q),Q.instance}static resetInstance(){Q.instance&&(Q.instance=null)}deleteFromStore(t){t.forEach(r=>{this._featureLookup.delete(r)})}readFromStoreByList(t){const r=[];return t.forEach(n=>{const i=this.readFromStoreById(n);i&&r.push(i)}),r}readFromStoreById(t){return this._featureLookup.get(t)??null}writeToStore(t,r,n){const i=[];return t.forEach(a=>{if(!a||!a.id)return;a.properties||(a.properties=[]);let s,d=null;if(n&&(d=a.properties[n]?V(a.properties[n]):null),"originId"in a&&"destinationId"in a&&(a.properties[gr]=a.originId,a.properties[fr]=a.destinationId),a.properties[r]=a.id,a.id&&this._featureLookup.has(a.id)&&this._featureLookup.get(a.id).attributes){const p=this._featureLookup.get(a.id);s=new ct(d?JSON.parse(JSON.stringify(d)):p?.geometry?JSON.parse(JSON.stringify(p.geometry)):null,JSON.parse(JSON.stringify(Object.assign(p.attributes,a.properties))),null,a.properties[r])}else s=new ct(d?JSON.parse(JSON.stringify(d)):null,a.properties,null,a.properties[r]);this._featureLookup.set(a.id,s),i.push(s)}),i}}let be=class extends pe{constructor(e){super(e),this.resultRows=[]}};o([l()],be.prototype,"resultRows",void 0),be=o([v("esri.rest.knowledgeGraph.GraphQueryResult")],be);const wt=be;let Te=class extends pe{constructor(e){super(e),this.resultRowsStream=new ReadableStream}};o([l()],Te.prototype,"resultRowsStream",void 0),Te=o([v("esri.rest.knowledgeGraph.GraphQueryResult")],Te);const _t=Te;let B=class extends J{constructor(e){super(e),this.name=null,this.unique=null,this.ascending=null,this.description=null,this.fieldNames=null}};o([l({type:String,json:{write:!0}})],B.prototype,"name",void 0),o([l({type:Boolean,json:{write:!0}})],B.prototype,"unique",void 0),o([l({type:Boolean,json:{write:!0}})],B.prototype,"ascending",void 0),o([l({type:String,json:{write:!0}})],B.prototype,"description",void 0),o([l({type:[String],json:{write:!0}})],B.prototype,"fieldNames",void 0),B=o([v("esri.rest.knowledgeGraph.FieldIndex")],B);const Ot=B;let $=class extends J{constructor(e){super(e),this.name=null,this.alias=null,this.fieldType=null,this.geometryType=null,this.hasM=null,this.hasZ=null,this.nullable=null,this.editable=null,this.required=null,this.defaultVisibility=null,this.systemMaintained=null,this.role=null,this.defaultValue=null}};o([l({type:String,json:{write:!0}})],$.prototype,"name",void 0),o([l({type:String,json:{write:!0}})],$.prototype,"alias",void 0),o([l({type:String,json:{write:!0}})],$.prototype,"fieldType",void 0),o([l({type:String,json:{write:!0}})],$.prototype,"geometryType",void 0),o([l({type:Boolean,json:{write:!0}})],$.prototype,"hasM",void 0),o([l({type:Boolean,json:{write:!0}})],$.prototype,"hasZ",void 0),o([l({type:Boolean,json:{write:!0}})],$.prototype,"nullable",void 0),o([l({type:Boolean,json:{write:!0}})],$.prototype,"editable",void 0),o([l({type:Boolean,json:{write:!0}})],$.prototype,"required",void 0),o([l({type:Boolean,json:{write:!0}})],$.prototype,"defaultVisibility",void 0),o([l({type:Boolean,json:{write:!0}})],$.prototype,"systemMaintained",void 0),o([l()],$.prototype,"role",void 0),o([l({type:Object,json:{type:String,write:{writer:(e,t)=>{t.defaultValue=e!=null?e.toString():null}}}})],$.prototype,"defaultValue",void 0),$=o([v("esri.rest.knowledgeGraph.GraphProperty")],$);const Ft=$;let q=class extends J{constructor(e){super(e),this.name=null,this.alias=null,this.role=null,this.strict=null,this.properties=null,this.fieldIndexes=null}};o([l({type:String,json:{write:!0}})],q.prototype,"name",void 0),o([l({type:String,json:{write:!0}})],q.prototype,"alias",void 0),o([l({type:String,json:{write:!0}})],q.prototype,"role",void 0),o([l({type:Boolean,json:{write:!0}})],q.prototype,"strict",void 0),o([l({type:[Ft],json:{write:!0}})],q.prototype,"properties",void 0),o([l({type:[Ot],json:{write:!0}})],q.prototype,"fieldIndexes",void 0),q=o([v("esri.rest.knowledgeGraph.GraphObjectType")],q);const At=q;let Ye=class extends At{constructor(e){super(e)}};Ye=o([v("esri.rest.knowledgeGraph.EntityType")],Ye);const at=Ye;let Ee=class extends At{constructor(e){super(e),this.endPoints=[]}};o([l()],Ee.prototype,"endPoints",void 0),Ee=o([v("esri.rest.knowledgeGraph.RelationshipType")],Ee);const ot=Ee;let O=class extends J{constructor(e){super(e),this.timestamp=null,this.spatialReference=null,this.strict=null,this.objectIdField=null,this.globalIdField=null,this.arcgisManaged=null,this.identifierInfo=null,this.searchIndexes=null,this.entityTypes=null,this.relationshipTypes=null}};o([l({type:Date,json:{type:Number,write:{writer:(e,t)=>{t.timestamp=e?.getTime()}}}})],O.prototype,"timestamp",void 0),o([l({type:Gt,json:{write:!0}})],O.prototype,"spatialReference",void 0),o([l({type:Boolean,json:{write:!0}})],O.prototype,"strict",void 0),o([l({type:String,json:{write:!0}})],O.prototype,"objectIdField",void 0),o([l({type:String,json:{write:!0}})],O.prototype,"globalIdField",void 0),o([l()],O.prototype,"arcgisManaged",void 0),o([l()],O.prototype,"identifierInfo",void 0),o([l()],O.prototype,"searchIndexes",void 0),o([l({type:[at],json:{write:!0}})],O.prototype,"entityTypes",void 0),o([l({type:[ot],json:{write:!0}})],O.prototype,"relationshipTypes",void 0),O=o([v("esri.rest.knowledgeGraph.DataModel")],O);const zt=O;let G=class extends J{constructor(e){super(e),this.capabilities=[],this.supportsSearch=!1,this.supportedQueryFormats=[],this.allowGeometryUpdates=!1,this.searchMaxRecordCount=null,this.serviceCapabilities=null,this.maxRecordCount=null,this.description="",this.copyrightText="",this.units="",this.spatialReference=null,this.currentVersion=null,this.dateFieldsTimeReference=null,this.serviceItemId="",this.supportsDocuments=!1,this.dataEditingNotSupported=!1,this.schemaEditingNotSupported=!1}};o([l({type:[String],json:{write:!0}})],G.prototype,"capabilities",void 0),o([l({type:Boolean,json:{write:!0}})],G.prototype,"supportsSearch",void 0),o([l({type:[String],json:{write:!0}})],G.prototype,"supportedQueryFormats",void 0),o([l({type:Boolean,json:{write:!0}})],G.prototype,"allowGeometryUpdates",void 0),o([l({type:Number,json:{write:!0}})],G.prototype,"searchMaxRecordCount",void 0),o([l({type:Object,json:{write:!0}})],G.prototype,"serviceCapabilities",void 0),o([l({type:Number,json:{write:!0}})],G.prototype,"maxRecordCount",void 0),o([l({type:String,json:{write:!0}})],G.prototype,"description",void 0),o([l({type:String,json:{write:!0}})],G.prototype,"copyrightText",void 0),o([l({type:String,json:{write:!0}})],G.prototype,"units",void 0),o([l({type:Object,json:{write:!0}})],G.prototype,"spatialReference",void 0),o([l({type:Number,json:{write:!0}})],G.prototype,"currentVersion",void 0),o([l({type:Object,json:{write:!0}})],G.prototype,"dateFieldsTimeReference",void 0),o([l({type:String,json:{write:!0}})],G.prototype,"serviceItemId",void 0),o([l({type:Boolean,json:{write:!0}})],G.prototype,"supportsDocuments",void 0),o([l({type:Boolean,json:{write:!0}})],G.prototype,"dataEditingNotSupported",void 0),o([l({type:Boolean,json:{write:!0}})],G.prototype,"schemaEditingNotSupported",void 0),G=o([v("esri.rest.knowledgeGraph.ServiceDefinition")],G);const Qt=G;let ie=class extends J{constructor(e){super(e),this.dataModel=null,this.serviceDefinition=null}};o([l({type:String,json:{write:!0}})],ie.prototype,"url",void 0),o([l({type:zt,json:{write:!0}})],ie.prototype,"dataModel",void 0),o([l({type:Qt,json:{write:!0}})],ie.prototype,"serviceDefinition",void 0),ie=o([v("esri.rest.knowledgeGraph.KnowledgeGraph")],ie);const wr=ie,bt="esri/rest/knowledgeGraph/wasmInterface/";let $e;async function H(){const e=$e;if(e)return e;const t=tr("wasm-simd");return $e=_r(t),$e}async function _r(e){if(e){const{default:r}=await Ue(()=>import("./arcgis-knowledge-client-core-simd.3e57dc6f.js"),["assets/arcgis-knowledge-client-core-simd.3e57dc6f.js","assets/index.da161cf1.js","assets/index.8db76e31.css"]).then(n=>n.a);return r({locateFile:n=>qe(bt+n)})}const{default:t}=await Ue(()=>import("./arcgis-knowledge-client-core.0661a09c.js"),["assets/arcgis-knowledge-client-core.0661a09c.js","assets/index.da161cf1.js","assets/index.8db76e31.css"]).then(r=>r.a);return t({locateFile:r=>qe(bt+r)})}function Ut(e,t){const r=new t.ArrayValue;return r.deleteLater(),e.forEach(n=>{r.add_value(lt(n,t))}),r}function qt(e,t){const r=new t.ObjectValue;r.deleteLater();for(const[n,i]of Object.entries(e))r.set_key_value(n,lt(i,t));return r}function st(e,t){if(e instanceof Rt)return kr(e,t);if(e instanceof ye)return Mr(e,t);if(e instanceof ee||e instanceof me)return Er(e,t);throw new _("knowledge-graph:unsupported-geometry","Only Point, Multipoint, Polyline, and Polygon geometry are supported by ArcGIS Knowledge",{geometry:e})}function br(e,t){t.input_quantization_parameters={xy_resolution:e.xyResolution,x_false_origin:e.xFalseOrigin,y_false_origin:e.yFalseOrigin,z_resolution:e.zResolution,z_false_origin:e.zFalseOrigin,m_resolution:e.mResolution,m_false_origin:e.mFalseOrigin}}function Tr(e,t,r){if(!e.extent)throw new _("knowledge-graph:illegal-output-quantization","The Output quantization provided to the encoder had an illegal value as part of its extent",e.extent);if(!e.quantizeMode)throw new _("knowledge-graph:illegal-output-quantization","The Output quantization contained an illegal mode setting",e.quantizeMode);if(!e.tolerance)throw new _("knowledge-graph:illegal-output-quantization","The Output quantization contained an illegal tolerance setting",e.quantizeMode);t.output_quantization_parameters={extent:{xmax:e.extent.xmax,ymax:e.extent.ymax,xmin:e.extent.xmin,ymin:e.extent.ymin},quantize_mode:r.esriQuantizeMode[e.quantizeMode],tolerance:e.tolerance}}function lt(e,t){if(e==null)return"";if(typeof e!="object"||e instanceof Date)return e;if(e instanceof it)return st(e,t);if(Array.isArray(e)){const r=new t.ArrayValue;return r.deleteLater(),e.forEach(n=>{r.add_value(lt(n,t))}),r}return qt(e,t)}function Er(e,t){const r=new t.GeometryValue;r.deleteLater(),r.has_z=e.hasZ,r.has_m=e.hasM;const n=[],i=[];let a=[];e instanceof ee?(r.geometry_type=t.esriGeometryType.esriGeometryPolyline,a=e.paths):e instanceof me&&(r.geometry_type=t.esriGeometryType.esriGeometryPolygon,a=e.rings);let s=0,d=0;return a.forEach(p=>{let h=0;p.forEach(y=>{h++,y.forEach(I=>{n[d]=I,d++})}),i[s]=h,s++}),r.coords=new Float64Array(n),r.lengths=new Uint32Array(i),r}function kr(e,t){const r=new t.GeometryValue;r.deleteLater(),r.geometry_type=r.geometry_type=t.esriGeometryType.esriGeometryMultipoint,r.has_z=e.hasZ,r.has_m=e.hasM;const n=[],i=[];i[0]=e.points.length;let a=0;return e.points.forEach(s=>{s.forEach(d=>{n[a]=d,a++})}),r.coords=new Float64Array(n),r.lengths=new Uint32Array(i),r}function Mr(e,t){const r=new t.GeometryValue;r.deleteLater(),r.geometry_type=t.esriGeometryType.esriGeometryPoint,r.has_z=e.hasZ,r.has_m=e.hasM;const n=[],i=[];i[0]=1,n[0]=e.x,n[1]=e.y;let a=2;return e.hasZ&&(n[a]=e.z,a++),e.hasM&&(n[a]=e.m,a++),r.coords=new Float64Array(n),r.lengths=new Uint32Array(i),r}let ke=class extends J{constructor(e){super(e),this.properties=null}};o([l({json:{write:!0}})],ke.prototype,"properties",void 0),ke=o([v("esri.rest.knowledgeGraph.GraphObject")],ke);const pt=ke;let he=class extends pt{constructor(e){super(e),this.typeName=null,this.id=null}};o([l({type:String,json:{write:!0}})],he.prototype,"typeName",void 0),o([l({type:String,json:{write:!0}})],he.prototype,"id",void 0),he=o([v("esri.rest.knowledgeGraph.GraphNamedObject")],he);const Yt=he;let Me=class extends Yt{constructor(e){super(e),this.layoutGeometry=null}};o([l({type:ye,json:{write:!0}})],Me.prototype,"layoutGeometry",void 0),Me=o([v("esri.rest.knowledgeGraph.Entity")],Me);const Bt=Me;let ae=class extends Yt{constructor(e){super(e),this.originId=null,this.destinationId=null,this.layoutGeometry=null}};o([l({type:String,json:{write:!0}})],ae.prototype,"originId",void 0),o([l({type:String,json:{write:!0}})],ae.prototype,"destinationId",void 0),o([l({type:ee,json:{write:!0}})],ae.prototype,"layoutGeometry",void 0),ae=o([v("esri.rest.Relationship.Relationship")],ae);const Ht=ae;function ge(e,t){if(!e.typeName)throw new _("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits");if(e instanceof Bt){const r=new t.EntityValue;r.deleteLater(),r.type_name=e.typeName;for(const[n,i]of Object.entries(e.properties))r.set_key_value(n,Tt(i,t));return e.id&&r.set_id(e.id),r}if(e instanceof Ht){const r=new t.RelationshipValue;r.deleteLater(),r.type_name=e.typeName;for(const[n,i]of Object.entries(e.properties))r.set_key_value(n,Tt(i,t));return e.id&&r.set_id(e.id),e.originId&&e.destinationId&&r.set_related_entity_ids(e.originId,e.destinationId),r}throw new _("knowledge-graph:applyEdits-encoding-failure","Could not determine the type of a named graph object passed to the encoder")}function Ir(e){return{xy_resolution:e.xyResolution,x_false_origin:e.xFalseOrigin,y_false_origin:e.yFalseOrigin,z_resolution:e.zResolution,z_false_origin:e.zFalseOrigin,m_resolution:e.mResolution,m_false_origin:e.mFalseOrigin}}function Tt(e,t){return e==null?"":typeof e!="object"||e instanceof Date?e:e instanceof it?st(e,t):""}let W=class extends pe{constructor(e){super(e),this.name=null,this.supportedCategory=null,this.analyzers=[],this.searchProperties=new Map}};o([l()],W.prototype,"name",void 0),o([l()],W.prototype,"supportedCategory",void 0),o([l()],W.prototype,"analyzers",void 0),o([l()],W.prototype,"searchProperties",void 0),W=o([v("esri.rest.knowledgeGraph.SearchIndex")],W);const Cr=W;var De,xe,Ge,Be,He,Je,Ve;(function(e){e[e.Regular=0]="Regular",e[e.Provenance=1]="Provenance",e[e.Document=2]="Document"})(De||(De={})),function(e){e[e.esriFieldTypeSmallInteger=0]="esriFieldTypeSmallInteger",e[e.esriFieldTypeInteger=1]="esriFieldTypeInteger",e[e.esriFieldTypeSingle=2]="esriFieldTypeSingle",e[e.esriFieldTypeDouble=3]="esriFieldTypeDouble",e[e.esriFieldTypeString=4]="esriFieldTypeString",e[e.esriFieldTypeDate=5]="esriFieldTypeDate",e[e.esriFieldTypeOID=6]="esriFieldTypeOID",e[e.esriFieldTypeGeometry=7]="esriFieldTypeGeometry",e[e.esriFieldTypeBlob=8]="esriFieldTypeBlob",e[e.esriFieldTypeRaster=9]="esriFieldTypeRaster",e[e.esriFieldTypeGUID=10]="esriFieldTypeGUID",e[e.esriFieldTypeGlobalID=11]="esriFieldTypeGlobalID",e[e.esriFieldTypeXML=12]="esriFieldTypeXML",e[e.esriFieldTypeBigInteger=13]="esriFieldTypeBigInteger"}(xe||(xe={})),function(e){e[e.esriGeometryNull=0]="esriGeometryNull",e[e.esriGeometryPoint=1]="esriGeometryPoint",e[e.esriGeometryMultipoint=2]="esriGeometryMultipoint",e[e.esriGeometryPolyline=3]="esriGeometryPolyline",e[e.esriGeometryPolygon=4]="esriGeometryPolygon",e[e.esriGeometryEnvelope=5]="esriGeometryEnvelope",e[e.esriGeometryAny=6]="esriGeometryAny",e[e.esriGeometryMultiPatch=7]="esriGeometryMultiPatch"}(Ge||(Ge={})),function(e){e[e.esriMethodHintUNSPECIFIED=0]="esriMethodHintUNSPECIFIED",e[e.esriUUIDESRI=1]="esriUUIDESRI",e[e.esriUUIDRFC4122=2]="esriUUIDRFC4122"}(Be||(Be={})),function(e){e[e.esriTypeUNSPECIFIED=0]="esriTypeUNSPECIFIED",e[e.esriTypeEntity=1]="esriTypeEntity",e[e.esriTypeRelationship=2]="esriTypeRelationship",e[e.esriTypeBoth=4]="esriTypeBoth"}(He||(He={})),function(e){e[e.esriGraphPropertyUNSPECIFIED=0]="esriGraphPropertyUNSPECIFIED",e[e.esriGraphPropertyRegular=1]="esriGraphPropertyRegular",e[e.esriGraphPropertyDocumentName=2]="esriGraphPropertyDocumentName",e[e.esriGraphPropertyDocumentTitle=3]="esriGraphPropertyDocumentTitle",e[e.esriGraphPropertyDocumentUrl=4]="esriGraphPropertyDocumentUrl",e[e.esriGraphPropertyDocumentText=5]="esriGraphPropertyDocumentText",e[e.esriGraphPropertyDocumentKeywords=6]="esriGraphPropertyDocumentKeywords",e[e.esriGraphPropertyDocumentContentType=7]="esriGraphPropertyDocumentContentType",e[e.esriGraphPropertyDocumentMetadata=8]="esriGraphPropertyDocumentMetadata",e[e.esriGraphPropertyDocumentFileExtension=9]="esriGraphPropertyDocumentFileExtension"}(Je||(Je={})),function(e){e[e.esriIdentifierInfoTypeUNSPECIFIED=0]="esriIdentifierInfoTypeUNSPECIFIED",e[e.esriIdentifierInfoTypeDatabaseNative=1]="esriIdentifierInfoTypeDatabaseNative",e[e.esriIdentifierInfoTypeUniformProperty=2]="esriIdentifierInfoTypeUniformProperty"}(Ve||(Ve={}));function Lr(e){return e.deleteLater(),new zt({timestamp:e.timestamp,spatialReference:new Gt(e.spatial_reference),strict:e.strict,objectIdField:e.objectid_property,globalIdField:e.globalid_property,arcgisManaged:e.arcgis_managed,identifierInfo:{identifierMappingInfo:{identifierInfoType:Ve[e.identifier_info?.identifier_mapping_info?.identifier_info_type?.value],databaseNativeIdentifier:e.identifier_info?.identifier_mapping_info?.database_native_identifier,uniformPropertyIdentifier:{identifierPropertyName:e.identifier_info?.identifier_mapping_info?.uniform_property_identifier?.identifier_property_name}},identifierGenerationInfo:{uuidMethodHint:Be[e.identifier_info?.identifier_generation_info?.uuid_method_hint?.value]}},searchIndexes:Pr(e.search_indexes),entityTypes:Rr(e.entity_types),relationshipTypes:jr(e.relationship_types)})}function vr(e){return e.deleteLater(),new at(Jt(e))}function Dr(e){return e.deleteLater(),new Ot({name:e.name,unique:e.unique,ascending:e.ascending,description:e.description,fieldNames:Sr(e.fields)})}function Jt(e){return{name:e.name,alias:e.alias,role:De[e.role.value]?De[e.role.value]:null,strict:e.strict,properties:Nr(e.properties),fieldIndexes:$r(e.field_indexes)}}function xr(e){return e.deleteLater(),new Ft({alias:e.alias,name:e.name,fieldType:xe[e.field_type.value]?xe[e.field_type.value]:null,geometryType:Ge[e.geometry_type.value]?Ge[e.geometry_type.value]:null,hasM:e.has_m,hasZ:e.has_z,nullable:e.nullable,editable:e.editable,required:e.required,defaultVisibility:e.default_visibility,systemMaintained:e.system_maintained,role:Je[e.role.value],defaultValue:e.default_value})}function Gr(e){e.deleteLater();const t=Jt(e),r=[];for(let n=0;n<e.end_points.size();n++){const i=e.end_points.get(n);r.push({originEntityType:i.origin_entity_type,destinationEntityType:i.dest_entity_type})}return new ot(Object.assign({endPoints:r},t))}function Rr(e){const t=[];for(let r=0;r<e.size();r++)t.push(vr(e.get(r)));return t}function Sr(e){const t=[];for(let r=0;r<e.size();r++)t.push(e.get(r));return t}function Nr(e){const t=[];for(let r=0;r<e.size();r++)t.push(xr(e.get(r)));return t}function $r(e){const t=[];for(let r=0;r<e.size();r++)t.push(Dr(e.get(r)));return t}function jr(e){const t=[];for(let r=0;r<e.size();r++)t.push(Gr(e.get(r)));return t}function Pr(e){const t=[];for(let r=0;r<e.size();r++){const n=new Cr,i=e.get(0);n.name=i.name,n.supportedCategory=He[i.supported_category.value];const a=i.analyzers.size();for(let s=0;s<a;s++)n.analyzers.push({name:i.analyzers.get(s).name});for(let s=0;s<i.search_properties.keys().size();s++){const d=i.search_properties.keys().get(s),p=i.search_properties.get(d),h=[];for(let y=0;y<p.property_names.size();y++)h.push(p.property_names.get(y));n.searchProperties.set(d,{propertyNames:h})}t.push(n)}return t}let We=class extends pt{constructor(e){super(e)}};We=o([v("esri.rest.knowledgeGraph.ObjectValue")],We);const Or=We;let Ie=class extends J{constructor(e){super(e),this.path=null}};o([l({type:[pt],json:{write:!0}})],Ie.prototype,"path",void 0),Ie=o([v("esri.rest.knowledgeGraph.Path")],Ie);const Fr=Ie;var F;(function(e){e[e.ESRI_GEOMETRY_NULL=0]="ESRI_GEOMETRY_NULL",e[e.ESRI_GEOMETRY_POINT=1]="ESRI_GEOMETRY_POINT",e[e.ESRI_GEOMETRY_MULTIPOINT=2]="ESRI_GEOMETRY_MULTIPOINT",e[e.ESRI_GEOMETRY_POLYLINE=3]="ESRI_GEOMETRY_POLYLINE",e[e.ESRI_GEOMETRY_POLYGON=4]="ESRI_GEOMETRY_POLYGON",e[e.ESRI_GEOMETRY_ENVELOPE=5]="ESRI_GEOMETRY_ENVELOPE",e[e.ESRI_GEOMETRY_ANY=6]="ESRI_GEOMETRY_ANY",e[e.ESRI_GEOMETRY_MULTI_PATCH=7]="ESRI_GEOMETRY_MULTI_PATCH"})(F||(F={}));var Z,Et;(function(e){e[e.OBJECT=0]="OBJECT",e[e.ENTITY=1]="ENTITY",e[e.RELATIONSHIP=2]="RELATIONSHIP",e[e.PATH=3]="PATH",e[e.ARRAY=4]="ARRAY"})(Z||(Z={})),function(e){e[e.view=0]="view",e[e.edit=1]="edit"}(Et||(Et={}));function Ar(e){const t={},r=dt(e,t),n=e.lengths,i=e.coords,a=n[0];t.points=[];let s=0;for(let d=0;d<a;d++){const p=[];for(let h=0;h<r;h++)p[h]=i[s],s++;t.points.push(p)}return new Rt(t)}function zr(e){const t={};let r=2;dt(e,t);const n=e.coords;return t.x=n[0],t.y=n[1],e.has_z&&(t.z=n[r],r++),e.has_m&&(t.m=n[r]),new ye(t)}function Qr(e){return new ee(Vt(e))}function Ur(e){return new me(Vt(e))}function Vt(e){const t={},r=dt(e,t),n=e.lengths,i=e.coords;let a="";if(e.geometry_type.value===F.ESRI_GEOMETRY_POLYGON)a="rings";else{if(e.geometry_type.value!==F.ESRI_GEOMETRY_POLYLINE)throw new _("KnowledgeGraph:illegal-geometry-type","Illegal Geometry type for multipath conversion");a="paths"}t[a]=[];let s=0;return n.forEach(d=>{const p=[];for(let h=0;h<d;h++){const y=[];for(let I=0;I<r;I++)y[I]=i[s],s++;p.push(y)}t[a].push(p)}),t}function dt(e,t){let r=2;return e.has_z?(t.hasZ=e.has_z,r++):t.hasZ=!1,e.has_m?(t.hasM=e.has_m,r++):t.hasM=!1,r}const we=le.getLogger("esri.rest.knowledgeGraph.WasmToQueryResponseObjConstructors"),qr={decodedWasmObjToQueryResponseObj:(e,t)=>{if(e==null)return null;if(typeof e!="object"||"getDate"in e)return e;if("geometry_type"in e)switch(e.geometry_type.value){case null:return null;case F.ESRI_GEOMETRY_POINT:return zr(e);case F.ESRI_GEOMETRY_MULTIPOINT:return Ar(e);case F.ESRI_GEOMETRY_POLYLINE:return Qr(e);case F.ESRI_GEOMETRY_POLYGON:return Ur(e);case F.ESRI_GEOMETRY_ENVELOPE:case F.ESRI_GEOMETRY_MULTI_PATCH:return we.warnOnce("Envelope and Multipatch are not supported on knowledge entities, but one of those geometry types was detected. Result interpreted as null"),null;case F.ESRI_GEOMETRY_NULL:case F.ESRI_GEOMETRY_ANY:default:return we.warnOnce("Unknown or blank geometry type returned - Result interpreted as null"),null}else{if(!("object_value_type"in e))return we.warnOnce("A decoded value came back of a type that is not supported. Result interpreted as null"),null;switch(e.object_value_type.value){case Z.OBJECT:return Br(e,t);case Z.ENTITY:return Wt(e,t);case Z.RELATIONSHIP:return Kt(e,t);case Z.PATH:return Hr(e,t);case Z.ARRAY:return Yr(e,t);default:return we.warnOnce("Unknown graph object type detected!  Result interpreted as null"),null}}}};function Yr(e,t){const r=[],n=e.count();for(let i=0;i<n;i++){const a=e.get_value_at(i);r.push(ut(a,t))}return r}function ut(e,t){return qr.decodedWasmObjToQueryResponseObj(e,t)}function Wt(e,t){const r=e.type_name,n=ht(e,t),i=e.get_id();return new Bt(Object.assign({typeName:r,id:i},n))}function ht(e,t){const r={},n=e.key_count();for(let i=0;i<n;i++)r[e.get_key_at(i)]=ut(e.get_value_at(i),t);return{properties:r}}function Br(e,t){return new Or(ht(e,t))}function Hr(e,t){const r=e.entity_count(),n=e.relationship_count(),i=[];for(let a=0;a<r;a++)i.push(Wt(e.get_entity_at(a),t)),a<n&&i.push(Kt(e.get_relationship_at(a),t));return new Fr({path:i})}function Kt(e,t){const r=e.type_name,n=ht(e,t);return new Ht(Object.assign({typeName:r,id:e.get_id(),originId:e.get_origin_entity_id(),destinationId:e.get_destination_entity_id()},n))}let oe=class extends pe{constructor(e){super(e),this.hasError=null,this.error=null,this.editResults=[]}};o([l()],oe.prototype,"hasError",void 0),o([l()],oe.prototype,"error",void 0),o([l()],oe.prototype,"editResults",void 0),oe=o([v("esri.rest.knowledgeGraph.GraphApplyEdits")],oe);const Jr=oe;function Vr(e){const t=new Jr;t.hasError=e.has_error(),t.hasError&&(t.error={errorCode:e.error.error_code,errorMessage:e.error.error_message});const r=e.get_edit_results_count();for(let n=0;n<r;n++){const i=e.get_edit_results_at(n),a=e.get_edit_results_type_name_at(n),s=[],d=[],p=[],h=i.get_add_results_count(),y=i.get_update_results_count(),I=i.get_delete_results_count();for(let f=0;f<h;f++){const c=i.get_add_result_at(f);s.push({id:c.id,error:{errorCode:c.error.error_code,errorMessage:c.error.error_message}})}for(let f=0;f<y;f++){const c=i.get_update_result_at(f);d.push({id:c.id,error:{errorCode:c.error.error_code,errorMessage:c.error.error_message}})}for(let f=0;f<I;f++){const c=i.get_delete_result_at(f);p.push({id:c.id,error:{errorCode:c.error.error_code,errorMessage:c.error.error_message}})}t.editResults.push({typeName:a,adds:s,updates:d,deletes:p})}return t}const fe={fetchKnowledgeGraph:async e=>{const t=new wr({url:e}),r=[];return r.push(Re(t)),r.push(Kr(t)),await Promise.all(r),t},refreshDataModel:async e=>{e.dataModel=await Zt(e)},refreshServiceDefinition:async e=>{const t=(await ce(e.url,{query:{f:"json"}})).data;return t.capabilities=t?.capabilities?.split(","),t.supportedQueryFormats=t?.supportedQueryFormats?.split(","),e.serviceDefinition=new Qt(t),e.serviceDefinition},executeQueryStreaming:async(e,t,r)=>{const n=`${e.url}/graph/query`;await Oe(e);const i=await Fe(n,r);i.data.body=await en(t,e);const a=await Pe(i.data.url,i.data);if(e.dataModel)return new _t({resultRowsStream:await kt(a,e.dataModel)});throw new _("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")},executeApplyEdits:async(e,t,r)=>{if(e.serviceDefinition?.dataEditingNotSupported)throw new _("knowledge-graph:data-editing-not-supported","The Knowledge Graph Service definition indicated that data editing is not supported");const n=`${e.url}/graph/applyEdits`;await Oe(e);const i=await Fe(n,r);return i.data.body=await Xr(t,e),rn(await Pe(i.data.url,i.data))},executeQuery:async(e,t,r)=>{const n=`${e.url}/graph/query`,i=await ce(n,{responseType:"array-buffer",query:{f:"pbf",openCypherQuery:t.openCypherQuery,...r?.query},signal:r?.signal,timeout:r?.timeout}),a=i.getHeader?.("content-type"),s=i.data;if(a?.includes("application/x-protobuf")){const d=new(await H()).GraphQueryDecoder;if(d.deleteLater(),e.dataModel)return new wt({resultRows:Ke(d,s,e.dataModel)});throw new _("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}throw new _("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:a,data:i.data})},executeSearch:async(e,t,r)=>{const n=t.typeCategoryFilter,i=`${e.url}/graph/search`,a=await ce(i,{responseType:"array-buffer",query:{f:"pbf",searchQuery:`"${t.searchQuery}"`,typeCategoryFilter:n,...r?.query},signal:r?.signal,timeout:r?.timeout}),s=a.getHeader?.("content-type"),d=a.data;if(s?.includes("application/x-protobuf")){const p=new(await H()).GraphQueryDecoder;if(p.deleteLater(),e.dataModel)return new wt({resultRows:Ke(p,d,e.dataModel)});throw new _("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}throw new _("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:s,data:a.data})},executeSearchStreaming:async(e,t,r)=>{const n=`${e.url}/graph/search`;await Oe(e);const i=await Fe(n,r);i.data.body=await tn(t);const a=await Pe(i.data.url,i.data);if(e.dataModel)return new _t({resultRowsStream:await kt(a,e.dataModel)});throw new _("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")},_fetchWrapper:async(e,t)=>fetch(e,t)};async function je(e,t,r){return fe.executeQueryStreaming(e,t,r)}async function Wr(e){return fe.fetchKnowledgeGraph(e)}async function Re(e){return fe.refreshDataModel(e)}async function Kr(e){return fe.refreshServiceDefinition(e)}async function Pe(e,t){return fe._fetchWrapper(e,t)}async function Oe(e){rr?.findCredential(e.url)||(e.dataModel?await Zt(e):await Re(e))}function de(e,t,r){if(e.error_code!==0)throw new _(t,r,{errorCode:e.error_code,errorMessage:e.error_message})}function Zr(e,t,r,n){t==null?r.set_param_key_value(e,""):typeof t!="object"||t instanceof Date?r.set_param_key_value(e,t):t instanceof it?r.set_param_key_value(e,st(t,n)):t instanceof Array?r.set_param_key_value(e,Ut(t,n)):r.set_param_key_value(e,qt(t,n))}async function Xr(e,t){if(t.dataModel||await Re(t),!t.dataModel)throw new _("knowledge-graph:data-model-undefined","Encoding could not proceed because a data model was not provided and it could not be determined from the service");const r=await H(),n=!!e.options?.cascadeDelete,i=new r.GraphApplyEditsEncoder(r.SpatialReferenceUtil.WGS84(),e.options?.inputQuantizationParameters?Ir(e.options?.inputQuantizationParameters):r.InputQuantizationUtil.WGS84_lossless());i.deleteLater(),i.cascade_delete=n;try{let s;e.entityAdds?.forEach(d=>{s=i.add_entity(ge(d,r)),de(s,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an entity failed to be added to the encoder")}),e.relationshipAdds?.forEach(d=>{if(!d.originId||!d.destinationId)throw new _("knowledge-graph:relationship-origin-destination-missing","When adding a new relationship, you must provide both an origin and destination id on the appropriate class property");s=i.add_relationship(ge(d,r)),de(s,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - a relationship failed to be added to the encoder")}),e.entityUpdates?.forEach(d=>{if(!d.id)throw new _("knowledge-graph:entity-id-missing","When updating an entity or relationship, you must specify the id on the class level property");s=i.update_entity(ge(d,r)),de(s,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an entity failed to be added to the encoder")}),e.relationshipUpdates?.forEach(d=>{if(!d.id)throw new _("knowledge-graph:relationship-id-missing","When updating an entity or relationship, you must specify the id on the class level property");s=i.update_relationship(ge(d,r)),de(s,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - a relationship failed to be added to the encoder")}),e.entityDeletes?.forEach(d=>{if(!d.typeName)throw new _("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");const p=i.make_delete_helper(d.typeName,!0);p.deleteLater(),d.ids?.forEach(h=>{p.delete_by_id(h)})}),e.relationshipDeletes?.forEach(d=>{if(!d.typeName)throw new _("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");const p=i.make_delete_helper(d.typeName,!1);d.ids?.forEach(h=>{p.delete_by_id(h)})}),i.encode()}catch(s){throw new _("knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed",{error:s})}const a=i.get_encoding_result();return de(a.error,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed"),a.get_byte_buffer()}async function en(e,t){const r=await H(),n=new r.GraphQueryRequestEncoder;if(n.deleteLater(),n.output_spatial_reference=r.SpatialReferenceUtil.WGS84(),n.open_cypher_query=e.openCypherQuery,e.bindParameters)for(const[a,s]of Object.entries(e.bindParameters))Zr(a,s,n,r);if(e.bindGeometryQuantizationParameters)br(e.bindGeometryQuantizationParameters,n);else{if(t.dataModel||await Re(t),t.dataModel?.spatialReference?.wkid!==4326)throw new _("knowledge-graph:SR-quantization-mismatch","If the DataModel indicates a coordinate system other than WGS84, inputQuantizationParameters must be provided to the query encoder");n.input_quantization_parameters=r.InputQuantizationUtil.WGS84_lossless()}e.outputQuantizationParameters&&Tr(e.outputQuantizationParameters,n,r);try{n.encode()}catch(a){throw new _("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",{error:a})}const i=n.get_encoding_result();if(i.error.error_code!==0)throw new _("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",{errorCode:i.error.error_code,errorMessage:i.error.error_message});return i.get_byte_buffer()}async function tn(e){const t=await H(),r=new t.GraphSearchRequestEncoder;if(r.deleteLater(),r.search_query=e.searchQuery,r.type_category_filter=t.esriNamedTypeCategory[e.typeCategoryFilter],e.returnSearchContext===!0&&(r.return_search_context=e.returnSearchContext),e.start!=null&&e.start>0&&(r.start_index=e.start),e.num!=null&&(r.max_num_results=e.num),e.idsFilter!=null&&Array.isArray(e.idsFilter)&&e.idsFilter.length>0)try{r.set_ids_filter(Ut(e.idsFilter,t))}catch(i){throw new _("knowledge-graph:ids-format-error","Attempting to set ids filter failed.  This is usually caused by an incorrectly formatted UUID string",{error:i})}e.namedTypesFilter?.forEach(i=>{r.add_named_type_filter(i)});try{r.encode()}catch(i){throw new _("knowledge-graph:search-encoding-failed","Attempting to encode the search failed",{error:i})}const n=r.get_encoding_result();if(n.error.error_code!==0)throw new _("knowledge-graph:search-encoding-failed","Attempting to encode the search failed",{errorCode:n.error.error_code,errorMessage:n.error.error_message});return n.get_byte_buffer()}async function Fe(e,t){return ce(e,{responseType:"native-request-init",method:"post",query:{f:"pbf",...t?.query},body:"x",headers:{"Content-Type":"application/octet-stream"},signal:t?.signal,timeout:t?.timeout})}async function rn(e){const t=e.headers.get("content-type");if(t?.includes("application/x-protobuf")){const r=await e.arrayBuffer(),n=new(await H()).GraphApplyEditsDecoder;return n.deleteLater(),n.decode(new Uint8Array(r)),Vr(n)}throw new _("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:t,data:e.text()})}function Ke(e,t,r){e.push_buffer(new Uint8Array(t));const n=[];let i=0;for(;e.next_row();){i||(i=e.get_header_keys().size());const a=new Array(i);for(let s=0;s<i;s++){const d=e.get_value(s);a[s]=ut(d,r)}n.push(a)}if(e.has_error())throw new _("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:e.error.error_code,errorMessage:e.error.error_message});return n}async function kt(e,t){const r=e.headers.get("content-type");if(e.headers.get("content-length")&&le.getLogger("esri.rest.knowledgeGraph.knowledgeGraphService").warnOnce("Found `Content-Length` header when expecting a streaming HTTP response! Please investigate whether all intermediate HTTP proxies and/or load balancers are configured such that they don't forcefully buffer the entire response before returning it to the client. A valid HTTP streaming response should use Chunked Transfer Encoding and not have a Content Length defined."),r?.includes("application/x-protobuf")){const n=e.body?.getReader(),i=new(await H()).GraphQueryDecoder;return i.deleteLater(),new ReadableStream({async start(a){try{return s()}catch(d){n?.releaseLock(),a.error(new _("knowledge-graph:stream-decoding-error","The server returned a valid response, but there was an error decoding the response stream",{error:d})),a.close()}function s(){return n?.read().then(({done:d,value:p})=>{if(d){let y;if(i.has_error()&&(y=new _("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:i.error.error_code,errorMessage:i.error.error_message})),n.releaseLock(),y)throw a.error(y),y;return void a.close()}const h=Ke(i,p,t);return h.length>0&&a.enqueue(h),s()})}}})}throw new _("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:r,data:e.text()})}async function Zt(e){const t=`${e.url}/dataModel/queryDataModel`,r=await ce(t,{responseType:"array-buffer",query:{f:"pbf"}}),n=r.getHeader?.("content-type"),i=r.data;if(n?.includes("application/x-protobuf")){const a=(await H()).decode_data_model_from_protocol_buffer(new Uint8Array(i));if(!a)throw new _("knowledge-graph:data-model-decode-failure","The server responded to the data model query, but the response failed to be decoded.  This typically occurs when the Knowledge JS API (4.26 or later) is used with an unsupported backend (11.0 or earlier)");return Lr(a)}throw new _("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:n,data:r.data})}let Ce=class extends pe{constructor(e){super(e),this.openCypherQuery=""}};o([l()],Ce.prototype,"openCypherQuery",void 0),Ce=o([v("esri.rest.knowledgeGraph.GraphQuery")],Ce);const nn=Ce;let se=class extends nn{constructor(e){super(e),this.bindParameters=null,this.bindGeometryQuantizationParameters=null,this.outputQuantizationParameters=null}};o([l()],se.prototype,"bindParameters",void 0),o([l()],se.prototype,"bindGeometryQuantizationParameters",void 0),o([l()],se.prototype,"outputQuantizationParameters",void 0),se=o([v("esri.rest.knowledgeGraph.GraphQueryStreaming")],se);const _e=se,L="ESRI__ID",ue="ESRI__ORIGIN_ID",Ae="ESRI__DESTINATION_ID",R="ESRI__LAYOUT_GEOMETRY",X=12,Mt=le.getLogger("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager");let Y=class extends pe{constructor(e){super(e),this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this._processingCacheUpdatesLookup=new Map,this._memberIdTypeLookup=new Map;const t=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach(r=>{r.name&&(t.set(r.name,"entity"),this._processingCacheUpdatesLookup.set(r.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(r.name),r.properties?.forEach(n=>{n.geometryType&&n.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(r.name,{name:n.name??"",geometryType:n.geometryType})}))}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(r=>{r.name&&(t.set(r.name,"relationship"),this._processingCacheUpdatesLookup.set(r.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(r.name),r.properties?.forEach(n=>{n.geometryType&&n.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(r.name,{name:n.name??"",geometryType:n.geometryType})}))}),e.inclusionModeDefinition?.namedTypeDefinitions.forEach((r,n)=>{if(t.get(n)==="entity")this.entityTypeNames.add(n);else{if(t.get(n)!=="relationship")return Mt.warn(`A named type, ${n}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(n);this.relationshipTypeNames.add(n)}const i=new Map;r.members?.forEach(a=>{this._memberIdTypeLookup.set(a.id,n);const s=this.getById(a.id);s&&i.set(a.id,s)}),this.sublayerCaches.set(n,i)})}addToLayerInclusionSet(e){e.forEach(({typeName:t,id:r})=>{if(!this.inclusionModeDefinition)throw new _("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){const n=this.inclusionModeDefinition.namedTypeDefinitions.get(t);if(n.useAllData)throw new _("knowledge-graph:layer-data-manager","You cannot add members to an exclusion list for a sublayer where the sublayer is set to always retrieve its entire data set");n.members||(n.members=new Map),n.members.set(r,{id:r}),this._memberIdTypeLookup.set(r,t)}}else{const n=new Map;n.set(r,{id:r}),this.inclusionModeDefinition.namedTypeDefinitions.set(t,{useAllData:!1,members:n}),this._memberIdTypeLookup.set(r,t)}})}getById(e){return Q.getInstance().readFromStoreById(e)}async getData(e,t,r){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let n;if(n=e||new ne({where:"1=1",outFields:["*"]}),t.parentCompositeLayer.type==="link-chart"){const i=t.parentCompositeLayer,a=this._processingCacheUpdatesLookup.get(t.objectType.name??""),s=n.outFields,d=n.geometry;let p="",h="";d&&d.extent&&(p=K(d.extent.ymin,d.extent.xmin,X),h=K(d.extent.ymax,d.extent.xmax,X)),s&&s.length===1&&s[0]===L&&n.where==="1=1"||await Promise.all(a??[]);const y=this.sublayerCaches.has(t.objectType.name??"")?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],I=[];return y.forEach(f=>{if(f.geometry=i.linkChartDiagramLookup.get(f.attributes[t.objectIdField]),f.attributes[R]=f.geometry,p&&h){const c=i.linkChartGeohashLookup.get(f.attributes[t.objectIdField]);c?c>=p&&c<=h&&I.push(f):I.push(f)}else I.push(f)}),I}return this.retrieveDataFromService(n,t,r)}async getConnectedRecordIds(e){const t=[],r=[],n=new Map;return e.forEach(i=>{if(this._memberIdTypeLookup.has(i)){const a=this._memberIdTypeLookup.get(i);if(!this.entityTypeNames.has(a))return;n.has(a)?n.get(a)?.push(i):n.set(a,[i])}}),n.forEach((i,a)=>{const s=`MATCH (n:${a})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`,d=new Promise(p=>{(async()=>{const h=(await je(this.knowledgeGraph,new _e({openCypherQuery:s,bindParameters:{ids:i}}))).resultRowsStream.getReader();try{for(;;){const{done:y,value:I}=await h.read();if(y)break;for(let f=0;f<I.length;f++){const c=I[f];t.push({id:c[0],typeName:c[1]}),t.push({id:c[2],typeName:c[3]})}}}catch(y){if(y.name!=="AbortError")throw y;Mt.info("Request aborted as expected")}})().then(()=>{p()})});r.push(d)}),await Promise.all(r),t}async refreshCacheContent(e,t,r,n=!0){const i=Q.getInstance(),a=[],s=new Map,d=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach(p=>{p.name&&d.set(p.name,p)}),this.knowledgeGraph.dataModel.relationshipTypes?.forEach(p=>{p.name&&d.set(p.name,p)}),e||this.inclusionModeDefinition?e?e.forEach(p=>{if(this._memberIdTypeLookup.has(p)){const h=this._memberIdTypeLookup.get(p);s.has(h)?s.get(h)?.push(p):s.set(h,[p])}}):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach((p,h)=>{p.useAllData?s.set(h,null):p.members&&p.members.forEach(y=>{s.has(h)&&s.get(h)!==null?s.get(h)?.push(y.id):s.set(h,[y.id])})}):(this.knowledgeGraph.dataModel.entityTypes?.forEach(p=>{p.name&&s.set(p.name,null)}),this.knowledgeGraph.dataModel.entityTypes?.forEach(p=>{p.name&&s.set(p.name,null)}));for(const[p,h]of s){const y=new Promise(I=>{(async()=>{const c=new Set,E=[];let m,C="",T=!1;if(t||d.get(p)?.properties?.forEach(k=>{k.name&&c.add(k.name)}),r&&this.geographicLookup.has(p)){const k=this.geographicLookup.get(p)?.name;k&&c.add(k)}if(this.entityTypeNames.has(p))C=`MATCH (n:${p}) ${h?"WHERE id(n) IN $ids ":""}return ID(n)`,c.forEach(k=>{C+=`, n.${k}`,E.push(k)});else{if(!this.relationshipTypeNames.has(p))throw new _("knowledge-graph:layer-data-manager",`The graph type of ${p} could not be determined. Was this type set in the KG data model and inclusion definition?`);T=!0,C=`MATCH ()-[n:${p}]->() ${h?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,c.forEach(k=>{C+=`, n.${k}`,E.push(k)})}m=new _e(h?{openCypherQuery:C,bindParameters:{ids:h}}:{openCypherQuery:C});const D=(await je(this.knowledgeGraph,m)).resultRowsStream.getReader();for(;;){const{done:k,value:g}=await D.read();if(k)break;const N=[];for(let w=0;w<g.length;w++){const b=g[w];let S=0,U=0;const A={properties:{}};for(A.id=b[S],S++,U++,T&&(A.originId=b[S],S++,U++,A.destinationId=b[S],S++,U++);S<b.length;S++)A.properties[E[S-U]]=b[S];N.push(A)}const M=i.writeToStore(N,L,this.geographicLookup.get(p)?.name);this.sublayerCaches.has(p)||this.sublayerCaches.set(p,new Map),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(p)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(p,{useAllData:!1,members:new Map}),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(p).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(p).members=new Map);const u=this.sublayerCaches.get(p);M.forEach(w=>{u?.set(w.attributes[L],w),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(p).members.has(w.attributes[L])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(p).members.set(w.attributes[L],{id:w.attributes[L]}),this._memberIdTypeLookup.set(w.attributes[L],p))})}})().then(()=>{I(null)})});a.push(y),this._processingCacheUpdatesLookup.get(p)?.push(y)}await Promise.all(a)}removeFromLayer(e){const t=new Set;e.forEach(r=>{this._memberIdTypeLookup.get(r)&&t.add(this._memberIdTypeLookup.get(r)),this._memberIdTypeLookup.delete(r),this.inclusionModeDefinition?.namedTypeDefinitions.forEach(n=>{n.members?.has(r)&&n.members.delete(r)})}),t.forEach(r=>{this.sublayerCaches.get(r)?.forEach((n,i)=>{e.includes(i)&&this.sublayerCaches.get(r)?.delete(i)})})}async retrieveDataFromService(e,t,r){const n=Q.getInstance(),i=new Set,a=[];let s,d="",p=[];const h=t.graphType==="relationship",y=this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData,I=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let f=!y&&I?Array.from(I).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData&&e.objectIds!=null&&(f=e.objectIds);else if(e.objectIds!=null&&f&&f.length>0){const E=e.objectIds;e.objectIds=f.filter(m=>E.includes(m))}else if(e.objectIds!=null)f=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(t.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=f}if(e.outFields!=null){const E=e.outFields;E.includes("*")?t.fields.forEach(m=>{i.add(m.name)}):E.forEach(m=>{m!==L&&m!==t.geometryFieldName&&i.add(m)})}if(e.geometry!=null){const E=e.geometry;let m;if(E?.extent?.spatialReference&&!E.spatialReference?.isWGS84?(await St(E.extent.spatialReference,Le),m=Nt(E.extent,Le)):m=E.extent,e.where!=null&&e.where!=="1=1"){const C=await gt(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach(T=>{C.fieldNames.includes(T.name)&&i.add(T.name)})}d=h?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&i.add(t.geometryFieldName),i.forEach(C=>{d+=`, n.${C}`,a.push(C)}),s=new _e({openCypherQuery:d,bindParameters:{param_filter_geom:new me({rings:[[[m.xmin,m.ymin],[m.xmin,m.ymax],[m.xmax,m.ymax],[m.xmax,m.ymin],[m.xmin,m.ymin]]]})}})}else{let E="";if(e.where!=null&&e.where!=="1=1"){const T=await gt(e.where,t.fieldsIndex);t.fields.forEach(M=>{T.fieldNames.includes(M.name)&&i.add(M.name)});const D=["column-reference","string","number","binary-expression"],k=["=","<","<=","<>",">",">=","AND","OR","LIKE"];let g=!1;const N=M=>{if(M.type==="column-reference")return`n.${M.column}`;if(M.type==="string")return`'${M.value}'`;if(M.type==="number")return`${M.value}`;if(M.type==="binary-expression"&&D.includes(M.left.type)&&D.includes(M.right.type)&&k.includes(M.operator))return`${N(M.left)} ${M.operator} ${N(M.right)}`;if(M.type==="binary-expression"&&M.operator==="LIKE"){let u="";if(M.left.type==="function"&&M.left.args.value[0].type==="column-reference")u+=`lower(n.${M.left.args.value[0].column})`;else{if(M.left.type!=="column-reference")return g=!0,"";u+=`lower(n.${M.left.column})`}if(u+=" CONTAINS (",M.right.type!=="string")return g=!0,"";{let w=M.right.value;w.charAt(0)==="%"&&(w=w.slice(1)),w.charAt(w.length-1)==="%"&&(w=w.slice(0,-1)),u+=`'${w.toLowerCase()}')`}return u}return g=!0,""};E=N(T.parseTree),g&&(E="")}let m="";m=h?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let C=!1;f&&(C=!0,m+=" WHERE ID(n) IN $ids"),E&&(m+=C?" AND":" WHERE",m+=` ${E}`),m+=" return ID(n)",h&&(m+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&i.add(t.geometryFieldName),i.forEach(T=>{m+=`, n.${T}`,a.push(T)}),s=new _e(f?{openCypherQuery:m,bindParameters:{ids:f}}:{openCypherQuery:m})}const c=(await je(t.parentCompositeLayer.dataManager.knowledgeGraph,s,r)).resultRowsStream.getReader();for(;;){const{done:E,value:m}=await c.read();if(E)break;const C=[];for(let T=0;T<m.length;T++){const D=m[T];let k=0,g=0;const N={properties:{}};for(N.id=D[k],k++,g++,h&&(N.originId=D[k],k++,g++,N.destinationId=D[k],k++,g++);k<D.length;k++)N.properties[a[k-g]]=D[k];C.push(N)}p=p.concat(n.writeToStore(C,L,t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name)?.name))}return p}};o([l()],Y.prototype,"knowledgeGraph",void 0),o([l()],Y.prototype,"inclusionModeDefinition",void 0),o([l()],Y.prototype,"entityTypeNames",void 0),o([l()],Y.prototype,"relationshipTypeNames",void 0),o([l()],Y.prototype,"geographicLookup",void 0),o([l()],Y.prototype,"sublayerCaches",void 0),Y=o([v("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],Y);const It=hr(),an=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return o([l(It.fields)],t.prototype,"fields",void 0),o([l(It.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=o([v("esri.layers.knowledgeGraphLayer.KnowledgeGraphSublayerBase")],t),t};let x=class extends cr(an(jt(Pt(nr($t))))){constructor(e){if(super(e),this.capabilities=ur(!1,!1),this.definitionExpression="",this.displayField="",this.elevationInfo=null,this.geometryType=null,this.geometryFieldName=null,this.graphType=null,this.hasM=!1,this.hasZ=!1,this.labelsVisible=null,this.labelingInfo=null,this.objectIdField=L,this.objectType=null,this.parentCompositeLayer=null,this.popupTemplate=null,this.source={openPorts:()=>this.load().then(()=>{const t=new MessageChannel;return new ir(t.port1,{channel:t,client:{queryFeatures:(r,n={})=>{const i=ne.fromJSON(r);return this.queryFeaturesJSON(i,n)}}},()=>null),[t.port2]})},this.type="knowledge-graph-sublayer",e.parentCompositeLayer.type==="link-chart")e.graphType==="relationship"?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=R;else if(e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType&&e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType!=="esriGeometryNull"){const t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=t?.name??null,this.geometryType=t?.geometryType?te.fromJSON(t.geometryType):null;const r=t?.name,n=r?e.objectType.properties?.[r]:null;n?(this.hasM=n.hasM??!1,this.hasZ=n.hasZ??!1):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;e.objectType.properties?.forEach(t=>{let r=null,n=t.fieldType;n==="esriFieldTypeOID"&&(n="esriFieldTypeInteger"),this.fields.push(yt.fromJSON({name:t.name,type:n,alias:t.alias,defaultValue:r,editable:t.editable,nullable:t.nullable}))}),this.fields.push(yt.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),this._set("fields",[...this.fields]),e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel?.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),e.parentCompositeLayer.type==="link-chart"?e.graphType==="relationship"?this.renderer=Se(Ne(te.toJSON("polyline")).renderer):this.renderer=Se(Ne(te.toJSON("point")).renderer):this.renderer=Se(Ne(te.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){ar(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return mr(this,e)}createQuery(){return new ne({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];throw new Error("Field not found")}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:r,queryEngine:n}=await this._setupQueryObjects(e),i=yr.fromJSON(await n.executeQuery(r.toJSON(),t?.signal));return i.features.forEach(a=>{a.sourceLayer=this}),i}async queryFeaturesJSON(e,t){const{resolvedQuery:r,queryEngine:n}=await this._setupQueryObjects(e);return await n.executeQuery(r.toJSON(),t?.signal)}async queryFeatureCount(e,t){const{resolvedQuery:r,queryEngine:n}=await this._setupQueryObjects(e);return n.executeQueryForCount(r.toJSON(),t?.signal)}async queryExtent(e={},t){const r={...e,returnGeometry:!0},{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(r),a=await i.executeQueryForExtent(n.toJSON(),t?.signal);let s;return s=a.extent?.xmin!=null&&a.extent?.xmax!=null&&a.extent?.ymin!=null&&a.extent?.ymax!=null?new ve(a.extent):new ve,{count:a.count,extent:s}}async queryObjectIds(e,t){const r=ne.from(e);let n;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)n=this._cachedQueryEngine;else{const i=await this.parentCompositeLayer.dataManager.getData(r,this,t);n=this.loadQueryEngine(i)}return n.executeQueryForIds(r.toJSON(),t?.signal)}loadQueryEngine(e){const t=new pr({geometryType:te.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),r=new dr({fields:this.fields.map(n=>n.toJSON()),geometryType:te.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return r.featureStore.addMany(e),r}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new ne({where:"1=1",outFields:[L]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,t){const r=ne.from(e),n=r.geometry;let i;if(n&&!n.spatialReference?.isWGS84&&(await St(n.spatialReference,Le),r.geometry=Nt(n instanceof me||n instanceof ee?n:n.extent,Le)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const a=await this.parentCompositeLayer.dataManager.getData(r,this,t);i=this.loadQueryEngine(a)}return{resolvedQuery:r,queryEngine:i}}};o([l()],x.prototype,"capabilities",void 0),o([l({readOnly:!0})],x.prototype,"defaultPopupTemplate",null),o([l()],x.prototype,"definitionExpression",void 0),o([l()],x.prototype,"displayField",void 0),o([l()],x.prototype,"elevationInfo",void 0),o([l()],x.prototype,"geometryType",void 0),o([l()],x.prototype,"geometryFieldName",void 0),o([l()],x.prototype,"graphType",void 0),o([l()],x.prototype,"hasM",void 0),o([l()],x.prototype,"hasZ",void 0),o([l()],x.prototype,"labelsVisible",void 0),o([l()],x.prototype,"labelingInfo",void 0),o([l()],x.prototype,"objectIdField",void 0),o([l()],x.prototype,"objectType",void 0),o([l()],x.prototype,"parentCompositeLayer",void 0),o([l({type:or,json:{name:"popupInfo",write:!0}})],x.prototype,"popupTemplate",void 0),o([l({types:lr,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],x.prototype,"renderer",null),o([l()],x.prototype,"source",void 0),o([l({json:{read:!1}})],x.prototype,"type",void 0),x=o([v("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],x);const ze=x;let Qe,P=null;function on(){return Qe||(Qe=Ue(()=>import("./lclayout.4d27801f.js"),["assets/lclayout.4d27801f.js","assets/index.da161cf1.js","assets/index.8db76e31.css"]).then(e=>e.l).then(({default:e})=>e({locateFile:t=>qe(`esri/libs/linkchartlayout/${t}`)})).then(e=>{sn(e)}),Qe)}function sn(e){P=e}var z;function re(e,t,r,n,i,a){const s=r.length,d=i.length,p=Float64Array.BYTES_PER_ELEMENT,h=Uint32Array.BYTES_PER_ELEMENT,y=Uint8Array.BYTES_PER_ELEMENT,I=16,f=I-1+s*(y+2*p)+d*(2*h),c=P._malloc(f);try{const E=c+I-c%I,m=E+s*p,C=m+s*p,T=C+d*h,D=T+d*h,k=()=>[P.HEAPF64.subarray(E>>3,(E>>3)+s),P.HEAPF64.subarray(m>>3,(m>>3)+s),P.HEAPU32.subarray(C>>2,(C>>2)+d),P.HEAPU32.subarray(T>>2,(T>>2)+d),P.HEAPU8.subarray(D,D+s)],[g,N,M,u,w]=k();g.set(r),N.set(n),M.set(i),u.set(a),w.set(t);const b=e(s,D,E,m,d,C,T),[S,U,A,Xt,er]=k();return r.set(S),n.set(U),i.set(A),a.set(Xt),t.set(er),b}finally{P._free(c)}}(function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot"})(z||(z={}));const Ct=2,Lt=1,vt=-1;var Ze,Xe,et,tt,rt,nt,Dt,xt;(function(e){function t(){return P.getMinIdealEdgeLength()}function r(n,i,a,s,d,p=Ct,h=Lt,y=vt){return re((I,f,c,E,m,C,T)=>P.applyForceDirectedLayout(I,f,c,E,m,C,T,p,h,y),n,i,a,s,d)}e.getMinIdealEdgeLength=t,e.apply=r})(Ze||(Ze={})),function(e){function t(r,n,i,a,s,d=Ct,p=Lt,h=vt){return re((y,I,f,c,E,m,C)=>P.applyCommunityLayout(y,I,f,c,E,m,C,d,p,h),r,n,i,a,s)}e.apply=t}(Xe||(Xe={})),function(e){function t(r,n,i,a,s){return re(P.applySimpleLayout,r,n,i,a,s)}e.apply=t}(et||(et={})),function(e){function t(r,n,i,a,s){return re(P.applyHierarchicalLayout,r,n,i,a,s)}e.apply=t}(tt||(tt={})),function(e){function t(r,n,i,a,s){return re(P.applyRadialTreeLayout,r,n,i,a,s)}e.apply=t}(rt||(rt={})),function(e){function t(r,n,i,a,s){return re(P.applySmartTreeLayout,r,n,i,a,s)}e.apply=t}(nt||(nt={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(Dt||(Dt={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(xt||(xt={}));const ln=(e,t,r)=>(e.has(t)||e.set(t,r()),e.get(t));let j=class extends jt(Pt($t)){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE",xScaleFactor:1,yScaleFactor:1},this._graphTypeLookup=new Map,this.layers=new mt,this.linkChartDiagramLookup=new Map,this.linkChartExtent=new ve({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.linkChartGeohashLookup=new Map,this.sublayerIdsCache=new Map,this.tables=new mt,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new _("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){if(!this.title&&this.url){const a=this.url.split("/");this.title=a[a.length-2]}const t=new Set;let r=[],n=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new _("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&this._graphTypeLookup.set(a.name,a)}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(a=>{a.name&&this._graphTypeLookup.set(a.name,a)}),e.inclusionModeDefinition?.generateAllSublayers?(r=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach((a,s)=>{if(!this._graphTypeLookup.get(s))return le.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(s);this._graphTypeLookup.get(s)instanceof ot||"strictOrigin"in this._graphTypeLookup.get(s)?t.has(s)||(t.add(s),n.push(this._graphTypeLookup.get(s))):this._graphTypeLookup.get(s)instanceof at||"properties"in this._graphTypeLookup.get(s)?t.has(s)||(t.add(s),r.push(this._graphTypeLookup.get(s))):(le.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(s))}):(r=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]);const i=new Y({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=r,this.memberRelationshipTypes=n,this.dataManager=i}load(e){return this.addResolvingPromise(new Promise(t=>{Wr(this.url).then(r=>{if(this._initializeLayerProperties({knowledgeGraph:r,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach(n=>{n.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(n.name,{useAllData:!0})}),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach(n=>{n.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(n.name,{useAllData:!0})})),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(n=>{n.useAllData=!1,n.members?.forEach(i=>{let a;a=i.linkChartLocation instanceof ft?i.linkChartLocation:i.linkChartLocation?V(i.linkChartLocation):null,this.linkChartDiagramLookup.set(i.id,a),a&&a.coords.length===2&&a.lengths.length===0?this.linkChartGeohashLookup.set(i.id,K(a.coords[1],a.coords[0],X)):this.linkChartGeohashLookup.set(i.id,"")}),this.addResolvingPromise(this._initializeDiagram().then(async()=>{this.layers.forEach(async i=>{await i.refreshCachedQueryEngine()}),this.tables.forEach(async i=>{await i.refreshCachedQueryEngine()})}))});else{const n=this.defaultLinkChartConfig?.layoutMode==="GEOGRAPHIC";this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,n,!0).then(async()=>{sr(e);const i=[],a=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach(s=>{s.useAllData=!1})),await this._initializeDiagram(),this.layers.forEach(s=>{a.push(s.refreshCachedQueryEngine()),i.push(new Promise(d=>{s.on("layerview-create",()=>{d(null)})}))}),this.tables.forEach(s=>{a.push(s.refreshCachedQueryEngine())}),await Promise.all(a)}))}t(null)})})),Promise.resolve(this)}async addRecords(e){await this._handleNewRecords(e)}async expand(e){const t=await this.dataManager.getConnectedRecordIds(e),r=t.filter(n=>!this.sublayerIdsCache.get(n.typeName)?.has(n.id));return await this._handleNewRecords(t),{records:r}}loadLayerAssumingLocalCache(){this.memberRelationshipTypes.forEach(e=>{const t=new ze({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)}),this.memberEntityTypes.forEach(e=>{const t=new ze({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((e,t)=>{const r=ln(this.sublayerIdsCache,t,()=>new Set);e.members?.forEach(n=>{if(r.add(n.id),n.linkChartLocation)if(n.linkChartLocation instanceof ft)this.linkChartDiagramLookup.set(n.id,n.linkChartLocation),n.linkChartLocation.coords.length===2&&n.linkChartLocation.lengths.length===0?this.linkChartGeohashLookup.set(n.id,K(n.linkChartLocation.coords[1],n.linkChartLocation.coords[0],X)):this.linkChartGeohashLookup.set(n.id,"");else{const i=V(n.linkChartLocation);this.linkChartDiagramLookup.set(n.id,n.linkChartLocation?i:null),"x"in n.linkChartLocation&&"y"in n.linkChartLocation?this.linkChartGeohashLookup.set(n.id,K(n.linkChartLocation.x,n.linkChartLocation.y,X)):this.linkChartGeohashLookup.set(n.id,"")}})})}async calculateLinkChartLayout(e="RADIAL_TREE",t){const r=[],n=[];this.dataManager.sublayerCaches.forEach((u,w)=>{this.dataManager.entityTypeNames.has(w)?u.forEach(b=>{r.push({typeName:w,feature:b})}):this.dataManager.relationshipTypeNames.has(w)&&u.forEach(b=>{n.push({typeName:w,feature:b})})}),this.linkChartDiagramLookup=new Map;const i=new Map,a=new Map,s=new Map,d=new Map,p=new Uint8Array(r.length),h=new Float64Array(r.length),y=new Float64Array(r.length),I=new Uint32Array(n.length),f=new Uint32Array(n.length),c=[],E="FORCE_DIRECTED",m=t?.xScaleFactor??1,C=t?.yScaleFactor??1,T=new ve({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let D,k="FORCE_DIRECTED",g=0,N=0;switch(k=e==="GEOGRAPHIC"?E:e,k){case"FORCE_DIRECTED":D=Ze.apply;break;case"COMMUNITY":D=Xe.apply;break;case"HIERARCHICAL":D=tt.apply;break;case"RADIAL_TREE":D=rt.apply;break;case"SMART_TREE":D=nt.apply;break;default:D=et.apply}r.forEach(({typeName:u,feature:w})=>{if(t?.lockedNodeLocations?.has(w.attributes[L])){e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(u)?p[g]=z.IsGeographic:p[g]=z.None;const b=t.lockedNodeLocations.get(w.attributes[L]);h[g]=b.x,y[g]=b.y}else if(e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(u)){p[g]=z.IsGeographic;let b=null;const S=w.attributes[this.dataManager.geographicLookup.get(u).name];switch(this.dataManager.geographicLookup.get(u)?.geometryType){case"esriGeometryPoint":h[g]=S?.x,y[g]=S?.y;break;case"esriGeometryPolygon":b=S?.centroid,b?.x!=null&&b?.y!=null?(h[g]=b.x,y[g]=b.y):p[g]=z.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":b=S?.extent?.center,b?.x!=null&&b?.y!=null?(h[g]=b.x,y[g]=b.y):p[g]=z.IsMovable;break;default:p[g]=z.IsMovable}(h[g]==null||y[g]==null||Number.isNaN(h[g])||Number.isNaN(y[g]))&&(p[g]=z.IsMovable,h[g]=0,y[g]=0)}else p[g]=z.IsMovable,h[g]=0,y[g]=0;d.set(w.attributes[L],g),c[g]={feature:w,typeName:u},g++});let M=!1;if(n.forEach(u=>{const w=d.get(u.feature.attributes[ue]),b=d.get(u.feature.attributes[Ae]);w!==void 0&&b!==void 0?(I[N]=w,f[N]=b,N++):(M=!0,this.linkChartDiagramLookup.set(u.feature.attributes[ue],null),this.linkChartGeohashLookup.set(u.feature.attributes[ue],null))}),M&&le.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null"),await on(),!D(p,h,y,I,f))throw new _("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let u=0;u<c.length;u++){if(p[u]===z.IsMovable&&(h[u]=h[u]*m,y[u]=y[u]*C),y[u]>84.9999&&(y[u]=84.9999),y[u]<-84.9999&&(y[u]=-84.9999),h[u]>179.9999&&(h[u]=179.9999),h[u]<-179.9999&&(h[u]=-179.9999),c[u].feature.attributes[R]=new ye(h[u],y[u]),i.has(c[u].typeName))i.get(c[u].typeName)?.set(c[u].feature.attributes[L],c[u].feature);else{const b=new Map;b.set(c[u].feature.attributes[L],c[u].feature),i.set(c[u].typeName,b)}s.set(c[u].feature.attributes[L],c[u].feature);const w=V(c[u].feature.attributes[R]);this.linkChartDiagramLookup.set(c[u].feature.attributes[L],c[u].feature.attributes[R]?w:null),this.linkChartGeohashLookup.set(c[u].feature.attributes[L],K(c[u].feature.attributes[R].y,c[u].feature.attributes[R].x,X)),c[u].feature.attributes[R].x<T.xmin&&(T.xmin=c[u].feature.attributes[R].x),c[u].feature.attributes[R].x>T.xmax&&(T.xmax=c[u].feature.attributes[R].x),c[u].feature.attributes[R].y<T.ymin&&(T.ymin=c[u].feature.attributes[R].y),c[u].feature.attributes[R].y>T.ymax&&(T.ymax=c[u].feature.attributes[R].y)}return this.linkChartExtent.xmin=T.xmin,this.linkChartExtent.xmax=T.xmax,this.linkChartExtent.ymin=T.ymin,this.linkChartExtent.ymax=T.ymax,n.forEach(u=>{const w=c[d.get(u.feature.attributes[ue])]?.feature.attributes[R],b=c[d.get(u.feature.attributes[Ae])]?.feature.attributes[R];if(!w||!b)return;const S=new ee({paths:[[w.x,w.y],[b.x,b.y]]});if(u.feature.attributes[R]=S,a.has(u.typeName))a.get(u.typeName)?.set(u.feature.attributes[L],u.feature);else{const A=new Map;A.set(u.feature.attributes[L],u.feature),a.set(u.typeName,A)}s.set(u.feature.attributes[L],u.feature);const U=V(u.feature.attributes[R]);this.linkChartDiagramLookup.set(u.feature.attributes[L],u.feature.attributes[R]?U:null),this.linkChartGeohashLookup.set(u.feature.attributes[L],"")}),this._currentLinkChartConfig={layoutMode:e,xScaleFactor:m,yScaleFactor:C},{nodes:i,links:a,idMap:s}}async applyNewLinkChartLayout(e="RADIAL_TREE",t){const r=[];await this.calculateLinkChartLayout(e,t),this.layers.forEach(n=>{r.push(n.refreshCachedQueryEngine())}),await Promise.all(r),this.layers.forEach(n=>{n.emit("refresh",{dataChanged:!0})})}getCurrentNodeLocations(){const e=new Map;return this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach(t=>{t?.members?.forEach(r=>{const n=r.linkChartLocation;let i;const a=r.id;n&&(i="x"in n?{x:n.x,y:n.y}:{x:n.coords[0],y:n.coords[1]},e.set(a,new ye({x:i.x,y:i.y})))})}),e}async synchronizeInclusionListWithCache(){return new Promise(e=>{this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((t,r)=>{if(t.useAllData=!1,t.members&&t.members.size>0){if(!this.dataManager.sublayerCaches.get(r))return;const n=Array.from(this.dataManager.sublayerCaches.get(r).keys());Array.from(t.members.keys()).filter(i=>!n.includes(i)).forEach(i=>{t.members?.delete(i)})}}),e()})}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const t=[];this.layers.forEach(r=>{t.push(r.refreshCachedQueryEngine())}),await Promise.all(t),this.layers.forEach(r=>{r.emit("refresh",{dataChanged:!0})})}async _handleNewRecords(e){const t=[];this.dataManager.addToLayerInclusionSet(e);for(const r of e)this.sublayerIdsCache.has(r.typeName)||(this.sublayerIdsCache.set(r.typeName,new Set),t.push(r.typeName)),this.sublayerIdsCache.get(r.typeName).add(r.id);for(const r of t)if(this._graphTypeLookup.has(r)){const n=this._graphTypeLookup.get(r),i="endPoints"in n?"relationship":"entity",a=new ze({objectType:n,parentCompositeLayer:this,graphType:i,title:r});i==="entity"?this.dataManager.entityTypeNames.add(r):this.dataManager.relationshipTypeNames.add(r),a.geometryType?this.layers.push(a):this.tables.push(a),this.dataManager.sublayerCaches.set(r,new Map)}await this.dataManager.refreshCacheContent(e.map(r=>r.id)),await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,{xScaleFactor:this._currentLinkChartConfig.xScaleFactor,yScaleFactor:this._currentLinkChartConfig.xScaleFactor})}async _initializeDiagram(){this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach(e=>{e?.members?.forEach(t=>{const r=t.linkChartLocation;let n;const i=t.id;if(!r)return;n="x"in r?{x:r.x,y:r.y}:{x:r.coords[0],y:r.coords[1]};const a=V(n);this.linkChartDiagramLookup.set(i,a),this.linkChartGeohashLookup.set(i,K(n.x,n.y,X)),this.linkChartExtent.xmin>n.x&&(this.linkChartExtent.xmin=n.x),this.linkChartExtent.xmax<n.x&&(this.linkChartExtent.xmax=n.x),this.linkChartExtent.ymin>n.y&&(this.linkChartExtent.ymin=n.y),this.linkChartExtent.ymax<n.y&&(this.linkChartExtent.ymax=n.y)})}),this.memberRelationshipTypes.forEach(e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach(t=>{const r=this.linkChartDiagramLookup.get(t.attributes[ue]),n=this.linkChartDiagramLookup.get(t.attributes[Ae]);if(r&&n){const i=V(new ee({paths:[[r.coords[0],r.coords[1]],[n.coords[0],n.coords[1]]]}));this.linkChartDiagramLookup.set(t.attributes[L],i)}else this.linkChartDiagramLookup.set(t.attributes[L],null);this.linkChartGeohashLookup.set(t.attributes[L],"")})})):await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{xScaleFactor:this.defaultLinkChartConfig.xScaleFactor,yScaleFactor:this.defaultLinkChartConfig.yScaleFactor,lockedNodeLocations:this.getCurrentNodeLocations()}):await this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})}};o([l()],j.prototype,"dataPreloadedInLocalCache",void 0),o([l()],j.prototype,"defaultLinkChartConfig",void 0),o([l()],j.prototype,"dataManager",void 0),o([l()],j.prototype,"knowledgeGraph",void 0),o([l()],j.prototype,"layers",void 0),o([l()],j.prototype,"linkChartDiagramLookup",void 0),o([l()],j.prototype,"linkChartExtent",void 0),o([l()],j.prototype,"linkChartGeohashLookup",void 0),o([l()],j.prototype,"memberEntityTypes",void 0),o([l()],j.prototype,"memberRelationshipTypes",void 0),o([l()],j.prototype,"sublayerIdsCache",void 0),o([l()],j.prototype,"tables",void 0),o([l({json:{read:!1}})],j.prototype,"type",void 0),j=o([v("esri.layers.LinkChartLayer")],j);const Wn=j;export{Wn as default};
