import{u6 as P,u7 as z,u8 as L,k1 as k,bZ as q,d4 as R,u9 as D,u3 as N,d as B,u2 as G,ua as K,k0 as Q,ub as U,hB as S,gu as C,uc as V,ud as A,ue as Z,uf as H,ug as J,uh as W,ui as v,uj as X,uk as Y,ul as O,um as E,un as j,uo as ee,up as te,uq as M,of as F,ur as I,us as ne,ut as oe,fl as w,hc as re,jS as se,uu as ue,uv as ae,uw as le,nu as ce,ux as ie}from"./index.da161cf1.js";import{q as fe}from"./georeference.20930ae2.js";import"./MeshGeoreferencedRelativeVertexSpace.a44e5587.js";import"./MeshLocalVertexSpace.33b046fb.js";function me(e,t,n){const u=e.typedBuffer,s=e.typedBufferStride,r=t.typedBuffer,f=t.typedBufferStride,a=n?n.count:t.count;let l=(n&&n.dstIndex?n.dstIndex:0)*s,i=(n&&n.srcIndex?n.srcIndex:0)*f;for(let c=0;c<a;++c){for(let o=0;o<9;++o)u[l+o]=r[i+o];l+=s,i+=f}}Object.freeze(Object.defineProperty({__proto__:null,copy:me},Symbol.toStringTag,{value:"Module"}));function pe(e,t,n){const u=e.typedBuffer,s=e.typedBufferStride,r=t.typedBuffer,f=t.typedBufferStride,a=n?n.count:t.count;let l=(n&&n.dstIndex?n.dstIndex:0)*s,i=(n&&n.srcIndex?n.srcIndex:0)*f;for(let c=0;c<a;++c){for(let o=0;o<16;++o)u[l+o]=r[i+o];l+=s,i+=f}}Object.freeze(Object.defineProperty({__proto__:null,copy:pe},Symbol.toStringTag,{value:"Module"}));function T(e,t){return new e(new ArrayBuffer(t*e.ElementCount*P(e.ElementType)))}async function Me(e,t,n){const u={...n,useTransform:n?.useTransform??!0},s=new z(de(u)),r=(await L(s,t,u,!0)).model,f=r.lods.shift(),a=new Map,l=new Map;r.textures.forEach((g,b)=>a.set(b,Te(g))),r.materials.forEach((g,b)=>l.set(b,ye(g,a)));const i=ge(f);for(const g of i.parts)$e(i,g,l);const{position:c,normal:o,tangent:m,color:p,texCoord0:$}=i.vertexAttributes,h={position:c.typedBuffer,normal:o!=null?o.typedBuffer:null,tangent:m!=null?m.typedBuffer:null,uv:$!=null?$.typedBuffer:null,color:p!=null?p.typedBuffer:null},x=fe(h,e,u);return{transform:x.transform,vertexSpace:x.vertexSpace,components:i.components,spatialReference:e.spatialReference,vertexAttributes:new k({position:x.vertexAttributes.position,normal:x.vertexAttributes.normal,tangent:x.vertexAttributes.tangent,color:h.color,uv:h.uv})}}function de(e){const t=e?.resolveFile;return t?{busy:!1,request:async(n,u,s)=>{const r=t(n);return(await q(r,{responseType:u==="image"?"image":u==="binary"?"array-buffer":"json",signal:s!=null?s.signal:null})).data}}:null}function y(e,t){if(e==null)return"-";const n=e.typedBuffer;return`${R(t,n.buffer,()=>t.size)}/${n.byteOffset}/${n.byteLength}`}function xe(e){return e!=null?e.toString():"-"}function ge(e){let t=0;const n={color:!1,tangent:!1,normal:!1,texCoord0:!1},u=new Map,s=new Map,r=[];for(const f of e.parts){const{attributes:{position:a,normal:l,color:i,tangent:c,texCoord0:o}}=f,m=`
      ${y(a,u)}/
      ${y(l,u)}/
      ${y(i,u)}/
      ${y(c,u)}/
      ${y(o,u)}/
      ${xe(f.transform)}
    `;let p=!1;const $=R(s,m,()=>(p=!0,{start:t,length:a.count}));p&&(t+=a.count),l&&(n.normal=!0),i&&(n.color=!0),c&&(n.tangent=!0),o&&(n.texCoord0=!0),r.push({gltf:f,writeVertices:p,region:$})}return{vertexAttributes:{position:T(ue,t),normal:n.normal?T(F,t):null,tangent:n.tangent?T(O,t):null,color:n.color?T(j,t):null,texCoord0:n.texCoord0?T(ae,t):null},parts:r,components:[]}}function Te(e){return new D({data:(N(e.data),e.data),wrap:ve(e.parameters.wrap)})}function ye(e,t){const n=new B(we(e.color,e.opacity)),u=e.emissiveFactor?new B(Be(e.emissiveFactor)):null,s=r=>r?new le({scale:r.scale?[r.scale[0],r.scale[1]]:[1,1],rotation:ce(r.rotation??0),offset:r.offset?[r.offset[0],r.offset[1]]:[0,0]}):null;return new G({color:n,colorTexture:t.get(e.textureColor),normalTexture:t.get(e.textureNormal),emissiveColor:u,emissiveTexture:t.get(e.textureEmissive),occlusionTexture:t.get(e.textureOcclusion),alphaMode:be(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:t.get(e.textureMetallicRoughness),colorTextureTransform:s(e.colorTextureTransform),normalTextureTransform:s(e.normalTextureTransform),occlusionTextureTransform:s(e.occlusionTextureTransform),emissiveTextureTransform:s(e.emissiveTextureTransform),metallicRoughnessTextureTransform:s(e.metallicRoughnessTextureTransform)})}function $e(e,t,n){t.writeVertices&&he(e,t);const{indices:u,attributes:s,primitiveType:r,material:f}=t.gltf;let a=K(u||s.position.count,r);const l=t.region.start;if(l){const i=new Uint32Array(a);for(let c=0;c<a.length;c++)i[c]+=l;a=i}e.components.push(new Q({faces:a,material:n.get(f),shading:s.normal?"source":"flat",trustSourceNormals:!0}))}function he(e,t){const{position:n,normal:u,tangent:s,color:r,texCoord0:f}=e.vertexAttributes,a=t.region.start,{attributes:l,transform:i}=t.gltf,c=l.position.count;if(U(n.slice(a,c),l.position,i),l.normal!=null&&u!=null){const o=S(C(),i),m=u.slice(a,c);V(m,l.normal,o),A(o)&&Z(m,m)}else u!=null&&H(u,0,0,1,{dstIndex:a,count:c});if(l.tangent!=null&&s!=null){const o=S(C(),i),m=s.slice(a,c);J(m,l.tangent,o),A(o)&&W(m,m)}else s!=null&&v(s,0,0,1,1,{dstIndex:a,count:c});if(l.texCoord0!=null&&f!=null?X(f.slice(a,c),l.texCoord0):f!=null&&Y(f,0,0,{dstIndex:a,count:c}),l.color!=null&&r!=null){const o=l.color,m=r.slice(a,c);if(o.elementCount===4)o instanceof O?E(m,o,255):o instanceof j?ee(m,o):o instanceof te&&E(m,o,1/256);else{v(m,255,255,255,255);const p=M.fromTypedArray(m.typedBuffer,m.typedBufferStride);o instanceof F?I(p,o,255):o instanceof M?ne(p,o):o instanceof oe&&I(p,o,1/256)}}else r!=null&&v(r.slice(a,c),255,255,255,255)}function be(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function ve(e){return{horizontal:_(e.s),vertical:_(e.t)}}function _(e){switch(e){case w.CLAMP_TO_EDGE:return"clamp";case w.MIRRORED_REPEAT:return"mirror";case w.REPEAT:return"repeat"}}function d(e){return e**(1/ie)*255}function we(e,t){return re(d(e[0]),d(e[1]),d(e[2]),t)}function Be(e){return se(d(e[0]),d(e[1]),d(e[2]))}export{Me as loadGLTFMesh};
