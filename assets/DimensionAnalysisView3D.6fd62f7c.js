import{gj as Gs,ba as Fs,mn as Is,mo as Ns,b4 as ks,ni as js,a$ as At,ct as Lt,a_ as ce,aA as g,nj as qs,nk as Us,ax as L,mX as w,me as Ws,k6 as Xn,ml as Qn,gw as Kn,gr as T,lt as ie,i3 as R,n1 as Ci,k8 as je,k2 as Oi,gb as $n,nl as J,nm as Fe,nn as Jn,gN as fe,i4 as un,e as u,y as h,a as H,m as ue,t as Wt,l as dt,q as S,A as G,dF as Zs,au as Ti,d as Z,no as Bs,np as qe,b1 as ft,nq as st,nr as hn,hz as M,ns as Ys,hF as Ri,kq as Di,c2 as se,jS as j,nt as Xs,a1 as Ie,n9 as pn,lc as mn,hl as Be,na as ei,ne as Qs,nu as Ks,nv as Js,nw as er,nx as tr,lY as Ht,mt as x,li as nn,mv as Ne,hY as ct,ny as Ai,mK as le,fn as Li,nz as ti,nA as nr,ld as ir,nB as sr,nC as rr,nD as ar,fa as Vt,j5 as fn,nE as De,b0 as zi,mG as or,mF as re,nF as ni,mS as sn,iU as lr,mR as St,iZ as ee,mQ as Hi,H as Vi,kg as ge,i2 as gn,nG as dr,g8 as cr,kN as Le,mW as Gi,nH as rn,f7 as ii,nI as ur,n2 as si,hV as hr,fH as ri,nJ as pr,V as Ye,h as Gt,n6 as ut,n5 as gt,n4 as rt,nK as mr,nL as fr,nM as _n,nN as yn,iV as $e,mU as gr,k as Cn,aU as _r,U as Ue,g7 as yr,al as vr,cd as wt,nO as Sr,mi as Fi,m_ as wr,ad as Pr,cB as ai,cA as xr,fh as br,B as On,nP as Mr,aQ as Ii,aE as Ni,ff as ht,aR as Tn,di as vn,dj as ki,mw as Ft,dm as Er,aN as Rn,nQ as Sn,aq as $r,ar as Cr,nR as Or,nS as Tr,l0 as Rr,nT as ji,mL as Dr,mM as Ar,nU as Lr,nV as Je,mx as zr,mB as Hr,aO as oi}from"./index.da161cf1.js";import{i as We,u as Vr,a as qi,b as Se,d as Gr,r as Fr,t as Ir}from"./LineVisualElement.0ee7ffd4.js";import{t as E,r as Nr,u as kr}from"./LengthDimension.4b10a477.js";import{r as jr,f as Ui,a as Ce,e as qr,b as Ur,u as z,g as Wr,h as Zr}from"./Segment.b33fc9b3.js";import{T as Br,$ as Wi,e as at,U as Zi,R as Yr,L as Xr,d as _t,N as Dn,a as An,D as Qr,b as Bi,v as li,c as Kr,f as Jr,g as ea,l as ta}from"./analysisViewUtils.8aae6db1.js";import{F as na,H as Yi,A as Ln,n as ia}from"./Factory.312f3b3e.js";import{c as sa,v as ra,b as C,p as Xi}from"./elevationInfoUtils.d710f6c5.js";import{t as Qi,P as aa}from"./RightAngleQuadVisualElement.408eff27.js";import{c as oa,y as di}from"./PointVisualElement.eb5b4fbb.js";import{c as la}from"./ImageMaterial.1905961e.js";import{v as F,L as an,m as da,_ as ca,p as ua,w as ha}from"./EditGeometryOperations.3139b272.js";import{r as pa}from"./dehydratedFeatureComparison.d41240fc.js";function ma(t){const e=Gs(t),n=e===Is?Ns:e;return Fs(t,n)?n:t}var ke;function fa(t,e){const{spatialReference:n}=t;return ks(n,e.spatialReference)?(Pt[0]=t.x,Pt[1]=t.y,Pt[2]=t.hasZ?t.z:0,xt[0]=e.x,xt[1]=e.y,xt[2]=e.hasZ?e.z:0,Ki(Pt,xt,n)):null}function Ki(t,e,n){const i=ga(t,e,n,ke.Direct);return i!=null?jr(i.direct,i.unit):null}function ga(t,e,n,i){const s=ma(n),r=js(s);if(r==null)return null;const a=e[2]-t[2];if(i===ke.Vertical)return{verticalSigned:a,unit:r};if(!At(t,n,on,s)||!At(e,n,bt,s))return null;if(i===ke.Direct)return{direct:Lt(bt,on),unit:r};if(ce(Mt,t[0],t[1],e[2]),!At(Mt,n,Mt,s))return null;const l=Lt(Mt,bt);return i===ke.Horizontal?{horizontal:l,unit:r}:{direct:Lt(bt,on),horizontal:l,vertical:Math.abs(a),unit:r}}(function(t){t[t.Direct=0]="Direct",t[t.Horizontal=1]="Horizontal",t[t.Vertical=2]="Vertical"})(ke||(ke={}));const Pt=g(),xt=g(),on=g(),bt=g(),Mt=g();function _a(t,e,n){if(t==null)return null;const i=t.dimensionSegment.startRenderSpace,s=t.dimensionSegment.endRenderSpace,r=Ki(i,s,t.spatialReference);if(r==null)return null;const a=e===E.Vertical?qs(r.value,r.unit,n):Us(r.value,r.unit,n);return Ui(r,a)}function It(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:n,dimension:{offset:i,measureType:s,orientation:r}}=t;return{elevationAlignedStartPoint:e,elevationAlignedEndPoint:n,offset:i,measureType:s,orientation:r}}function Nt({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,offset:n,measureType:i,orientation:s},r,a=null){if(t==null||e==null)return null;const l=es(a!=null?a.directSegment:new Ce,{elevationAlignedStartPoint:t,elevationAlignedEndPoint:e},r),o=a!=null?a.primaryOffsetAxis:g();Zt(o,{measureType:i,elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,directSegment:l,orientation:s,renderCoordsHelper:r});const d=a!=null?a.dimensionSegment:new Ce;return zn({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e})&&i===E.Vertical?(L(d.startRenderSpace,l.startRenderSpace),L(d.endRenderSpace,l.endRenderSpace)):ts(d,{offsetAxis:o,offset:n,relativeToSegment:l,renderCoordsHelper:r}),{directSegment:l,dimensionSegment:d,primaryOffsetAxis:o,spatialReference:r.spatialReference}}function ci(t,e,n,i){return e===pt.Start?(L(t.startRenderSpace,n.startRenderSpace),L(t.endRenderSpace,i.startRenderSpace)):(L(t.startRenderSpace,n.endRenderSpace),L(t.endRenderSpace,i.endRenderSpace)),t}var pt;function ya(t,e,n,i){J(t.startRenderSpace,e.startRenderSpace,n,i),J(t.endRenderSpace,e.endRenderSpace,n,i)}function Ji(t,e,n,i){switch(e){case E.Direct:return es(t,n,i);case E.Horizontal:case E.Vertical:{const{elevationAlignedStartPoint:s,elevationAlignedEndPoint:r,dimension:a,geometry:l}=n;let o;a.measureType===E.Direct?(o=va(l,i)===s.z>r.z,e===E.Horizontal&&(o=!o)):o=!Sa(l);const[d,c]=o?[s,r]:[r,s],p=Fe(c,wa);return e===E.Horizontal?p.z=d.z:(p.x=d.x,p.y=d.y),i.toRenderCoords(d,t.startRenderSpace),i.toRenderCoords(p,t.endRenderSpace),t}}}function es(t,e,n){return n.toRenderCoords(e.elevationAlignedStartPoint,t.startRenderSpace),n.toRenderCoords(e.elevationAlignedEndPoint,t.endRenderSpace),t}function va(t,e){const n=t.directSegment.eval(.5,w.get()),i=e.worldUpAtPosition(n,w.get()),s=t.dimensionSegment.eval(.5,w.get()),r=T(w.get(),s,n);return!Ci(r,je)&&R(r,i)>0}function Sa(t){const{startRenderSpace:e,endRenderSpace:n}=t.dimensionSegment,{startRenderSpace:i,endRenderSpace:s}=t.directSegment;return Jn(i,e)<Jn(s,n)}(function(t){t[t.Start=0]="Start",t[t.End=1]="End"})(pt||(pt={}));const wa=fe(0,0,0,null);function Pa(t,e,n,i){const{directSegment:s}=n,r=Zt(w.get(),{measureType:e,directSegment:s,renderCoordsHelper:i}),a=ts(xa,{offsetAxis:r,offset:0,relativeToSegment:s,renderCoordsHelper:i}).eval(.5,w.get()),l=T(w.get(),t,a);return R(l,r)*i.unitInMeters}const xa=new Ce;function Zt(t,e){const{measureType:n,elevationAlignedStartPoint:i,elevationAlignedEndPoint:s,directSegment:{startRenderSpace:r,endRenderSpace:a},directSegment:l,renderCoordsHelper:o}=e,d=l.eval(.5,w.get()),c=o.worldUpAtPosition(d,w.get()),p=o.worldBasisAtPosition(d,Ws.Y,w.get());switch(n){case E.Horizontal:L(t,c);break;case E.Vertical:R(r,c)<R(a,c)?T(t,a,r):T(t,r,a),ie(t,t,c),ie(t,t,c);break;case E.Direct:{const m=e.orientation??0;if(zn({elevationAlignedStartPoint:i,elevationAlignedEndPoint:s}))Xn(Et,-Qn(m),c),Kn(t,p,Et);else{const f=T(w.get(),a,r),v=ie(w.get(),f,c);ie(v,v,f),Xn(Et,Qn(m),f),Kn(t,v,Et)}break}}return Ci(t,je)?L(t,p):Oi(t,t)}const Et=$n();function zn({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e}){return t!=null&&e!=null&&t.x===e.x&&t.y===e.y}function ts(t,e){const{offsetAxis:n,offset:i,relativeToSegment:{startRenderSpace:s,endRenderSpace:r},relativeToSegment:a,renderCoordsHelper:l}=e,o=i/l.unitInMeters,[d,c]=ba(s,r,n,o);return J(t.startRenderSpace,a.startRenderSpace,n,d),J(t.endRenderSpace,a.endRenderSpace,n,c),t}function ba(t,e,n,i=0){const s=R(e,n),r=R(t,n),a=Math.abs(s-r)+i;return s>r?[a,i]:[i,a]}function Bt(t,e,n){const i=e.directSegment.eval(.5,w.get());return n.worldUpAtPosition(i,t)}function Hn(t,e){const{startRenderSpace:n,endRenderSpace:i}=e.directSegment;return T(t,i,n)}function Vn(t,e,n={invert:!1}){const{startRenderSpace:i,endRenderSpace:s}=e.dimensionSegment;return n.invert?T(t,i,s):T(t,s,i)}function wn(t,e){const n=t.directSegment.eval(.5,w.get());return e.headingAtPosition(n,t.primaryOffsetAxis)}function Ma(t,e){return un(Vn(Ea,t))/e**2}const Ea=g();function ns(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:n}=t;if(e==null||n==null)return!1;const i=fa(e,n);return i!=null&&Ui(i,"meters").value>is}const is=1e5;function mt(t){return t.geometry!=null}let we=class extends ue{constructor(t){super(t),this._handles=new Wt}initialize(){const{computations:t}=this.analysisViewData;for(const e of t)this._addComputation(e);this.addHandles(t.on("change",({added:e,removed:n})=>{for(const i of n)this._removeComputation(i);for(const i of e)this._addComputation(i)}))}destroy(){this._handles=dt(this._handles)}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return qr(this.view)}_addComputation(t){this._handles.has(t)||this._handles.add(S(()=>It(t),e=>{const{measureType:n}=e;if(ns(e)&&n!==E.Direct){const s=Math.round(Zs(is,"meters","kilometers"));return Ti.getLogger(this).warnOnce(`A ${n} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${s} km. Update the measureType of the affected dimension to "direct" to display it.`),void(t.geometry=null)}const i=Nt(e,this.view.renderCoordsHelper,t.geometry);t.geometry=i,t.result.length=_a(i,n,this._defaultUnit)},G),t)}_removeComputation(t){this._handles.remove(t)}};u([h({constructOnly:!0})],we.prototype,"analysisViewData",void 0),u([h({constructOnly:!0})],we.prototype,"view",void 0),u([h()],we.prototype,"analysis",null),u([h()],we.prototype,"_defaultUnit",null),we=u([H("esri.views.3d.analysis.Dimension.support.DimensionController")],we);class $a{constructor(){this.color=We(.5),this.radius=5}}class Ca{constructor(){this.color=new Z([127,127,127,.5]),this.radius=5}}class Oa{constructor(){this.lineSizeFraction=.8}}class Ta{constructor(){this.color=We(.5),this.linePaddingPx=4,this.focusedLinePaddingPx=6,this.lengthFraction=.5,this.minLengthMeters=.1}}class Ra{constructor(){this.calloutOffsetPx=18,this.calloutWidth=2,this.discScale=.3,this.focusMultiplier=2,this.color=We(.5),this.contrastColor=Vr()}}class Da{constructor(){this.lineSizeFraction=.25}}class Aa{constructor(){this.marginPx=20,this.minScreenLengthFontSizeFactor=5}}class La{constructor(){this.color=We(.5)}}class za{constructor(){this.pointManipulators=new $a,this.offsetManipulator=new Ta,this.orientationManipulator=new Ra,this.markers=new Oa,this.labels=new Aa,this.offsetLine=new Da,this.constraint=new La,this.constraintThresholdPx=10,this.initialOffsetPx=50,this.orientationSnapThresholdDegrees=5,this.disabledPointIndicator=new Ca,this.smallScreenLengthLineSizeFactor=2,this.pointerMoveTimeoutMs=2500}}let $=new za;class Ha{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find(n=>this.hasOwnProperty(n)&&e===this[n])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const n of Nr)e(this.manipulatorForMeasureType(n),n)}manipulatorForMeasureType(e){switch(e){case E.Direct:return this.direct;case E.Horizontal:return this.horizontal;case E.Vertical:return this.vertical}}}function Va(t,e){const n=Br(t,Z.toUnitRGBA($.pointManipulators.color),de);return n.available=!1,n.grabCursor="crosshair",n.radius=$.pointManipulators.radius,n.metadata=e.metadata,n.collisionPriority=1,n}function Ga(t,e){const n=[j(-.5,0,0),j(.5,0,0)],{lengthFraction:i}=$.offsetManipulator,s=qe(e.unfocusedMaterial,n.map(a=>ft(g(),a,i))),r=s.instantiate({material:e.focusedMaterial});return new Wi({view:t,renderObjects:[new at(s,st.Unfocused|st.Selected|de),new at(r,st.Focused|de)],collisionType:{type:"line",paths:[n]},radius:Gn(e.lineSizePt)/2,metadata:e.metadata,available:!1,...Zi})}function ss(t,{lineSizePt:e,material:n}){const{calloutOffsetPx:i,calloutWidth:s,discScale:r,focusMultiplier:a,color:l}=$.orientationManipulator;return{calloutLength:.25*Xs*$.markers.lineSizeFraction*se(e)+i,calloutColor:Z.toUnitRGBA(l),calloutWidth:s,customStateMask:de,discScale:r,focusMultiplier:a,material:n,metadata:t}}function ui(t,e){return Yr(t,ss(e.metadata,e))}function hi(t,e){Xr(t,ss(t.metadata,e))}function Fa(t,e){const n=[j(-.5,0,0),j(.5,0,0)],{lengthFraction:i}=$.offsetManipulator,s=qe(e.thinOffsetManipulatorMaterial,n),r=qe(e.unfocusedMaterial,n.map(l=>ft(g(),l,i))),a=r.instantiate({material:e.focusedMaterial});return new Wi({view:t,renderObjects:[new at(r,st.Unfocused|de),new at(a,st.Focused|de),new at(s,de)],collisionType:{type:"line",paths:[n]},radius:Gn(e.lineSizePt)/2,available:!1,metadata:e.metadata,...Zi})}function Ia(t,{isStart:e,createSnappingPipelineStep:n,dimension:i,onUpdate:s,view:r}){const a=e?"startPoint":"endPoint";return[_t(t,(o,d,c,p)=>{const m=Ln(o),{snappingStep:f,cancelSnapping:v}=n(p);c=c.next(m).next(An(i,[a,"measureType","orientation"])).next(v),d.next(m).next(na(r)).next(...f).next(y=>{const _=Fe(y.mapEnd,new Ie);s(a==="startPoint"?{startPoint:_}:{endPoint:_})})})]}function Na(t,{computation:e,view:n}){return[_t(t,(i,s,r)=>{if(!mt(e)||!i.selected)return;const{geometry:a,dimension:l}=e,o=Ln(i);s.next(o).next(as(n,l,a.dimensionSegment,a.primaryOffsetAxis)),r.next(o).next(An(l,["offset"]))})]}function ka(t,{computation:e,view:n}){return[_t(t,(i,s,r)=>{rs({cancel:r,computation:e,settingHeading:!0,steps:s,view:n})})]}function ja(t,{computation:e,view:n}){return[_t(t,(i,s,r)=>{rs({cancel:r,computation:e,settingHeading:!1,steps:s,view:n})}),t.events.on("immediate-click",i=>{qa(i,e,n)})]}function qa(t,e,n){const{dimension:i,geometry:s}=e;if(i.orientation===90||i.orientation===270)return i.orientation=0,void t.stopPropagation();if(s==null)return;const{renderCoordsHelper:r}=n,a=Nt({...It(e),orientation:90},r),l=Nt({...It(e),orientation:270},r);if(a==null||l==null)return;const o=wn(a,r),d=wn(l,r),c=os(s,n),p=hn.shortestSignedDiff(c,o),m=hn.shortestSignedDiff(c,d);i.orientation=Math.abs(p)<Math.abs(m)?90:270,t.stopPropagation()}function rs(t){const{cancel:e,computation:n,settingHeading:i,steps:s,view:r}=t;if(!mt(n))return;const{renderCoordsHelper:a}=r,{dimension:l,geometry:o}=n,d=g(),c=ds(g(),o,o.directSegment,a),p=cs(w.get(),{forHeading:i,geometry:o,renderCoordsHelper:a}),m=pn(c,p,mn()),f=i?l.orientation??wn(o,r.renderCoordsHelper):l.orientation??0;s.next(Yi(r,m)).next(v=>{v.action==="start"&&L(d,v.renderStart);const y=Qs(m),_=Qr(d,v.renderEnd,c,y);let A=f-Ks(_);i||(A=Ua(A)),l.orientation=A}),e.next(An(l,["orientation"]))}function Ua(t){const e=hn.normalize(t)%90;return e<$.orientationSnapThresholdDegrees?t-e:90-e<$.orientationSnapThresholdDegrees?t+(90-e):t}function Wa(t,{computation:e,manipulatorMeasureType:n,view:i}){let s=E.Direct,r=0,a=0;return[t.events.on("grab-changed",l=>{if(l.action!=="start"||!mt(e))return;const{dimension:o,geometry:d}=e;s=o.measureType,r=o.offset,a=o.orientation;const c=L(w.get(),t.renderLocation);o.measureType=n,o.offset=Pa(c,n,d,i.renderCoordsHelper),o.orientation=0}),_t(t,(l,o,d)=>{if(!mt(e))return;const{geometry:c,dimension:p}=e,{renderCoordsHelper:m}=i,f=Ji(us,n,e,m),v=Zt(w.get(),{measureType:n,directSegment:c.directSegment,renderCoordsHelper:m}),y=Ln(l);o.next(y).next(as(i,p,f,v)),d.next(y).next(_=>(p.measureType=s,p.offset=r,p.orientation=a,_))})]}function as(t,e,n,i){const s=Be(w.get(),n.endRenderSpace,n.startRenderSpace);ie(s,s,i);const r=pn(n.startRenderSpace,s,mn()),a=pn(n.startRenderSpace,i,mn()),l=e.offset;let o,d=0;const c=new Bi;return c.next(Yi(t,r)).next(p=>{p.action==="start"&&(d=ei(a,p.renderStart));const m=(ei(a,p.renderEnd)-d)*t.renderCoordsHelper.unitInMeters;e.offset=l+m,o=p}),p=>(c.execute(p),o)}function os(t,e){const{directSegment:n}=t,{renderCoordsHelper:i}=e,s=Bt(w.get(),t,i),r=Hn(w.get(),t),a=ie(w.get(),r,s),{viewForward:l}=e.state.camera;R(a,l)>0&&ft(a,a,-1);const o=n.eval(.5,w.get());return i.headingAtPosition(o,a)}function Za(t,e,n){const{dimensionSegment:i,primaryOffsetAxis:s}=e,r=Vn(ot,e),a=M(r,je)?Ys(kt):Dn(r,s,je,kt),l=Math.max(Ri(r),$.offsetManipulator.minLengthMeters/n.unitInMeters);Di(a,a,ce(ot,l,l,l)),t.modelTransform=a,t.renderLocation=i.eval(.5,ot)}function Ba(t,e,n){ls(t,e,n,{forHeading:!0})}function Ya(t,e,n){ls(t,e,n,{forHeading:!1})}function ls(t,e,n,{forHeading:i}){const{dimension:s,geometry:r}=e,{primaryOffsetAxis:a}=r,l=ft(Xa,a,s.offset>=0?1:-1),o=cs(Qa,{forHeading:i,geometry:r,renderCoordsHelper:n});ie(o,o,l);const d=Dn(l,o,je,kt);t.modelTransform=d,t.renderLocation=ds(ot,r,r.dimensionSegment,n)}const Xa=g(),Qa=g();function Ka(t,e,n,i){const{geometry:s}=e,r=Ji(us,n,e,i),a=Zt(ot,{measureType:n,directSegment:s.directSegment,renderCoordsHelper:i}),l=T(ln,r.endRenderSpace,r.startRenderSpace),o=Dn(l,a,je,kt),d=Ri(l);Di(o,o,ce(ln,d,d,d)),t.modelTransform=o,t.renderLocation=r.eval(.5,ln)}function ds(t,e,n,i){const{startRenderSpace:s,endRenderSpace:r}=n,a=Ja(e,i)?s:r;return L(t,a)}function cs(t,{forHeading:e,geometry:n,renderCoordsHelper:i}){return e?Bt(t,n,i):Vn(t,n,{invert:!0})}function Ja(t,e){const n=Hn(eo,t),i=Bt(to,t,e);return R(n,i)>0}const eo=g(),to=g();function no(t){return se(t)+$.offsetManipulator.linePaddingPx}function Gn(t){return se(t)+$.offsetManipulator.focusedLinePaddingPx}const de=Bs.Custom1,ot=g(),ln=g(),kt=$n(),us=new Ce;function io(t){let e,n,i=[],s=!1;function r(...a){return s&&e===this&&so(a,i)||(n=t.apply(this,a),e=this,i=a,s=!0),n}return r}function so(t,e){if(t.length!==e.length)return!1;for(let n=0;n<t.length;++n)if(t[n]!==e[n])return!1;return!0}var B;function ro(t,e){return{enabled:e.effectiveFeatureEnabled,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,geometry:t.geometry}}function ao(t,e){if(ns(t))return B.Direct;if(!t.enabled)return null;const{geometry:n}=t;if(n==null||M(n.directSegment.startRenderSpace,n.directSegment.endRenderSpace))return null;const{constraintThresholdPx:i}=$,{camera:s}=e.state,r=Bt(w.get(),n,e.renderCoordsHelper),a=Hn(w.get(),n),l=ft(w.get(),r,R(a,r)),o=Be(w.get(),a,l),d=un(o),c=un(l),{startRenderSpace:p,endRenderSpace:m}=n.directSegment,f=Math.max(s.computeRenderPixelSizeAt(p)*i,s.computeRenderPixelSizeAt(m)*i)**2;return d<f?B.Vertical:c<f?B.Horizontal:null}function oo(t,e,{constraint:n,view:i}){const{unconstrainedGeometry:s}=t;if(s==null)return;const{renderCoordsHelper:r,spatialReference:a}=i,{startRenderSpace:l,endRenderSpace:o}=s.directSegment,d=r.fromRenderCoords(l,new Ie,a),c=r.fromRenderCoords(o,new Ie,a);let p;p=e==="start"?{startPoint:d}:{endPoint:c},hs(t,p,{constraint:n,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,unconstrainedGeometry:s,view:i})}function hs(t,e,n){const{constraint:i,elevationAlignedStartPoint:s,elevationAlignedEndPoint:r,unconstrainedGeometry:a,view:l}=n,{dimension:o,previousConstraint:d,preConstraintProperties:c}=t;if(s==null||r==null)return;const p=()=>{"startPoint"in e?o.startPoint=e.startPoint:"endPoint"in e&&(o.endPoint=e.endPoint)};if(i==null)p(),d!=null&&c!=null&&(o.measureType=c.measureType,o.orientation=c.orientation);else switch(o.measureType=E.Direct,i){case B.Horizontal:if(i!==d&&(o.orientation=0),"startPoint"in e){const m=e.startPoint;m!=null&&(m.z=r.z),o.startPoint=m}else if("endPoint"in e){const m=e.endPoint;m!=null&&(m.z=s.z),o.endPoint=m}break;case B.Vertical:if(i!==d&&(o.orientation=os(a,l)),"startPoint"in e){const m=e.startPoint;m!=null&&(m.x=r.x,m.y=r.y),o.startPoint=m}else if("endPoint"in e){const m=e.endPoint;m!=null&&(m.x=s.x,m.y=s.y),o.endPoint=m}break;case B.Direct:i!==d&&c!=null&&(o.orientation=c.orientation),p()}t.previousConstraint=i,t.unconstrainedGeometry=a}(function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical",t[t.Direct=2]="Direct"})(B||(B={}));class lo extends Qi{constructor(e){super(e),this._ray=tr(),this._isWorldDown=!1,this._start=g(),this._end=j(1,0,0),this._width=1,this._color=Ht(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=Ht(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=X.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=x.OccludeAndTransparent,this._fadedExtensions=fi,this._laserline=new oa({view:this.view}),this.applyProps(e)}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(e){return{view:e,createResources:n=>this._createObject3DResources(n),destroyResources:n=>this._destroyExternalResources(n),recreateGeometry:(n,i)=>this._recreateObject3DGeometry(n,i),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:n=>this._destroyExternalResources(n),recreateGeometry:n=>this._recreateDrapedGeometry(n)}}updateVisibility(e){super.updateVisibility(e),this._laserline.visible=e}onAttachedChange(){this._laserline.attached=this._laserlineAttached}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,L(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),Be(this._end,e,this._end),nn(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,M(this._start,e)||(L(this._start,e),nn(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,M(this._end,e)||(L(this._end,e),nn(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){Ne(e,this._color)||(ct(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){Ne(e,this._innerColor)||(ct(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const n=e!=null!=(this._stipplePattern!=null);this._stipplePattern=e,n?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e!=null&&this._stippleOffColor!=null&&Ne(e,this._stippleOffColor)||(this._stippleOffColor=e!=null?Ai(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this.recreateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&this._laserlineStyle!=null&&this.attached&&!this.isDraped}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this._laserlineAttached,e!=null&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===x.OccludeAndTransparentStencil?x.OccludeAndTransparent:this._renderOccluded}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=e??fi,this.recreateGeometry()}_updateMaterial(){const{materialParameters:e}=this;this.object3dResources.resources?.material.setParameters(e),this.drapedResources.resources?.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._normalizedRenderOccluded,writeDepth:this._writeDepthEnabled}}_createObject3DResources(e){const n=new le(this.materialParameters),i=new Array;return this._createObject3DGeometry(n,e,i),{material:n,geometries:i,forEach:s=>{s(n),i.forEach(s)}}}_destroyExternalResources(e){e.geometries=[],e.material.dispose()}_recreateObject3DGeometry(e,n){e.geometries.length=0,this._createObject3DGeometry(e.material,n,e.geometries)}_createObject3DGeometry(e,n,i){const s=this._createGeometry(e);i.push(s),n.addGeometry(s),this._updateVerticesObject3D(n)}_createDrapedResources(){const e=new le(this.materialParameters);return{material:e,geometries:[this._createDrapedGeometry(e)]}}_recreateDrapedGeometry(e){e.geometries=[this._createDrapedGeometry(e.material)]}_createDrapedGeometry(e){const n=this._createGeometry(e);return this._updateVerticesDraped(n),new Li(n)}_createGeometry(e){const n=this.extensionType===X.FADED,i=n?[g(),g(),g(),g()]:[g(),g()];return qe(e,i,null,n?[1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]:null)}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const n=this._lineSegment;this._updateVertexAttributesObject3D(e,n),this._laserline.intersectsLine=n}_updateVerticesDraped(e){this._updateVertexAttributesDraped(e,this._lineSegment)}get _lineSegment(){return this._extensionType===X.FADED?this._updateLineSegmentFinite(pi):this._updateLineSegmentInfinite(this._extensionType,pi)}_updateLineSegmentFinite(e){return ti(this._start,this._end,e)}_updateLineSegmentInfinite(e,n){const i=this.view.state.camera;switch(nr(this._ray,he),e){case X.LINE:he.c0=-Number.MAX_VALUE;break;case X.RAY:case X.GROUND_RAY:{const a=this._ray.origin,l=this.view.elevationProvider.getElevation(a[0],a[1],a[2],this.view.renderCoordsHelper.spatialReference,"ground")??0,o=this.view.renderCoordsHelper.getAltitude(a);this._isWorldDown&&o<l&&ir(he.ray.direction,he.ray.direction),this._extensionType===X.GROUND_RAY&&l!=null&&(he.c1=Math.abs(o-l));break}}if(!sr(i.frustum,he))return this._updateLineSegmentFinite(n);const s=rr(he,_e),r=ar(he,co);return ti(s,r,n)}_updateVertexAttributesObject3D(e,n){const i=e.geometries[0].getMutableAttribute(Vt.POSITION)?.data;if(!i)return;let s=0;for(const r of this._lineVertices(n))i[s++]=r[0],i[s++]=r[1],i[s++]=r[2];e.geometryVertexAttrsUpdated(e.geometries[0])}_updateVertexAttributesDraped(e,n){const i=e.getMutableAttribute(Vt.POSITION)?.data;if(!i)return;let s=0;for(const r of this._lineVertices(n))i[s++]=r[0],i[s++]=r[1],i[s++]=fn;e.invalidateBoundingInfo()}*_lineVertices(e){this.extensionType===X.FADED?(yield De(e,-this.fadedExtensions.start,_e),yield De(e,0,_e),yield De(e,1,_e),yield De(e,1+this.fadedExtensions.end,_e)):(yield De(e,0,_e),yield De(e,1,_e))}}const he=Js(),_e=g(),co=g(),pi=er();var X;(function(t){t[t.LINE=0]="LINE",t[t.RAY=1]="RAY",t[t.GROUND_RAY=2]="GROUND_RAY",t[t.FADED=3]="FADED"})(X||(X={}));const mi=1/3,fi={start:mi,end:mi};class uo extends Qi{constructor(e){super(e),this._location=g(),this._direction=j(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=Ht(1,0,1,1),this._renderOccluded=x.OccludeAndTransparent,this.applyProps(e)}createObject3DResourceFactory(e){return{view:e,createResources:n=>this._createObject3DResources(n),destroyResources:n=>this._destroyObject3DResources(n),recreateGeometry:(n,i)=>this._recreateObject3DGeometry(n,i),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:n=>this._destroyDrapedResources(n),recreateGeometry:n=>this._recreateDrapedGeometry(n)}}get location(){return this._location}set location(e){M(this._location,e)||(L(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){M(this._direction,e)||(L(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,n){Oi(this._direction,Be(this._direction,n,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){Ne(e,this._color)||(ct(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}_createObject3DResources(e){const n=new le(this.materialParameters),i=new Array;return this._createObject3DGeometry(n,e,i),{material:n,geometries:i,forEach:s=>{s(n),i.forEach(s)}}}_destroyObject3DResources(e){e.geometries.length=0,e.material.dispose()}_recreateObject3DGeometry(e,n){e.geometries.length=0,this._createObject3DGeometry(e.material,n,e.geometries)}_createObject3DGeometry(e,n,i){const[s,r]=this._createGeometries(e);n.addGeometry(s),n.addGeometry(r),i.push(s),i.push(r),this._updateVerticesObject3D(n)}_createDrapedResources(){const e=new le(this.materialParameters),n=S(()=>this.view.state.contentPixelRatio,()=>{this.drapedResources.recreateGeometry()});return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:n}}_destroyDrapedResources(e){e.pixelRatioHandle.remove(),e.geometries=[],e.material.dispose()}_recreateDrapedGeometry(e){e.geometries=this._createDrapedGeometry(e.material)}_createDrapedGeometry(e){const n=this._createGeometries(e);return this._updateVerticesDraped(n),n.map(i=>new Li(i))}_createGeometries(e){return[qe(e,[g(),g()]),qe(e,[g(),g()])]}_updateMaterial(){const{materialParameters:e}=this;this.object3dResources.resources?.material.setParameters(e),this.drapedResources.resources?.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const n=this.view.state.camera;n.projectToScreen(this.location,Ct),zi(ne,this.location,this.direction),n.projectToScreen(ne,Ae),or(Ae,re(Ae,Ae,Ct)),this._updateVertexAttributesObject3D(n,e,0,Ct,Ae,1),this._updateVertexAttributesObject3D(n,e,1,Ct,Ae,-1)}_updateVertexAttributesObject3D(e,n,i,s,r,a){const l=n.geometries[i],o=l.getMutableAttribute(Vt.POSITION)?.data;if(!o)return;const{start:d,end:c}=this._computeStartEnd(r,s,a,this.offset,this.width,this.length);e.unprojectFromScreen(ni(d),ne),o[0]=ne[0],o[1]=ne[1],o[2]=ne[2],e.unprojectFromScreen(ni(c),ne),o[3]=ne[0],o[4]=ne[1],o[5]=ne[2],n.geometryVertexAttrsUpdated(l)}_updateVerticesDraped(e){const{view:{basemapTerrain:{overlayManager:n},state:{contentPixelRatio:i}}}=this,{location:s,width:r,length:a,offset:l}=this,o=ho;o.spatialReference=n.renderer.spatialReference,o.x=s[0],o.y=s[1];const d=n.overlayPixelSizeInMapUnits(o)*i,c=r*d,p=a*d,m=l*d;this._updateVertexAttributesDraped(e[0],c,p,m,-1),this._updateVertexAttributesDraped(e[1],c,p,m,1)}_updateVertexAttributesDraped(e,n,i,s,r){const a=e.getMutableAttribute(Vt.POSITION)?.data;if(!a)return;const{location:l,direction:o}=this,{start:d,end:c}=this._computeStartEnd(o,l,r,s,n,i);a[0]=d[0],a[1]=d[1],a[2]=fn,a[3]=c[0],a[4]=c[1],a[5]=fn,e.invalidateBoundingInfo()}_computeStartEnd(e,n,i,s,r,a){const l=sn(gi,lr(gi,e[1]*i,e[0]*-i),s+r/2),o=St($t,St($t,St($t,n,sn($t,e,a/2)),l),l);return{start:o,end:St(_i,o,sn(_i,e,-a))}}}const ne=g(),gi=ee(),$t=ee(),_i=ee(),Ct=Hi(),Ae=Hi(),ho=fe(0,0,void 0,null);let Q=class extends Vi{constructor(){super(...arguments),this.enabled=!0}};u([h({type:Boolean})],Q.prototype,"enabled",void 0),Q=u([H("esri.views.interactive.snapping.Settings.DefaultSnappingAlgorithm")],Q);let P=class extends Vi{constructor(t){super(t),this.lineSnapper=new Q,this.parallelLineSnapper=new Q,this.rightAngleSnapper=new Q,this.rightAngleTriangleSnapper=new Q,this.shortLineThreshold=15,this.distance=5,this.pointThreshold=1e-6,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.verticalLineThreshold=.1,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new Z([255,127,0]),this.orangeTransparent=new Z([255,127,0,.5]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5,this.satisfiesConstraintScreenThreshold=1}};u([h({type:Q,constructOnly:!0,nonNullable:!0,json:{write:!0}})],P.prototype,"lineSnapper",void 0),u([h({type:Q,constructOnly:!0,nonNullable:!0,json:{write:!0}})],P.prototype,"parallelLineSnapper",void 0),u([h({type:Q,constructOnly:!0,nonNullable:!0,json:{write:!0}})],P.prototype,"rightAngleSnapper",void 0),u([h({type:Q,constructOnly:!0,nonNullable:!0,json:{write:!0}})],P.prototype,"rightAngleTriangleSnapper",void 0),u([h({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],P.prototype,"shortLineThreshold",void 0),u([h({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],P.prototype,"distance",void 0),u([h({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],P.prototype,"pointThreshold",void 0),u([h({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],P.prototype,"intersectionParallelLineThreshold",void 0),u([h({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],P.prototype,"parallelLineThreshold",void 0),u([h({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],P.prototype,"verticalLineThreshold",void 0),u([h({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],P.prototype,"touchSensitivityMultiplier",void 0),u([h({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],P.prototype,"pointOnLineThreshold",void 0),u([h({type:Z,nonNullable:!0})],P.prototype,"orange",void 0),u([h({type:Z,nonNullable:!0})],P.prototype,"orangeTransparent",void 0),u([h({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],P.prototype,"lineHintWidthReference",void 0),u([h({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],P.prototype,"lineHintWidthTarget",void 0),u([h({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],P.prototype,"lineHintFadedExtensions",void 0),u([h({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],P.prototype,"parallelLineHintWidth",void 0),u([h({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],P.prototype,"parallelLineHintLength",void 0),u([h({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],P.prototype,"parallelLineHintOffset",void 0),u([h({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],P.prototype,"rightAngleHintSize",void 0),u([h({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],P.prototype,"rightAngleHintOutlineSize",void 0),u([h({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],P.prototype,"satisfiesConstraintScreenThreshold",void 0),P=u([H("esri.views.interactive.snapping.Settings.Defaults")],P);const O=new P;var D;(function(t){t[t.FEATURE=1]="FEATURE",t[t.SELF=2]="SELF",t[t.ALL=3]="ALL"})(D||(D={}));function Rl(t){return t}function ps(t){return ge(t)}function po(t,e,n){return j(t,e,n)}function b(t,e,n){return t==null?null:nt(n.coordinateHelper.vectorToDehydratedPoint(t,mo),e,n)}function nt(t,e,n){if(t==null)return null;if(e==null)return j(t.x,t.y,t.z??0);if(e.type==="2d")return j(t.x,t.y,0);const{elevationInfo:i}=n,s=sa(e,t,i,C)??0;return j(t.x,t.y,s)}function yi(t,e,{z:n,m:i,spatialReference:s,elevationInfo:r}){if(n==null&&i==null){const o=fe(t[0],t[1],void 0,s);return i!=null&&(o.m=i,o.hasM=!0),o}if(e==null||e.type==="2d"){const o=fe(t[0],t[1],n,s);return i!=null&&(o.m=i,o.hasM=!0),o}const a=ra(e,t,s,C,r)??0,l=fe(t[0],t[1],a,s);return i!=null&&(l.m=i,l.hasM=!0),l}function vi(t,e){return fe(t[0],t[1],t[2],e)}const mo=fe(0,0,0,null),Si={redo:"r",undo:"z",center:"Alt",constraint:"Shift",cancel:"Escape",delete:["Backspace","Delete"],complete:"Enter",vertexAdd:"f",pan:" "},wi={toggle:"Control"};function Oe(t,e){const n=t.x-e.x,i=t.y-e.y;return n*n+i*i}function fo(t,e){return Math.sqrt(Oe(t,e))}function Fn(t,e){e.sort((n,i)=>gn(n.targetPoint,t)-gn(i.targetPoint,t))}var I;function Dl({point:t,distance:e,returnEdge:n,returnVertex:i,coordinateHelper:{spatialReference:s}},r,a){return{point:fe(t[0],t[1],t[2],s.toJSON()),mode:r,distance:e,returnEdge:n,returnVertex:i,query:a!=null?a.toJSON():{where:"1=1"}}}function jt(t,e,n){return{left:b(t.leftVertex.pos,e,n),right:b(t.rightVertex.pos,e,n)}}function Al(t){return t.createQuery()}function go(t,e=()=>{}){const n=S(()=>({view:t.view,snappingOptions:t.snappingOptions}),({view:i,snappingOptions:s})=>{const r="snapping-toggle",a=dr.TOOL;if(t.removeHandles(r),i&&s!=null){const l=[i.on("key-down",o=>{o.key!==wi.toggle||o.repeat||(s.enabledToggled=!0,e())},a),i.on("key-up",o=>{o.key===wi.toggle&&(s.enabledToggled=!1,e())},a),i.on("pointer-move",o=>{const d=o.native.ctrlKey;s.enabledToggled!==d&&(s.enabledToggled=d,e())},a)];t.addHandles(l,r)}},G);t.addHandles(n)}(function(t){t[t.TARGET=0]="TARGET",t[t.REFERENCE=1]="REFERENCE",t[t.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"})(I||(I={}));class yt{constructor(e,n){this.isDraped=e,this.domain=n}}class Yt extends yt{constructor(e,n,i=D.ALL){super(n,i),this.intersectionPoint=e}equals(e){return e instanceof Yt&&M(this.intersectionPoint,e.intersectionPoint)}}class N extends yt{constructor(e,n,i,s,r=D.ALL,a=!0,l=!0){super(s,r),this.type=e,this.lineStart=n,this.lineEnd=i,this.fadeLeft=a,this.fadeRight=l}equals(e){return e instanceof N&&this.type===e.type&&M(this.lineStart,e.lineStart)&&M(this.lineEnd,e.lineEnd)&&this.fadeLeft===e.fadeLeft&&this.fadeRight===e.fadeRight}get length(){return Lt(this.lineStart,this.lineEnd)}}class Xt extends yt{constructor(e,n,i,s=D.ALL){super(i,s),this.lineStart=e,this.lineEnd=n}equals(e){return e instanceof Xt&&M(this.lineStart,e.lineStart)&&M(this.lineEnd,e.lineEnd)}}class In extends yt{constructor(e,n,i){super(n,i),this.point=e}equals(e){return e instanceof In&&M(this.point,e.point)}}class vt extends yt{constructor(e,n,i,s,r=D.ALL){super(s,r),this.previousVertex=e,this.centerVertex=n,this.nextVertex=i}equals(e){return e instanceof vt&&M(this.previousVertex,e.previousVertex)&&M(this.centerVertex,e.centerVertex)&&M(this.nextVertex,e.nextVertex)}}class _o{draw(e,n){const i=this._getUniqueHints(e),s=this.sortUniqueHints(i),r=[];for(const a of s)a instanceof Yt&&r.push(this.visualizeIntersectionPoint(a,n)),a instanceof N&&r.push(this.visualizeLine(a,n)),a instanceof Xt&&r.push(this.visualizeParallelSign(a,n)),a instanceof vt&&r.push(this.visualizeRightAngleQuad(a,n)),a instanceof In&&r.push(this.visualizePoint(a,n));return cr(r)}sortUniqueHints(e){return e}_getUniqueHints(e){const n=[];for(const i of e){let s=!0;for(const r of n)if(i.equals(r)){s=!1;break}s&&n.push(i)}return n}}class yo extends _o{sortUniqueHints(e){return e.sort((n,i)=>(i instanceof N?i.length:0)-(n instanceof N?n.length:0))}visualizeIntersectionPoint(e,n){const{spatialReference:i,view:s}=n,r=et();return Le(new di({view:s,primitive:"circle",geometry:vi(e.intersectionPoint,i),elevationInfo:e.isDraped?Xi:C,size:20,outlineSize:2,color:r.intersectionPointColor,outlineColor:r.intersectionPointOutlineColor,pixelSnappingEnabled:!1}))}visualizePoint(e,n){const{view:i,spatialReference:s}=n,r=et(),a=pe(e.point,e.domain,n);return Le(new di({view:i,primitive:"circle",geometry:vi(a,s),elevationInfo:Ot(e,n),size:20,outlineSize:2,color:r.pointColor,outlineColor:r.pointOutlineColor,pixelSnappingEnabled:!1}))}visualizeLine(e,n){const{view:i,spatialReference:s}=n,r=et(),a=pe(e.lineStart,e.domain,n),l=pe(e.lineEnd,e.domain,n);return Le(this._createLineSegmentHint(e.type,a,l,s,Ot(e,n),i,r,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,n){const{view:i,spatialReference:s}=n,r=et(),{isDraped:a}=e,l=Ot(e,n),o=pe(e.lineStart,e.domain,n),d=pe(e.lineEnd,e.domain,n),c=ye(o,s,l,i,a),p=ye(d,s,l,i,a),m=Gi(p,c,p,.5),f=new uo({view:i,attached:!1,offset:O.parallelLineHintOffset,length:O.parallelLineHintLength,width:O.parallelLineHintWidth,color:r.parallelSignColor,location:m,renderOccluded:a?x.OccludeAndTransparent:x.Opaque,isDraped:a,renderGroup:rn.SnappingHint});return f.setDirectionFromPoints(c,m),f.attached=!0,Le(f)}visualizeRightAngleQuad(e,n){const{view:i,spatialReference:s}=n,r=et(),a=Ot(e,n),{isDraped:l}=e,o=pe(e.previousVertex,e.domain,n),d=pe(e.centerVertex,e.domain,n),c=pe(e.nextVertex,e.domain,n),p=ye(o,s,a,i,l),m=ye(d,s,a,i,l),f=ye(c,s,a,i,l);return Le(new aa({view:i,attached:!0,color:l?r.rightAngleColorDraped:r.rightAngleColor,renderOccluded:l?x.OccludeAndTransparent:x.Transparent,outlineRenderOccluded:l?x.OccludeAndTransparent:x.Opaque,outlineColor:r.rightAngleOutlineColor,outlineSize:O.rightAngleHintOutlineSize,size:O.rightAngleHintSize,isDraped:l,geometry:{previous:p,center:m,next:f},renderGroup:rn.SnappingHint}))}_createLineSegmentHint(e,n,i,s,r,a,l,o=!1,d=!0,c=!0){const p=ye(n,s,r,a,o),m=ye(i,s,r,a,o),f=new lo({view:a,extensionType:X.FADED,start:p,end:m,isDraped:o,color:l.lineColor,renderOccluded:o?x.OccludeAndTransparent:x.Opaque,renderGroup:rn.SnappingHint});switch(e){case I.TARGET:f.width=O.lineHintWidthTarget,f.fadedExtensions={start:0,end:O.lineHintFadedExtensions};break;case I.REFERENCE_EXTENSION:f.width=O.lineHintWidthReference,f.fadedExtensions={start:0,end:0};break;case I.REFERENCE:f.width=O.lineHintWidthReference,f.fadedExtensions={start:d?O.lineHintFadedExtensions:0,end:c?O.lineHintFadedExtensions:0}}return f.attached=!0,f}}function et(t){const e=Z.toUnitRGBA(We()),n=[0,0,0,0];return{intersectionPointColor:n,intersectionPointOutlineColor:e,pointColor:n,pointOutlineColor:e,lineColor:e,lineOutlineColor:void 0,parallelSignColor:e,rightAngleColor:e,rightAngleColorDraped:Z.toUnitRGBA(We(.5)),rightAngleOutlineColor:e}}function pe(t,e,n){const i=ms(e,n);return i==null?t:po(t[0],t[1],i)}function Ot(t,e){return ms(t.domain,e)!=null?e.selfSnappingZ.elevationInfo:t.isDraped?Xi:C}function ms(t,{selfSnappingZ:e}){return t===D.SELF&&e!=null?e.value:null}function ye(t,e,n,i,s,r=g()){if(s){const a=i.basemapTerrain.overlayManager.renderer.spatialReference;At(t,e,r,a)}else Ur(t,e,n,i,r);return r}function vo(t,e,n,i,s){const r=ii(3*t.length),a=ii(r.length);t.forEach((d,c)=>{r[3*c]=d[0],r[3*c+1]=d[1],r[3*c+2]=d.length>2?d[2]:0});const l=ur(r,e,0,a,0,r,0,r.length/3,n,i,s),o=l!=null;return{numVertices:t.length,position:r,mapPositions:a,projectionSuccess:o,sampledElevation:l}}class So extends qi{constructor(e){super(e),this.view=null,this._renderOccluded=x.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=si([1,127/255,0,1]),this._size=11,this._outlineColor=si([0,0,0,.5]),this._outlineSize=1,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){Ne(e,this._color)||(ct(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){Ne(e,this._outlineColor)||(ct(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get _vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSizeScale:this.size,renderOccluded:this._renderOccluded}}get _vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}_updateMaterial(){this.attached&&this._vertexMaterial.setParameters(this._vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this._vertexOutlineMaterial.setParameters(this._vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(e==null||e.length===0)return[];const n=.5,i=.5,s=vo(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,hr.fromElevationInfo(this.elevationInfo)),r=[],a=s.numVertices,l=s.position;for(let o=0;o<a;++o){const d=ce(wo,l[3*o],l[3*o+1],l[3*o+2]),c=Pi(this._vertexMaterial,n,d),p=Pi(this._vertexOutlineMaterial,i,d);r.push({vertexGeometry:c,vertexOutlineGeometry:p})}return r}createGeometries(e){const n=this._createRenderGeometries();for(const{vertexGeometry:i,vertexOutlineGeometry:s}of n)e.addGeometry(i),e.addGeometry(s)}createExternalResources(){this._vertexMaterial=new li({...this._vertexMaterialParameters,writeDepth:!0,cullFace:ri.Back,screenSizeEnabled:!0}),this._vertexOutlineMaterial=new li({...this._vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:ri.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this._vertexMaterial=null,this._vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this._vertexMaterial),e(this._vertexOutlineMaterial)}}const wo=g();function Pi(t,e,n){return pr(t,e,16,16,{offset:n})}let Pe=class extends ue{constructor(t){super(t),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1}};u([h({constructOnly:!0})],Pe.prototype,"layer",void 0),u([h()],Pe.prototype,"enabled",void 0),u([h()],Pe.prototype,"updating",void 0),u([h()],Pe.prototype,"availability",void 0),Pe=u([H("esri.views.interactive.snapping.FeatureSnappingLayerSource")],Pe);const fs=Pe;let q=class extends ue{constructor(t){super(t),this.enabled=!1,this.enabledToggled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.featureSources=new Ye,this.distance=O.distance,this.touchSensitivityMultiplier=O.touchSensitivityMultiplier}get effectiveEnabled(){return this.enabledToggled?!this.enabled:this.enabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}};u([h()],q.prototype,"enabled",void 0),u([h()],q.prototype,"enabledToggled",void 0),u([h()],q.prototype,"selfEnabled",void 0),u([h()],q.prototype,"featureEnabled",void 0),u([h({type:Ye.ofType(fs)})],q.prototype,"featureSources",void 0),u([h()],q.prototype,"distance",void 0),u([h()],q.prototype,"touchSensitivityMultiplier",void 0),u([h({readOnly:!0})],q.prototype,"effectiveEnabled",null),u([h({readOnly:!0})],q.prototype,"effectiveSelfEnabled",null),u([h({readOnly:!0})],q.prototype,"effectiveFeatureEnabled",null),q=u([H("esri.views.interactive.snapping.SnappingOptions")],q);const gs=q;function Po(t,e){const n=new gs({enabled:!0,selfEnabled:!1,featureEnabled:!0,distance:e?.distance??O.distance,touchSensitivityMultiplier:e?.touchSensitivityMultiplier??O.touchSensitivityMultiplier});return{...S(()=>t.map?.allLayers?.toArray()??[],i=>{n.featureSources=new Ye(i.map(s=>new fs({layer:s,enabled:!0})))},Gt),options:n}}function Pn({start:t,end:e,type:n},i,s){const r=[],a=re(Te,e,t),l=re(Xe,t,i),o=ut(a),d=2*gt(a,l),c=d*d-4*o*(ut(l)-s*s);if(c===0){const p=-d/(2*o);(n===te.PLANE||p>=0)&&r.push(rt(ee(),t,a,p))}else if(c>0){const p=Math.sqrt(c),m=(-d+p)/(2*o);(n===te.PLANE||m>=0)&&r.push(rt(ee(),t,a,m));const f=(-d-p)/(2*o);(n===te.PLANE||f>=0)&&r.push(rt(ee(),t,a,f))}return r}function xn(t,e){const n=t.start,i=t.end,s=re(Te,i,n),r=ce(Xe,-s[1],s[0],0),a=e.start,l=e.end,o=T(kn,l,a),d=R(o,r),c=ce(Ss,n[0],n[1],0),p=T(ws,c,a),m=R(p,r);if(Math.abs(d)<K)return[];const f=J(Ps,a,o,m/d);if(e.type===F.RAY){const v=T(Ut,f,a);if(R(v,o)<-K)return[]}if(t.type===te.HALF_PLANE){const v=mr(Ut,f,n);if(gt(v,s)<-K)return[]}return[ge(f)]}function bn(t,e){return Mn(qt(jn,e[2],t),e)}function _s(t,e){const i=vs(qt(jn,0,t),qt(Mo,0,e)),s=[];for(const r of i)s.push(fr(r));return s}function ys(t,e){return Nn(t,qt(jn,t[2],e))}function xo(t,e,n){const i=re(Te,t,e),s=n/gr(i),r=rt(g(),e,i,s);return r[2]=t[2],r}function Nn(t,{start:e,end:n,type:i}){const s=T(Te,t,e),r=T(Xe,n,e),a=R(s,r)/R(r,r);return J(g(),e,r,i===F.RAY?Math.max(a,0):a)}function xi({start:t,end:e,type:n},i,s){const r=[],a=Be(Te,e,t),l=re(Xe,t,i),o=ut(a),d=2*gt(a,l),c=d*d-4*o*(ut(l)-s*s);if(c===0){const p=-d/(2*o);(n===F.LINE||p>=0)&&r.push(J(g(),t,a,p))}else if(c>0){const p=Math.sqrt(c),m=(-d+p)/(2*o);(n===F.LINE||m>=0)&&r.push(J(g(),t,a,m));const f=(-d-p)/(2*o);(n===F.LINE||f>=0)&&r.push(J(g(),t,a,f))}return r}function vs(t,e){const n=t.start,i=t.end,s=e.start,r=e.end,a=T(Te,i,n),l=T(Xe,r,s),o=T(kn,s,n),d=ie(Ss,a,l),c=R(o,d);if(!_n(c,0,K))return[];const p=yn(d);if(_n(p,0,K))return[];const m=ie(ws,o,l),f=R(m,d)/p,v=J(Ps,n,a,f);if(t.type===F.RAY){const y=T(Ut,v,n);if(R(a,y)<-K)return[]}if(e.type===F.RAY){const y=T(Ut,v,s);if(R(l,y)<-K)return[]}return[ge(v)]}function Mn({start:t,end:e,type:n},i){const s=T(Te,i,t),r=T(Xe,e,t),a=ie(kn,r,s);if(yn(a)/yn(r)<K)switch(n){case F.LINE:return[ge(i)];case F.RAY:return R(r,s)<-K?[]:[ge(i)]}return[]}function bi(t,e,n){return _n($e(n,t),e*e,K)?[ge(n)]:[]}function qt(t,e,{start:n,end:i,type:s}){return ce(t.start,n[0],n[1],e),ce(t.end,i[0],i[1],e),t.type=bo[s],t}var te;(function(t){t[t.PLANE=0]="PLANE",t[t.HALF_PLANE=1]="HALF_PLANE"})(te||(te={}));const bo={[te.PLANE]:F.LINE,[te.HALF_PLANE]:F.RAY},K=1e-6,Te=g(),Xe=g(),kn=g(),Ss=g(),ws=g(),Ps=g(),Ut=g(),jn={start:g(),end:g(),type:F.LINE},Mo={start:g(),end:g(),type:F.LINE};class Re{intersect(e){return Oo(this,e)}}class Eo extends Re{constructor(e){super(),this.point=e}equals(e){return He(e)&&M(this.point,e.point)}closestTo(){return ps(this.point)}}class xs extends Re{constructor(e,n,i){super(),this.start=e,this.end=n,this.type=i,this.lineLike={start:this.start,end:this.end,type:this.type}}equals(e){return be(e)&&this.type===e.type&&M(this.start,e.start)&&M(this.end,e.end)}closestTo(e){const n=Nn(e,this.lineLike);return n}}class $o extends xs{constructor(e,n){super(e,n,F.LINE)}}class Qt extends Re{constructor(e,n,i){super(),this.intersection=e,this.first=n,this.second=i}equals(e){return e instanceof Qt&&this.first.equals(e.first)&&this.second.equals(e.second)}closestTo(){return ps(this.intersection)}}class lt extends Re{constructor(e,n,i){super(),this.basePoint=e,this.first=n,this.second=i}equals(e){return e instanceof lt&&this.first.equals(e.first)&&this.second.equals(e.second)}closestTo(e){const n=this.basePoint;return j(n[0],n[1],e[2])}}class bs extends Re{constructor(e,n){super(),this.center=e,this.radius=n}equals(e){return Ve(e)&&this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius}closestTo(e){const n=xo(e,this.center,this.radius);return n}}class qn extends Re{constructor(e,n,i){super(),this.start=e,this.end=n,this.type=i,this.planeLike={start:e,end:n,type:i}}equals(e){return Me(e)&&this.type===e.type&&M(this.start,e.start)&&M(this.end,e.end)}closestTo(e){return ys(e,this.planeLike)}closestEndTo(e){const{start:n,end:i}=this;return Math.sign(gt(re(Ro,i,n),re(Do,e,n)))>0?i:n}}class Ms extends qn{constructor(e,n){super(e,n,te.HALF_PLANE)}}class Es extends qn{constructor(e,n){super(e,n,te.PLANE)}}class $s extends Re{constructor(e,n,i){super(),this.start=e,this.end=n,this.getZ=i,this.planeLike={start:e,end:n,type:te.PLANE}}equals(e){return Ee(e)&&M(this.start,e.start)&&M(this.end,e.end)&&this.getZ===e.getZ}closestTo(e){return Co(this,e)}addIfOnTheGround(e,n){for(const i of n){const s=this.getZ(i[0],i[1],i[2])??0;Math.abs(i[2]-s)<K&&(i[2]=s,e.push(i))}}}function Co(t,e){const n=ys(e,t.planeLike);return n[2]=t.getZ(e[0],e[1],e[2])??Cs,n}function Oo(t,e){let n=[];if(He(t)){const{point:i}=t;be(e)?n=Mn(e.lineLike,i):Ve(e)?n=bi(e.center,e.radius,i):Me(e)?n=bn(e.planeLike,i):Ee(e)&&(n=tt(e,t))}else if(be(t)){const{lineLike:i}=t;He(e)?n=Mn(i,e.point):be(e)?n=vs(i,e.lineLike):Ve(e)?n=xi(i,e.center,e.radius):Me(e)?n=xn(e.planeLike,i):Ee(e)&&(n=tt(e,t))}else if(Ve(t)){const{center:i,radius:s}=t;if(be(e))n=xi(e.lineLike,i,s);else if(He(e))n=bi(i,s,e.point);else{if(Me(e))return Pn(e.planeLike,i,s).map(r=>new lt(r,t,e));Ee(e)&&(n=tt(e,t))}}else if(Me(t)){const{planeLike:i}=t;if(Me(e))return _s(i,e.planeLike).map(s=>new lt(s,t,e));if(He(e))n=bn(i,e.point);else if(be(e))n=xn(i,e.lineLike);else{if(Ve(e))return Pn(i,e.center,e.radius).map(s=>new lt(s,t,e));Ee(e)&&(n=tt(e,t))}}else Ee(t)&&(n=tt(t,e));return To(n,t,e)}function tt(t,e){const{planeLike:n,getZ:i}=t,s=[];if(He(e))t.addIfOnTheGround(s,bn(n,e.point));else if(be(e))t.addIfOnTheGround(s,xn(n,e.lineLike));else if(Ve(e))for(const[r,a]of Pn(n,e.center,e.radius)){const l=i(r,a,0);l!=null&&s.push(j(r,a,l))}else if(Me(e)||Ee(e))for(const[r,a]of _s(n,e.planeLike)){const l=i(r,a,0)??Cs;s.push(j(r,a,l))}return s}function To(t,e,n){return t.map(i=>new Qt(i,e,n))}function He(t){return t instanceof Eo}function be(t){return t instanceof xs}function Ve(t){return t instanceof bs}function Me(t){return t instanceof qn}function Ee(t){return t instanceof $s}const Ro=ee(),Do=ee(),Cs=0;class Qe{constructor(e,n,i,s){this.targetPoint=e,this.constraint=n,this.isDraped=i,this.domain=s}}class Un extends Qe{constructor({targetPoint:e,objectId:n,constraint:i,isDraped:s}){super(e,i,s,D.FEATURE),this.objectId=n}}class Ao extends Un{constructor(e){super({...e,isDraped:!0,constraint:new $s(e.edgeStart,e.edgeEnd,e.getGroundElevation)})}get hints(){return[new N(I.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}}class Lo extends Un{constructor(e){super({...e,constraint:new $o(e.edgeStart,e.edgeEnd)})}get hints(){return[new N(I.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}}class Os extends Qe{constructor({targetPoint:e,constraint:n,previousVertex:i,otherVertex:s,otherVertexType:r,objectId:a,isDraped:l}){super(e,n,l,D.SELF),this.previousVertex=i,this.otherVertex=s,this.otherVertexType=r,this.objectId=a}get hints(){const e=this.previousVertex,n=this.otherVertexType===Ze.CENTER?this.otherVertex:this.targetPoint,i=this.otherVertexType===Ze.CENTER?this.targetPoint:this.otherVertex;return[new N(I.TARGET,n,i,this.isDraped,this.domain),new N(I.REFERENCE,e,n,this.isDraped,this.domain),new vt(this.previousVertex,n,i,this.isDraped,this.domain)]}}var Ze;(function(t){t[t.NEXT=0]="NEXT",t[t.CENTER=1]="CENTER"})(Ze||(Ze={}));let ae=class extends Cn{get updating(){return _r(this.snappingSources,({snappingSource:t})=>t.updating)||this.updatingHandles.updating}get snappingSources(){const t=this._get("snappingSources")||new Map,e=new Map;if(this.options!=null&&this.options.featureSources!=null)for(const n of this.options.featureSources.items){const i=n.layer.uid,s=t.get(i);if(s){t.delete(i),e.set(i,s);continue}if(!n.layer.loaded){this.updatingHandles.addPromise(n.layer.load());continue}const r=this._createSourceInfo(n);r!=null&&e.set(i,r)}for(const[,n]of t)n.destroy();return e}constructor(t){super(t),this.options=null,this._domain=D.FEATURE,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){this.updatingHandles.add(()=>this.snappingSources,()=>this.notifyChange("updating"),Ue),this.view!=null&&this.handles.add([this.view.on("layerview-create",t=>this._updateLayerView(t.layer,t.layerView)),this.view.on("layerview-destroy",t=>this._updateLayerView(t.layer,null))])}_updateLayerView(t,e){for(const[,n]of this.snappingSources)n.snappingSource.layerSource.layer===t&&(n.layerView=e)}destroy(){this._set("options",null);for(const[,t]of this.snappingSources)t.destroy()}async fetchCandidates(t,e,n,i){if(!(e&this._domain&&this.options!=null&&this.options.effectiveFeatureEnabled))return[];const s=[],r=this._computeScreenSizeDistanceParameters(t,n),a={distance:r,mode:this.view?.type??"2d",point:t,coordinateHelper:n.coordinateHelper,...this._types};for(const[,{snappingSource:o,layerView:d}]of this.snappingSources)!o.layerSource.enabled||d!=null&&d.suspended||s.push(o.fetchCandidates(a,i).then(c=>c.filter(p=>!this._candidateIsExcluded(o,p,n.excludeFeature))));const l=(await yr(s)).flat();return this._addRightAngleCandidates(l,t,r,n),vr(i),Fn(t,l),l}_addRightAngleCandidates(t,e,n,i){const s=i.vertexHandle!=null?i.vertexHandle.rightEdge?.rightVertex?.pos:i.editGeometryOperations!=null&&i.editGeometryOperations.data.type==="polygon"?i.editGeometryOperations.data.components[0]?.getFirstVertex()?.pos:null,r=i.vertexHandle!=null?i.vertexHandle.leftEdge?.leftVertex?.pos:i.editGeometryOperations!=null?i.editGeometryOperations.data.components[0]?.getLastVertex()?.pos:null,{view:a}=this,l=b(s,a,i),o=b(r,a,i),d=t.length;for(let c=0;c<d;c++)this._addRightAngleCandidate(t[c],o,e,n,t),this._addRightAngleCandidate(t[c],l,e,n,t)}_addRightAngleCandidate(t,e,n,i,s){if(e==null||!Ho(t))return;const r=t.constraint.closestTo(e),a=(r[0]-n[0])/i.x,l=(r[1]-n[1])/i.y,{start:o,end:d}=t.constraint;if(a*a+l*l<=1){const c=new Os({targetPoint:r,otherVertex:e,otherVertexType:Ze.NEXT,previousVertex:$e(r,o)>$e(r,d)?o:d,constraint:new Ms(e,r),objectId:t.objectId,isDraped:t.isDraped});s.push(c)}}_computeScreenSizeDistanceParameters(t,e){let n=this.options!=null?this.options.distance*(e.pointer==="touch"?this.options.touchSensitivityMultiplier:1):0;return this.view==null?{x:n,y:n,z:n,distance:n}:this.view.type==="2d"?(n*=this.view.resolution,{x:n,y:n,z:n,distance:n}):this._computeScreenSizeDistanceParameters3D(t,n,this.view,e)}_computeScreenSizeDistanceParameters3D(t,e,n,i){const{spatialReference:s}=i;n.renderCoordsHelper.toRenderCoords(t,s,Mi);const r=n.state.camera.computeScreenPixelSizeAt(Mi),a=r*n.renderCoordsHelper.unitInMeters/n.mapCoordsHelper.unitInMeters,l=e*a,o=z(t,s,C,n),d=o?dn(o,t,a,0,0,n,i):0,c=o?dn(o,t,0,a,0,n,i):0,p=o?dn(o,t,0,0,a,n,i):0;return{x:d===0?0:l/d,y:c===0?0:l/c,z:p===0?0:l/p,distance:r*e}}get _types(){return{returnEdge:!0,returnVertex:!0}}_candidateIsExcluded(t,e,n){if(n==null)return!1;const i=this._getCandidateObjectId(e);if(i==null)return!1;const s=t.layerSource.layer;return s.type==="graphics"?n.uid===i:n.sourceLayer===s&&!(!n.attributes||!("objectIdField"in s))&&n.attributes[s.objectIdField]===i}_getCandidateObjectId(t){return t instanceof Un?t.objectId:null}_createSourceInfo(t){const e=this._createFeatureSnappingSourceType(t);if(e==null)return null;if("loading"in e)return this.updatingHandles.addPromise(e.loading.then(()=>{this.destroyed||this.notifyChange("snappingSources")})),null;const n=this.view!=null?this.view.allLayerViews.find(i=>i.layer===t.layer):null;return new zo(e.source,n)}_createFeatureSnappingSourceType(t){switch(t.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(t);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(t);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(t);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(t)}return null}_createFeatureSnappingSourceSceneLayer(t){const{view:e}=this;if(e==null||e.type!=="3d")return null;const n=this._getSourceModule("scene");return n.module!=null?{source:new n.module.SceneLayerSnappingSource({layerSource:t,view:e})}:{loading:n.loader}}_createFeatureSnappingSourceFeatureLayer(t){switch(t.layer.source?.type){case"feature-layer":case"oriented-imagery":{const e=this._getSourceModule("featureService");return e.module!=null?{source:new e.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:t})}:{loading:e.loader}}case"memory":case"csv":case"geojson":case"wfs":{if(t.layer.geometryType==="mesh")return null;const e=this._getSourceModule("featureCollection");return e.module!=null?{source:new e.module.FeatureCollectionSnappingSource({layerSource:t,view:this.view})}:{loading:e.loader}}}return null}_createFeatureSnappingSourceGraphicsLayer(t){const e=this._getSourceModule("graphics");return e.module!=null?{source:new e.module.GraphicsSnappingSource({getGraphicsLayers:()=>[t.layer],spatialReference:this.spatialReference,view:this.view,layerSource:t})}:{loading:e.loader}}_createFeatureSnappingSourceMapNotesLayer(t){const e=this._getSourceModule("notes");return e.module!=null?{source:new e.module.GraphicsSnappingSource({getGraphicsLayers:()=>t.layer.sublayers!=null?t.layer.sublayers.toArray():[],spatialReference:this.spatialReference,view:this.view,layerSource:t})}:{loading:e.loader}}_getSourceModule(t){const e=this._sourceModules[t];if(e.loader==null){const n=this._loadSourceModule(t).then(i=>{e.module=i});return e.loader=n,{module:e.module,loader:n}}return{module:e.module,loader:e.loader}}_loadSourceModule(t){const e=this.updatingHandles;switch(t){case"featureService":return e.addPromise(wt(()=>import("./FeatureServiceSnappingSource.c3a5f209.js"),["assets/FeatureServiceSnappingSource.c3a5f209.js","assets/index.da161cf1.js","assets/index.8db76e31.css","assets/elevationInfoUtils.d710f6c5.js","assets/queryEngineUtils.847a1e82.js","assets/VertexSnappingCandidate.9b872bd0.js","assets/TileTreeDebugger.f46f3b0e.js","assets/LineVisualElement.0ee7ffd4.js","assets/LengthDimension.4b10a477.js","assets/Segment.b33fc9b3.js","assets/unitFormatUtils.42a6eb3a.js","assets/analysisViewUtils.8aae6db1.js","assets/ImageMaterial.1905961e.js","assets/Factory.312f3b3e.js","assets/RightAngleQuadVisualElement.408eff27.js","assets/VisualElementResources.f6c3d94a.js","assets/PointVisualElement.eb5b4fbb.js","assets/EditGeometryOperations.3139b272.js","assets/dehydratedFeatureComparison.d41240fc.js"]));case"featureCollection":return e.addPromise(wt(()=>import("./FeatureCollectionSnappingSource.0230bb37.js"),["assets/FeatureCollectionSnappingSource.0230bb37.js","assets/index.da161cf1.js","assets/index.8db76e31.css","assets/elevationInfoUtils.d710f6c5.js","assets/queryEngineUtils.847a1e82.js","assets/VertexSnappingCandidate.9b872bd0.js","assets/symbologySnappingCandidates.f2dfaf9f.js","assets/LineVisualElement.0ee7ffd4.js","assets/LengthDimension.4b10a477.js","assets/Segment.b33fc9b3.js","assets/unitFormatUtils.42a6eb3a.js","assets/analysisViewUtils.8aae6db1.js","assets/ImageMaterial.1905961e.js","assets/Factory.312f3b3e.js","assets/RightAngleQuadVisualElement.408eff27.js","assets/VisualElementResources.f6c3d94a.js","assets/PointVisualElement.eb5b4fbb.js","assets/EditGeometryOperations.3139b272.js","assets/dehydratedFeatureComparison.d41240fc.js"]));case"graphics":case"notes":return e.addPromise(wt(()=>import("./GraphicsSnappingSource.4321a3ad.js"),["assets/GraphicsSnappingSource.4321a3ad.js","assets/index.da161cf1.js","assets/index.8db76e31.css","assets/normalizeUtilsSync.ade119bb.js","assets/normalizeUtilsCommon.87227ae2.js","assets/FeatureStore.e774d369.js","assets/BoundsStore.13c0920f.js","assets/PooledRBush.b9188fbe.js","assets/quickselect.b8e0afc3.js","assets/optimizedFeatureQueryEngineAdapter.b17e3ee2.js","assets/centroid.66ea1f85.js","assets/QueryEngine.f42b4b13.js","assets/normalizeUtils.54c24a4d.js","assets/WhereClause.c0b1e923.js","assets/executionError.10e29c03.js","assets/json.7bed7e43.js","assets/QueryEngineCapabilities.a6a6a20b.js","assets/utils.8873e24e.js","assets/generateRendererUtils.e8dfecdf.js","assets/FieldsIndex.09813895.js","assets/elevationInfoUtils.d710f6c5.js","assets/queryEngineUtils.847a1e82.js","assets/VertexSnappingCandidate.9b872bd0.js","assets/symbologySnappingCandidates.f2dfaf9f.js","assets/LineVisualElement.0ee7ffd4.js","assets/LengthDimension.4b10a477.js","assets/Segment.b33fc9b3.js","assets/unitFormatUtils.42a6eb3a.js","assets/analysisViewUtils.8aae6db1.js","assets/ImageMaterial.1905961e.js","assets/Factory.312f3b3e.js","assets/RightAngleQuadVisualElement.408eff27.js","assets/VisualElementResources.f6c3d94a.js","assets/PointVisualElement.eb5b4fbb.js","assets/EditGeometryOperations.3139b272.js","assets/dehydratedFeatureComparison.d41240fc.js"]));case"scene":return e.addPromise(wt(()=>import("./SceneLayerSnappingSource.b71be9f5.js"),["assets/SceneLayerSnappingSource.b71be9f5.js","assets/index.da161cf1.js","assets/index.8db76e31.css","assets/VertexSnappingCandidate.9b872bd0.js","assets/LineVisualElement.0ee7ffd4.js","assets/LengthDimension.4b10a477.js","assets/Segment.b33fc9b3.js","assets/unitFormatUtils.42a6eb3a.js","assets/elevationInfoUtils.d710f6c5.js","assets/analysisViewUtils.8aae6db1.js","assets/ImageMaterial.1905961e.js","assets/Factory.312f3b3e.js","assets/RightAngleQuadVisualElement.408eff27.js","assets/VisualElementResources.f6c3d94a.js","assets/PointVisualElement.eb5b4fbb.js","assets/EditGeometryOperations.3139b272.js","assets/dehydratedFeatureComparison.d41240fc.js"]))}}};u([h({constructOnly:!0})],ae.prototype,"spatialReference",void 0),u([h({constructOnly:!0})],ae.prototype,"view",void 0),u([h()],ae.prototype,"options",void 0),u([h({readOnly:!0})],ae.prototype,"updating",null),u([h({readOnly:!0})],ae.prototype,"snappingSources",null),ae=u([H("esri.views.interactive.snapping.FeatureSnappingEngine")],ae);class zo{constructor(e,n){this.snappingSource=e,this.layerView=n,this.handles=new Wt;const i=this.snappingSource.layerSource.layer;if("refresh"in i){const s=i;this.handles.add(s.on("refresh",()=>e.refresh()))}this.handles.add([S(()=>e.updating,s=>e.layerSource.updating=s,G),S(()=>e.availability,s=>e.layerSource.availability=s,G)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}}function Ho(t){return(t instanceof Lo||t instanceof Ao)&&!Vo(t)}function Vo({constraint:{start:t,end:e}}){const n=gn(t,e),i=$e(t,e);return n<Sr()||i/n<Fo}function dn(t,e,n,i,s,r,{spatialReference:a}){const l=L(Go,e);l[0]+=n,l[1]+=i,l[2]+=s;const o=z(l,a,C,r);return o?fo(o,t):1/0}const Mi=g(),Go=g(),Fo=1e-4;class Kt{constructor(e,n){this.view=e,this.options=n,this.squaredShortLineThreshold=O.shortLineThreshold*O.shortLineThreshold}snap(e,n){return n.vertexHandle!=null?n.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(e,n):this.snapNewVertex(e,n)}edgeExceedsShortLineThreshold(e,n){return this.exceedsShortLineThreshold(b(e.leftVertex.pos,this.view,n),b(e.rightVertex.pos,this.view,n),n)}exceedsShortLineThreshold(e,n,{spatialReference:i}){return this.squaredShortLineThreshold===0||Oe(z(n,i,C,this.view),z(e,i,C,this.view))>this.squaredShortLineThreshold}isVertical(e,n){return $e(e,n)<O.verticalLineThreshold}squaredProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:n}=this.options,i=e*n;return i*i}}class Io extends Qe{constructor({lineStart:e,lineEnd:n,targetPoint:i,isDraped:s}){super(i,new Es(e,n),s,D.SELF),this._referenceLineHint=new N(I.REFERENCE_EXTENSION,e,n,s,this.domain)}get hints(){return[this._referenceLineHint,new N(I.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.isDraped,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}}class No extends Kt{snapNewVertex(e,n){const i=n.editGeometryOperations.data.components[0],s=i.edges.length,r=[];if(s<1)return r;const{spatialReference:a}=n,l=z(e,a,C,this.view),{view:o}=this,d=i.edges[s-1];let c=d;do{if(this.edgeExceedsShortLineThreshold(c,n)){const p=jt(c,o,n);this._processCandidateProposal(p.left,p.right,e,l,n,r)}c=c.leftVertex.leftEdge}while(c&&c!==d);return r}snapExistingVertex(e,n){const i=[],s=n.vertexHandle,r=s.component;if(r.edges.length<2)return i;const{view:a}=this,{spatialReference:l}=n,o=z(e,l,C,a),d=s.leftEdge,c=s.rightEdge;d&&c&&this.edgeExceedsShortLineThreshold(d,n)&&this.edgeExceedsShortLineThreshold(c,n)&&this._processCandidateProposal(b(d.leftVertex.pos,a,n),b(c.rightVertex.pos,a,n),e,o,n,i);const p=r.edges[0];let m=p;do{if(m!==s.leftEdge&&m!==s.rightEdge&&this.edgeExceedsShortLineThreshold(m,n)){const f=jt(m,a,n);this._processCandidateProposal(f.left,f.right,e,o,n,i)}m=m.rightVertex.rightEdge}while(m&&m!==p);return i}_processCandidateProposal(e,n,i,s,r,a){const{spatialReference:l,pointer:o}=r,d=Nn(i,{start:e,end:n,type:F.LINE});Oe(s,z(d,l,C,this.view))<this.squaredProximityThreshold(o)&&a.push(new Io({lineStart:e,lineEnd:n,targetPoint:d,isDraped:r.elevationInfo?.mode==="on-the-ground"}))}}class ko extends Qe{constructor({referenceLine:e,lineStart:n,targetPoint:i,isDraped:s}){const r=ge(n),{left:a,right:l}=e;Be(r,zi(r,r,l),a),super(i,new Es(n,r),s,D.SELF),this._referenceLines=[{edge:e,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new N(I.TARGET,this.constraint.start,this.targetPoint,this.isDraped,this.domain),new Xt(this.constraint.start,this.targetPoint,this.isDraped,this.domain),...this._referenceLines.map(e=>new N(I.REFERENCE,e.edge.left,e.edge.right,this.isDraped,this.domain,e.fadeLeft,e.fadeRight))]}addReferenceLine(e){const n={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(i=>{M(e.right,i.edge.left)&&(i.fadeLeft=!1,n.fadeRight=!1),M(e.right,i.edge.right)&&(i.fadeRight=!1,n.fadeRight=!1),M(e.left,i.edge.right)&&(i.fadeRight=!1,n.fadeLeft=!1),M(e.left,i.edge.left)&&(i.fadeLeft=!1,n.fadeLeft=!1)}),this._referenceLines.push(n)}}class jo extends Kt{snapNewVertex(e,n){const i=n.editGeometryOperations.data.components[0],s=i.edges.length,r=i.vertices.length,a=[];if(s<2)return a;const{view:l}=this,o=z(e,n.spatialReference,C,l),d=b(i.vertices[r-1].pos,l,n),c=b(i.vertices[0].pos,l,n),p=i.edges[s-1];let m=p;do{if(this.edgeExceedsShortLineThreshold(m,n)){const f=jt(m,l,n);this._checkEdgeForParallelLines(f,d,e,o,n,a),this._checkEdgeForParallelLines(f,c,e,o,n,a)}m=m.leftVertex.leftEdge}while(m&&m!==p);return a}snapExistingVertex(e,n){const i=[],s=n.vertexHandle,r=s.component;if(r.edges.length<3)return i;const{view:a}=this,l=z(e,n.spatialReference,C,a),o=s.leftEdge,d=s.rightEdge,c=r.vertices[0],p=b(c.pos,a,n),m=r.vertices.length,f=r.vertices[m-1],v=b(f.pos,a,n),y=r.edges[0];let _=y;do{if(_!==o&&_!==d&&this.edgeExceedsShortLineThreshold(_,n)){const A=jt(_,a,n);o&&this._checkEdgeForParallelLines(A,b(o.leftVertex.pos,a,n),e,l,n,i),d&&this._checkEdgeForParallelLines(A,b(d.rightVertex.pos,a,n),e,l,n,i),s===c?this._checkEdgeForParallelLines(A,v,e,l,n,i):s===f&&this._checkEdgeForParallelLines(A,p,e,l,n,i)}_=_.rightVertex.rightEdge}while(_&&_!==y);return i}_checkEdgeForParallelLines(e,n,i,s,r,a){const l=e.left,o=e.right;if(an(ve,n,l,o),$e(ve,n)<O.parallelLineThreshold)return;an(ve,i,l,o,n);const{spatialReference:d,pointer:c}=r,p=j(ve[0],ve[1],i[2]);if(Oe(s,z(p,d,C,this.view))<this.squaredProximityThreshold(c)){if(this.isVertical(p,n)||this.isVertical(l,o)||this._parallelToPreviousCandidate(e,a))return;a.push(new ko({referenceLine:e,lineStart:n,targetPoint:p,isDraped:r.elevationInfo?.mode==="on-the-ground"}))}}_parallelToPreviousCandidate(e,n){const i=e.left,s=e.right;for(const r of n)if(an(ve,s,r.constraint.start,r.constraint.end,i),$e(ve,s)<O.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}}const ve=ee();class qo extends Kt{snapNewVertex(e,n){const i=n.editGeometryOperations.data.components[0],s=i.vertices.length,r=[];if(s<2)return r;const{view:a}=this,l=z(e,n.spatialReference,C,a),o=i.vertices[s-1];if(this.edgeExceedsShortLineThreshold(o.leftEdge,n)){const c=b(o.pos,a,n),p=b(o.leftEdge.leftVertex.pos,a,n);this._checkForSnappingCandidate(r,p,c,e,l,n)}const d=i.vertices[0];if(this.edgeExceedsShortLineThreshold(d.rightEdge,n)){const c=b(d.pos,a,n),p=b(d.rightEdge.rightVertex.pos,a,n);this._checkForSnappingCandidate(r,p,c,e,l,n)}return r}snapExistingVertex(e,n){const i=[],s=n.vertexHandle;if(s.component.vertices.length<3)return i;const{view:r}=this,a=z(e,n.spatialReference,C,r),l=s.leftEdge,o=s.rightEdge;if(l&&l.leftVertex.leftEdge){const d=l.leftVertex.leftEdge;if(this.edgeExceedsShortLineThreshold(d,n)){const c=b(d.rightVertex.pos,r,n),p=b(d.leftVertex.pos,r,n);this._checkForSnappingCandidate(i,p,c,e,a,n)}}if(o&&o.rightVertex.rightEdge){const d=o.rightVertex.rightEdge;if(this.edgeExceedsShortLineThreshold(d,n)){const c=b(d.leftVertex.pos,r,n),p=b(d.rightVertex.pos,r,n);this._checkForSnappingCandidate(i,p,c,e,a,n)}}return i}_checkForSnappingCandidate(e,n,i,s,r,a){const{spatialReference:l,pointer:o}=a;re(Tt,i,n);const d=ce(Uo,Tt[1],-Tt[0],0),c=gt(d,re(Tt,s,i))/ut(d),p=rt(ge(s),i,d,c);if(Oe(r,z(p,l,C,this.view))<this.squaredProximityThreshold(o)){if(this.isVertical(p,i)||this.isVertical(i,n))return;const m=J(g(),i,d,Math.sign(c));e.push(new Os({targetPoint:p,constraint:new Ms(i,m),previousVertex:n,otherVertex:i,otherVertexType:Ze.CENTER,isDraped:a.elevationInfo?.mode==="on-the-ground"}))}}}const Tt=ee(),Uo=g();class Wo extends Qe{constructor({targetPoint:e,point1:n,point2:i,isDraped:s}){super(e,new bs(Gi(g(),n,i,.5),.5*Fi(n,i)),s,D.SELF),this._p1=n,this._p2=i}get hints(){return[new N(I.REFERENCE,this.targetPoint,this._p1,this.isDraped,this.domain),new N(I.REFERENCE,this.targetPoint,this._p2,this.isDraped,this.domain),new vt(this._p1,this.targetPoint,this._p2,this.isDraped,this.domain)]}}class Zo extends Kt{snapNewVertex(e,n){const i=n.editGeometryOperations.data.components[0],s=[],r=i.vertices.length;if(n.editGeometryOperations.data.type!=="polygon"||r<2)return s;const{view:a}=this,l=i.vertices[0],o=i.vertices[r-1],d=b(l.pos,a,n),c=b(o.pos,a,n);return this._processCandidateProposal(d,c,e,n,s),s}snapExistingVertex(e,n){const i=[],s=n.vertexHandle,r=s.component;if(r.edges.length<2||n.editGeometryOperations.data.type==="polyline"&&(s.index===0||s.index===r.vertices.length-1))return i;const{view:a}=this,l=b(s.leftEdge.leftVertex.pos,a,n),o=b(s.rightEdge.rightVertex.pos,a,n);return this._processCandidateProposal(l,o,e,n,i),i}_processCandidateProposal(e,n,i,s,r){if(!this.exceedsShortLineThreshold(e,n,s))return;const a=wr(Bo,e,n,.5),l=.5*Fi(e,n),o=g();da(o,i,a,l),o[2]=i[2];const d=o,{spatialReference:c,pointer:p}=s,m=z(i,c,C,this.view);if(Oe(m,z(d,c,C,this.view))<this.squaredProximityThreshold(p)){if(this.isVertical(e,d)||this.isVertical(d,n))return;r.push(new Wo({targetPoint:d,point1:e,point2:n,isDraped:s.elevationInfo?.mode==="on-the-ground"}))}}}const Bo=ee();let ze=class extends ue{constructor(t){super(t),this.updating=!1,this._snappers=new Ye,this._domain=D.SELF}initialize(){this._snappers.push(new jo(this.view,this.options),new No(this.view,this.options),new qo(this.view,this.options),new Zo(this.view,this.options))}set options(t){this._set("options",t);for(const e of this._snappers)e.options=t}async fetchCandidates(t,e,n){if(!(e&this._domain&&this.options.effectiveSelfEnabled))return[];const i=[];for(const s of this._snappers.items)for(const r of s.snap(t,n))i.push(r);return Fn(t,i),i}};u([h({readOnly:!0})],ze.prototype,"updating",void 0),u([h({constructOnly:!0})],ze.prototype,"view",void 0),u([h()],ze.prototype,"options",null),ze=u([H("esri.views.interactive.snapping.SelfSnappingEngine")],ze);function Yo(t,e){return[new ze({view:t,options:e}),new ae({view:t,options:e,spatialReference:t.spatialReference})]}class Rt extends Qe{constructor(e,n,i,s){super(e,new Qt(e,n.constraint,i.constraint),s,D.ALL),this.first=n,this.second=i}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new Yt(this.targetPoint,this.isDraped,this.domain)]}}let Y=class extends Pr.EventedMixin(Cn){constructor(t){super(t),this.options=new gs,this.snappingEnginesFactory=Yo,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=oe.MAIN}initialize(){this.handles.add([S(()=>{const{effectiveFeatureEnabled:t,effectiveSelfEnabled:e,touchSensitivityMultiplier:n,distance:i}=this.options;return{effectiveFeatureEnabled:t,effectiveSelfEnabled:e,touchSensitivityMultiplier:n,distance:i}},()=>{this.doneSnapping(),this.emit("changed")},Ue),S(()=>this.options,t=>{for(const e of this._engines)e.options=t},Ue),S(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:t,snappingEnginesFactory:e})=>this._recreateEngines(t,e),G)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(t=>t.updating)}_recreateEngines(t,e){if(this._destroyEngines(),!t)return;const{view:n,options:i}=this;this._engines=e(n,i)}_destroyEngines(){for(const t of this._engines)t.destroy();this._engines=[]}get _squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:t,touchSensitivityMultiplier:e}=this.options,n=t*e;return n*n}get _squaredSatisfiesConstraintThreshold(){return O.satisfiesConstraintScreenThreshold*O.satisfiesConstraintScreenThreshold}async snap(t){return Xo(t)?this._snapMultiPoint(t):this._snapSinglePoint(t)}update(t){const{point:e,context:n}=t;this._removeVisualization();const i=this._currentMainCandidate;if(i==null)return e;const s=this._selectUpdateInput(t);if(s==null)return e;const{spatialReference:r}=n,a=ai(s,r);if(a==null)return e;const{view:l}=this,{elevationInfo:o,visualizer:d}=n,c=[],p=nt(a,l,n),m=i.constraint.closestTo(p);if(!this._arePointsWithinScreenThreshold(p,m,n))return this._resetSnappingState(),e;i.targetPoint=m,c.push(...i.hints);for(const f of this._currentOtherActiveCandidates)f.targetPoint=m,c.push(...f.hints);return d!=null&&this.handles.add(d.draw(c,{spatialReference:r,elevationInfo:Qo(n),view:l,selfSnappingZ:n.selfSnappingZ}),Dt),yi(m,l,{z:e.z,m:e.m,spatialReference:e.spatialReference,elevationInfo:o})}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:t,scenePoint:e}){switch(this._currentSnappedType){case oe.MAIN:return t;case oe.SCENE:return e}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=oe.MAIN}_removeVisualization(){this.handles.remove(Dt)}async _snapSinglePoint({point:t,context:e,signal:n}){const{view:i}=this,s=nt(t,i,e),r=await this._fetchCandidates(s,D.ALL,e,n);return this._createSnapResult(s,oe.MAIN,r,i,e,{z:t.z,m:t.m,spatialReference:t.spatialReference,elevationInfo:e.elevationInfo},n)}async _snapMultiPoint({point:t,scenePoint:e,context:n,signal:i}){const{view:s}=this,{coordinateHelper:r,spatialReference:a}=n;await xr(e.spatialReference,a);const l=ai(e,a),o=nt(l,s,n),d=await this._fetchCandidates(o,D.FEATURE,n,i);if(d.length>0){const m=await this._fetchCandidates(o,D.SELF,n,i);return this._createSnapResult(o,oe.SCENE,[...d,...m],s,n,{z:l.z,m:l.m,spatialReference:l.spatialReference,elevationInfo:n.elevationInfo},i)}const c=nt(t,s,n),p=await this._fetchCandidates(c,D.SELF,n,i);return this._createSnapResult(c,oe.MAIN,p,s,n,{z:r.hasZ()&&t.hasZ?t.z??0:void 0,m:r.hasM()&&t.hasM?t.m??0:void 0,spatialReference:t.spatialReference,elevationInfo:n.elevationInfo},i)}async _fetchCandidates(t,e,n,i){return(await Promise.all(this._engines.map(s=>s.fetchCandidates(t,e,n,i)))).flat()}_createSnapResult(t,e,n,i,s,r,a){return{get valid(){return!br(a)},apply:()=>{const{spatialReference:l}=s,{snappedPoint:o,hints:d}=this._processCandidates(t,e,n,s);return this._removeVisualization(),s.visualizer!=null&&this.handles.add(s.visualizer.draw(d,{spatialReference:l,elevationInfo:C,view:i,selfSnappingZ:s.selfSnappingZ}),Dt),yi(o,i,r)}}}_processCandidates(t,e,n,i){if(n.length<1)return this.doneSnapping(),{snappedPoint:t,hints:[]};this._currentSnappedType!==e&&this._resetSnappingState(),Fn(t,n);const s=this._currentMainCandidate;if(s!=null){const r=this._findOldConstraintInNewCandidates(s,n);if(r>=0){if(!(n[r]instanceof Rt))return this._intersectWithOtherCandidates(r,n,t,e,i);if(this._arePointsWithinScreenThreshold(t,s.targetPoint,i))return this._updateSnappingCandidate(s,e,n,i)}}return this._intersectWithOtherCandidates(0,n,t,e,i)}_findOldConstraintInNewCandidates(t,e){return t instanceof Rt?this._findOldCandidateIndex(e,t.first)>=0&&this._findOldCandidateIndex(e,t.second)>=0?0:-1:this._findOldCandidateIndex(e,t)}_intersectWithOtherCandidates(t,e,n,i,s){const{coordinateHelper:r}=s,a=e[t],l=[];for(let o=0;o<e.length;++o){if(o===t)continue;const d=e[o];for(const c of a.constraint.intersect(d.constraint)){const p=c.closestTo(a.targetPoint);l.push([new Rt(p,a,d,d.isDraped),this._squaredScreenDistance(n,p,r)])}}return l.length>0&&(l.sort((o,d)=>o[1]-d[1]),l[0][1]<this._squaredPointProximityThreshold(s.pointer))?this._updateSnappingCandidate(l[0][0],i,e,s):this._updateSnappingCandidate(a,i,e,s)}_updateSnappingCandidate(t,e,n,i){this.doneSnapping(),this._currentMainCandidate=t,this._currentSnappedType=e;const s=this._currentMainCandidate.targetPoint,r=[];r.push(...t.hints);for(const a of n){if(t instanceof Rt){if(a.constraint.equals(t.first.constraint)||a.constraint.equals(t.second.constraint))continue}else if(a.constraint.equals(t.constraint))continue;const l=a.constraint.closestTo(s);this._squaredScreenDistance(l,s,i.coordinateHelper)<this._squaredSatisfiesConstraintThreshold&&(a.targetPoint=s,this._currentOtherActiveCandidates.push(a),r.push(...a.hints))}return{snappedPoint:s,hints:r}}_squaredPointProximityThreshold(t){return t==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold}_arePointsWithinScreenThreshold(t,e,n){return this._squaredScreenDistance(t,e,n.coordinateHelper)<this._squaredPointProximityThreshold(n.pointer)}_squaredScreenDistance(t,e,n){return Oe(this._toScreen(t,n),this._toScreen(e,n))}_toScreen(t,e){return z(t,e.spatialReference,C,this.view)}_findOldCandidateIndex(t,e){let n=-1;for(let i=0;i<t.length;++i)if(e.constraint.equals(t[i].constraint)){n=i;break}return n}get test(){return{visualizationsActive:this.handles.has(Dt),engines:this._engines}}};var oe;u([h({constructOnly:!0})],Y.prototype,"view",void 0),u([h()],Y.prototype,"options",void 0),u([h({readOnly:!0})],Y.prototype,"updating",null),u([h()],Y.prototype,"snappingEnginesFactory",void 0),u([h()],Y.prototype,"_engines",void 0),u([h()],Y.prototype,"_squaredMouseProximityTreshold",null),u([h()],Y.prototype,"_squaredTouchProximityThreshold",null),u([h()],Y.prototype,"_squaredSatisfiesConstraintThreshold",null),Y=u([H("esri.views.interactive.snapping.SnappingManager")],Y),function(t){t[t.MAIN=0]="MAIN",t[t.SCENE=1]="SCENE"}(oe||(oe={}));const Dt="visualization-handle";function Xo(t){return t.scenePoint!=null}function Qo({coordinateHelper:t,elevationInfo:e}){return t.hasZ()?C:e}const zt=new Map;function Ko(t){if(!zt.has(t)){const i=Po(t,{distance:10}),s=el(t,i.options);zt.set(t,{referenceCount:0,snappingManager:s,remove:()=>{i.remove(),s.destroy()}})}const e=zt.get(t);e.referenceCount++;const n=On(()=>Jo(t,e));return{snappingManager:e.snappingManager,...n}}function Jo(t,e){e.referenceCount--,e.referenceCount>0||Mr(()=>{e.referenceCount===0&&(e.remove(),zt.delete(t))})}function el(t,e){return new Y({view:t,options:e,snappingEnginesFactory:(n,i)=>[new ae({view:t,spatialReference:t.spatialReference,options:i})]})}class Ts{constructor(e){this.vertexHandle=null,this.excludeFeature=null,this.visualizer=null,this.selfSnappingZ=null,this.editGeometryOperations=e.editGeometryOperations,this.elevationInfo=e.elevationInfo,this.pointer=e.pointer,this.vertexHandle=e.vertexHandle,this.excludeFeature=e.excludeFeature,this.visualizer=e.visualizer,this.selfSnappingZ=e.selfSnappingZ}get coordinateHelper(){return this.editGeometryOperations.data.coordinateHelper}get spatialReference(){return this.coordinateHelper.spatialReference}}function tl({predicate:t=()=>!0,snappingManager:e,snappingContext:n,updatingHandles:i,useZ:s=!0}){const r=new Bi;if(e==null)return{snappingStep:[Ei,r],cancelSnapping:Ei};let a,l=null,o=null,d=null;const c=()=>{l=ht(l),e.doneSnapping(),o?.frameTask.remove(),o=null,a=Tn(a),d=null},p=nl(e,s,r);let m=null,f=null,v=null;return{snappingStep:[y=>{if(!t(y))return y;const{action:_}=y;if(_==="start"){const{info:A}=y,Jt=il(e.view);if(o=sl(n,y,Jt),o.context.selfSnappingZ=null,!s&&A!=null){const Ke=al(n.coordinateHelper,A.handle.component);Ke!=null&&(o.context.selfSnappingZ={value:Ke,elevationInfo:n.elevationInfo??C})}}if(o!=null){const{context:A,originalScenePos:Jt,originalPos:Ke}=o,{mapEnd:Wn,mapStart:Zn,scenePoints:As}=y,en=Rs(Ke,En(Wn,Zn)),Bn=En(Zn,Ke),Ls={...y,action:"update"},zs=o.context,tn=rl(Jt,As),Yn=e.update({point:en,scenePoint:tn,context:A});if(v=Yn,Ds(Wn,Yn,Bn,s),m=en,f=tn,_!=="end"){const{frameTask:Hs}=o;l==null&&(l=new AbortController),d=Vs=>{i.addPromise(vn(p({frameTask:Hs,event:Ls,context:zs,point:en,scenePoint:tn,delta:Bn,getLastState:()=>({point:m,scenePoint:f,updatePoint:Vs.forceUpdate?null:v})},l.signal)))},d({forceUpdate:!1}),a==null&&(a=S(()=>e.options.effectiveEnabled,()=>d?.({forceUpdate:!0})))}}return _==="end"&&c(),y},r],cancelSnapping:y=>(c(),y)}}function nl(t,e,n){return ki(async({frameTask:i,point:s,scenePoint:r,context:a,event:l,delta:o,getLastState:d},c)=>{const p=await i.schedule(()=>t.snap({point:s,scenePoint:r,context:a,signal:c}),c);if(p.valid){let m=await i.schedule(()=>p.apply(),c);const f=d();f.point!=null&&s!==f.point&&(m=t.update({point:f.point,scenePoint:f.scenePoint,context:a})),f.updatePoint!=null&&pa(m,f.updatePoint)||(Ds(l.mapEnd,m,o,e),n.execute(l))}})}function il(t){return t.type==="3d"?t.resourceController.scheduler.registerTask(Ii.SNAPPING):Ni}function sl(t,e,n){return{context:new Ts({editGeometryOperations:t.editGeometryOperations,elevationInfo:t.elevationInfo,pointer:t.pointer,vertexHandle:e.info!=null?e.info.handle:null,excludeFeature:t.excludeFeature,visualizer:t.visualizer}),originalPos:e.snapOrigin!=null?t.coordinateHelper.vectorToDehydratedPoint(e.snapOrigin):e.mapStart,originalScenePos:e.scenePoints!=null?e.scenePoints.sceneStart:null,frameTask:n}}function Rs(t,[e,n,i]){const s=Fe(t);return s.x+=e,s.y+=n,s.hasZ&&(s.z+=i),s}function rl(t,e){return t==null||e==null?null:Rs(t,En(e.sceneEnd,e.sceneStart))}function En(t,e){const n=t.hasZ&&e.hasZ?t.z-e.z:0;return[t.x-e.x,t.y-e.y,n]}function Ds(t,e,[n,i,s],r){t.x=e.x+n,t.y=e.y+i,r&&t.hasZ&&e.hasZ&&(t.z=e.z+s)}function al(t,e){if(!t.hasZ())return null;const n=e.vertices;let i=null;for(const s of n){const r=t.getZ(s.pos);if(i!=null&&r!=null&&Math.abs(r-i)>1e-6)return null;i==null&&(i=r)}return i}function Ei(t){return t}let xe=class extends ue{constructor(t){super(t),this.constrainResult=e=>e,this._snapPoints=null,this._frameTask=null,this._abortController=null,this._stagedPoint=null,this._snap=ki(async(e,n,i,s)=>{const r=this._frameTask;if(r==null)return;const a=await r.schedule(()=>n.snap({...e,context:i,signal:s}),s);a.valid&&await r.schedule(()=>{this.stagedPoint=a.apply(),e!==this._snapPoints&&this._snapPoints!=null&&(this.stagedPoint=n.update({...this._snapPoints,context:i}))},s)})}get stagedPoint(){return this._stagedPoint}set stagedPoint(t){this._stagedPoint=this.constrainResult(t)}initialize(){const t=this.view.type==="3d"?this.view?.resourceController?.scheduler:null;this._frameTask=t!=null?t.registerTask(Ii.SNAPPING):Ni}destroy(){this._abortController=ht(this._abortController),this._frameTask=Tn(this._frameTask)}update(t,e,n){this._snapPoints=t;const{point:i,scenePoint:s}=t,r=e.update({point:i,scenePoint:s,context:n});return this.stagedPoint=r,r}async snap(t,e,n){const{point:i,scenePoint:s}=t;return this.stagedPoint=e.update({point:i,scenePoint:s,context:n}),this._snapPoints=t,this._abortController==null&&(this._abortController=new AbortController),this._snap(t,e,n,this._abortController.signal)}async resnap(t,e){this._snapPoints!=null&&await this.snap(this._snapPoints,t,e)}abort(){this._abortController=ht(this._abortController),this._snapPoints=null}};u([h({constructOnly:!0})],xe.prototype,"view",void 0),u([h()],xe.prototype,"stagedPoint",null),u([h()],xe.prototype,"constrainResult",void 0),u([h()],xe.prototype,"_stagedPoint",void 0),xe=u([H("esri.views.interactive.snapping.SnappingOperation")],xe);let V=class extends Cn{constructor(t){super(t),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new Wt,this._getSnappingContext=io(i=>new Ts({elevationInfo:{mode:"absolute-height",offset:0},pointer:i,editGeometryOperations:new ca(new ua("point",ha(!0,!1,this.view.spatialReference))),visualizer:new yo}));const{view:e}=t;this._snappingManagerResult=Ko(e),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=cn(),this._focusedOffsetManipulatorMaterial=cn(),this._thinOffsetManipulatorMaterial=cn(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:Ft(2)}),this._constraintSnappingIndicator=new Se({view:e,attached:!0,width:1,color:Z.toUnitRGBA($.constraint.color),renderOccluded:x.OccludeAndTransparent,stipplePattern:Ft(5)});const n=Z.toUnitRGBA($.disabledPointIndicator.color);this._stagedStartIndicator=new So({view:e,attached:!1,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:t.view.renderCoordsHelper.spatialReference,color:n,size:2*$.disabledPointIndicator.radius,outlineSize:0,renderOccluded:x.OccludeAndTransparent})}initialize(){this._snappingOperation=new xe({view:this.view});const{color:t,contrastColor:e}=$.orientationManipulator,n=!this.view._stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result;this._orientationManipulatorTexture=ia(this.view.toolViewManager.textures,{accentColor:t,contrastColor:e,preMultiplyAlpha:n}),this._orientationManipulatorMaterial=new la({transparent:!0,writeDepth:!1,textureId:this._orientationManipulatorTexture.texture.id,renderOccluded:x.Opaque});const{computations:i}=this.analysisViewData;for(const s of i)this._addComputation(s);this.addHandles([i.on("after-add",s=>this._addComputation(s.item)),i.on("after-remove",s=>this._removeComputation(s.item))]),this.addHandles([S(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:s,stagedComputation:r})=>{if(r==null||s==null)return;const a=Fe(s,new Ie);this._applyPointUpdate(r,{endPoint:a})},Ue),S(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(s,r)=>{const{stagedDimension:a,selectedComputation:l,firstGrabbedManipulator:o}=s;if(a===r?.stagedDimension&&o===r?.firstGrabbedManipulator){for(const d of[l,r?.selectedComputation])if(d!=null){const c=this._computationManipulators.get(d);this._updateManipulators(d,c,s)}}else for(const[d,c]of this._computationManipulators)this._updateManipulators(d,c,s)},G),S(()=>this.analysis.style.lineSize,s=>{this._updateManipulatorStyle(s)},Gt),S(()=>this.view.state.camera,()=>{this._stagedComputation!=null&&this._updateStagedDimensionOffset(this._stagedComputation)}),S(()=>Er(this._stagedComputation,s=>{const r=s.elevationAlignedStartPoint,a=g();return r!=null&&this.view.renderCoordsHelper.toRenderCoords(r,a)?a:null}),s=>{s!=null?(this._stagedStartIndicator.vertices=[s],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),go(this,()=>{const s=this._activeComputation,r=this._stagedComputation;if(s==null||r!=null){const a=this.view.inputManager.latestPointerType??"mouse",l=this._getSnappingContext(a);this.updatingHandles.addPromise(vn(this._snappingOperation.resnap(this._snappingManager,l)))}if(s!=null){const{start:a,end:l}=this._computationManipulators.get(s);if(a.grabbing||l.grabbing){const o=a.grabbing?"start":"end",d=this._computeConstraint(s);oo(s,o,{constraint:d,view:this.view})}}})}destroy(){this._snappingOperation=dt(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose(),this._orientationManipulatorTexture.release()}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(this._stagedComputation!=null)return this._stagedComputation;const{selectedComputation:t}=this.analysisViewData;return this.hasGrabbedManipulators&&t!=null?t:null}get _stagedComputation(){const t=this._stagedDimension,e=this.analysisViewData.computations.at(-1);return t==null||e==null||e.dimension!==t?null:e}get _constraintHandles(){return[Rn(()=>this.analysisViewData.selectedComputation,t=>{t.previousConstraint=this._computeConstraint(t)},{...G,equals:Sn}),S(()=>{const t=this._activeComputation;if(t==null)return null;const{measureType:e,orientation:n}=t.dimension;return{measureType:e,orientation:n,computation:t}},(t,e)=>{if(t!=null&&e==null){const{measureType:n,orientation:i,computation:s}=t;switch(s.previousConstraint){case B.Horizontal:s.preConstraintProperties={measureType:E.Horizontal,orientation:0};break;case B.Vertical:s.preConstraintProperties={measureType:E.Vertical,orientation:0};break;case B.Direct:s.preConstraintProperties={measureType:E.Direct,orientation:i};break;default:s.preConstraintProperties={measureType:n,orientation:i}}}t==null&&e!=null&&(e.computation.preConstraintProperties=null)},Ue)]}get _snappingIndicatorHandles(){const t="snapping-indicator-event-handles";return[S(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:e,activeComputation:n})=>{const i=this._constraintSnappingIndicator;if(this.removeHandles(t),n!=null)if(n===e)i.attached=!0;else{const{start:s,end:r}=this._computationManipulators.get(n),a=()=>{i.attached=s.grabbing||r.grabbing};a(),this.addHandles([s.events.on("grab-changed",a),r.events.on("grab-changed",a)],t)}else i.attached=!1}),S(()=>{const e=this._activeComputation;return e!=null?{geometry:e.geometry,constraint:e.previousConstraint}:{}},({geometry:e,constraint:n})=>{const i=this._constraintSnappingIndicator;e!=null&&n!=null&&n!==B.Direct?(i.visible=!0,i.setGeometryFromSegment(e.directSegment)):i.visible=!1})]}removeStaged(){return this._stagedDimension!=null&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(t){const{_stagedDimension:e}=this;if(e==null){const n=this._onUnstagedClick(t);return this.analysis.dimensions.add(n),null}return this._onStagedClick(t),e}onPointerMove({mapPoint:t,pointerType:e}){if(e==="touch")return;const n=this._getSnappingContext(e);this.updatingHandles.addPromise(vn(this._snappingOperation.snap({point:t},this._snappingManager,n)))}onManipulatorSelectionChanged(){this.analysisViewData.selectedComputation!=null&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:t,pointerType:e}){let n=t;if(e==="mouse"){const s=this._getSnappingContext(e);n=this._snappingManager.update({point:t,context:s})}const i=new kr({startPoint:Fe(n,new Ie),endPoint:null,measureType:E.Horizontal});return this._stagedDimension=i,this._resetSnappingState(),i}_onStagedClick({mapPoint:t,pointerType:e}){const n=this._stagedComputation;if(n==null)return;let i=t;if(e==="mouse"){const r=this._getSnappingContext(e);i=this._snappingManager.update({point:t,context:r})}const s=Fe(i,new Ie);this._applyPointUpdate(n,{endPoint:s}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_addComputation(t){if(this._computationManipulators.has(t))return;const e=this._setupPointManipulator(t,{isStart:!0}),n=this._setupPointManipulator(t,{isStart:!1}),i=this._setupOffsetManipulator(t),s=this._setupHeadingManipulator(t),r=this._setupRotationManipulator(t),a=this._setupMeasureTypeManipulator(t,E.Direct),l=this._setupMeasureTypeManipulator(t,E.Horizontal),o=this._setupMeasureTypeManipulator(t,E.Vertical),d=new Ha({start:e,end:n,offset:i,heading:s,rotation:r,direct:a,horizontal:l,vertical:o});this._setupComputationToManipulatorsSync(t,d),this._computationManipulators.set(t,d),this.manipulators.addMany(d.values())}_removeComputation(t){const e=this._computationManipulators.get(t);if(e!=null){this._computationHandles.remove(t),this._computationManipulators.delete(t);for(const n of e.values())this.manipulators.remove(n)}}_setupComputationToManipulatorsSync(t,e){this._computationHandles.add([S(()=>t.geometry,()=>this._updateManipulators(t,e),{...G,equals:Sn})],t)}_setupPointManipulator(t,e){const{view:n}=this,{dimension:i}=t,s=Va(n,{metadata:i}),r=Ia(s,{isStart:e.isStart,createSnappingPipelineStep:a=>tl({snappingContext:this._getSnappingContext(a),snappingManager:this._snappingManager,updatingHandles:this.updatingHandles}),dimension:i,onUpdate:a=>this._applyPointUpdate(t,a),view:n});return this._computationHandles.add(r,t),s}_setupOffsetManipulator(t){const{view:e}=this,n=Ga(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:t.dimension}),i=Na(n,{computation:t,view:e});return this._computationHandles.add(i,t),n}_setupHeadingManipulator(t){const{view:e}=this,n=ui(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),i=ka(n,{computation:t,view:e});return this._computationHandles.add(i,t),n}_setupRotationManipulator(t){const{view:e}=this,n=ui(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),i=ja(n,{computation:t,view:e});return this._computationHandles.add(i,t),n}_setupMeasureTypeManipulator(t,e){const{view:n}=this,i=Fa(n,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:t.dimension}),s=Wa(i,{computation:t,manipulatorMeasureType:e,view:n});return this._computationHandles.add(s,t),i}_updateManipulators(t,e,n={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:i,selectedComputation:s,firstGrabbedManipulator:r}=n,{start:a,end:l,offset:o,heading:d,rotation:c}=e,p=s===t,m=mt(t),{dimension:f}=t;for(const _ of e.values()){const A=m&&i==null&&(r==null||_===r);_===o?(_.available=A,_.selected=p):_.available=A&&p}if(!m)return;this._computeConstraint(t)!=null?e.forEachMeasureTypeManipulator(_=>_.available=!1):e.manipulatorForMeasureType(f.measureType).available=!1;for(const _ of[d,c])f.measureType===E.Direct&&f.offset!==0||(_.available=!1);zn(t)?c.available=!1:d.available=!1;const{geometry:v}=t;a.renderLocation=v.directSegment.startRenderSpace,l.renderLocation=v.directSegment.endRenderSpace;const{renderCoordsHelper:y}=this.view;Za(o,v,y),d.available&&Ba(d,t,y),c.available&&Ya(c,t,y),e.forEachMeasureTypeManipulator((_,A)=>{_.available&&Ka(_,t,A,y)})}_updateManipulatorStyle(t){const e=no(t),n=Gn(t),i={lineSizePt:t,material:this._orientationManipulatorMaterial};for(const{offset:s,heading:r,rotation:a}of this._computationManipulators.values())s.radius=n/2,hi(r,i),hi(a,i);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:n})}_applyPointUpdate(t,e){const{view:n}=this,i=It(t);"startPoint"in e&&(i.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(i.elevationAlignedEndPoint=e.endPoint);const s=Nt(i,n.renderCoordsHelper);if(s==null)return;const r=this._computeConstraint({...i,geometry:s});hs(t,e,{...i,constraint:r,unconstrainedGeometry:s,view:n}),t===this._stagedComputation&&this._updateStagedDimensionOffset(t)}_updateStagedDimensionOffset(t){if(t.geometry==null)return;t.geometry.directSegment.eval(.5,$i);const e=this.view.state.camera.computeRenderPixelSizeAt($i);t.dimension.offset=$.initialOffsetPx*e}_computeConstraint(t){return ao(ro(t,this._snappingManager.options),this.view)}get testInfo(){const t=e=>this.analysisViewData.computations.find(n=>n.dimension===e);return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=x.Occlude,this.manipulators.forEach(({manipulator:e})=>{for(const{geometry:n}of e.renderObjects)n.material.setParameters({renderOccluded:x.Occlude})})},getManipulatorsForDimension:e=>this._computationManipulators.get(t(e)),getComputationForDimension:e=>t(e),getConstraintForDimension:e=>{const n=t(e);return n!=null?this._computeConstraint(n):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};function cn(){const{color:t}=$.offsetManipulator;return new le({color:Z.toUnitRGBA(t),width:1,renderOccluded:x.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0})}u([h({constructOnly:!0})],V.prototype,"analysis",void 0),u([h({constructOnly:!0})],V.prototype,"analysisViewData",void 0),u([h({constructOnly:!0})],V.prototype,"manipulators",void 0),u([h({constructOnly:!0})],V.prototype,"parentTool",void 0),u([h({constructOnly:!0,nonNullable:!0})],V.prototype,"view",void 0),u([h({readOnly:!0})],V.prototype,"updating",null),u([h()],V.prototype,"firstGrabbedManipulator",null),u([h()],V.prototype,"hasGrabbedManipulators",null),u([h()],V.prototype,"snappingOptions",null),u([h()],V.prototype,"_stagedDimension",void 0),u([h()],V.prototype,"_activeComputation",null),u([h()],V.prototype,"_stagedComputation",null),V=u([H("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],V);const $i=g();var Ge;(function(t){t.Ready="ready",t.Creating="creating",t.Created="created"})(Ge||(Ge={}));let U=class extends Kr{constructor(t){super(t),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=$.pointerMoveTimeoutMs,this._prevPointerMoveTimeout=null}initialize(){this._intersector=$r(this.view.state.viewingMode),this._intersector.options.store=Cr.MIN,this._lengthDimensionSubTool=new V({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([Le(this._lengthDimensionSubTool),On(()=>this._clearPointerMoveTimeout()),S(()=>this.state,t=>{t===Ge.Created&&this.finishToolCreation()},G),Rn(()=>this.firstGrabbedManipulator,t=>{this.selectedDimension=t.metadata},G),S(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),G)])}get state(){return this.analysis.dimensions.some(t=>t.type==="length")?this._activeSubTool!=null?Ge.Creating:Ge.Created:Ge.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(t){this.analysisViewData.selectedDimension=t}onInputEvent(t){switch(t.type){case"immediate-click":this._clickHandler(t);break;case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":if(Si.cancel===t.key){if(this._activeSubTool!=null&&this._activeSubTool.removeStaged())return void t.stopPropagation();this.active||(this.selectedDimension=null)}else Si.delete.includes(t.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){this._activeSubTool!=null&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(t){if(this.hasFocusedManipulators)return void t.stopPropagation();if(this._activeSubTool==null)return;const e=this._intersectScreen(t);e!=null&&(this.selectedDimension=this._activeSubTool.onClick({mapPoint:e,pointerType:t.pointerType}),t.stopPropagation())}_doubleClickHandler(t){this.active&&(this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(this._resetPointerMoveTimeout(),this._activeSubTool==null||this.hasFocusedManipulators)return;const e=this._intersectScreen(t);e!=null&&this._activeSubTool.onPointerMove({mapPoint:e,pointerType:t.pointerType})}_deleteKeyHandler(){this._activeSubTool!=null&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(t){const e=Or(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const n=this._intersector.results.min,i=w.get();return n.getIntersectionPoint(i)?this.view.renderCoordsHelper.fromRenderCoords(i,this.view.spatialReference):null}_removeSelected(){this.selectedDimension!=null&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=Tn(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(t=>{t.manipulator.state|=de}),this._prevPointerMoveTimeout=Tr.setTimeout(()=>{this.manipulators.forEach(t=>{t.manipulator.state&=~de})},this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:t=>{this._pointerMoveTimerMs=t,this._resetPointerMoveTimeout()}}}};u([h({constructOnly:!0})],U.prototype,"view",void 0),u([h({constructOnly:!0})],U.prototype,"analysis",void 0),u([h({readOnly:!0})],U.prototype,"state",null),u([h({readOnly:!0})],U.prototype,"updating",null),u([h({readOnly:!0})],U.prototype,"cursor",null),u([h({constructOnly:!0})],U.prototype,"analysisViewData",void 0),u([h()],U.prototype,"selectedDimension",null),u([h()],U.prototype,"automaticManipulatorSelection",void 0),u([h()],U.prototype,"_activeSubTool",void 0),u([h()],U.prototype,"_lengthDimensionSubTool",void 0),U=u([H("esri.views.3d.analysis.Dimension.DimensionTool")],U);class ol extends qi{constructor(e,n){super(e),this._hasExternalMaterial=!1,this._renderOccluded=x.OccludeAndTransparent,this._width=1,this._color=Ht(1,0,1,1),this._placement="end",this._markerPrimitive="arrow",this._material=n,this._hasExternalMaterial=n!=null,this.applyProps(e)}setGeometryFromSegment(e,n){const i=e.endRenderSpace;this.transform=Rr(ll,i),this._normal=n;const{points:s}=e.createRenderGeometry(i,this.view.renderCoordsHelper);this.geometry=[s]}get renderOccluded(){return this._material!=null?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(e){this._renderOccluded=e,this._material!=null&&this._material.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get normal(){return this._normal}set normal(e){this._normal=e,this.recreateGeometry()}get width(){return this._material!=null?this._material.parameters.width:this._width}set width(e){this._width=e,this._material!=null&&this._material.setParameters({width:e})}get color(){return this._material!=null?this._material.parameters.color:this._color}set color(e){this._color=Ai(e),this._material!=null&&this._material.setParameters({color:this._color})}get placement(){return this._material!=null?this._material.parameters.placement:this._placement}set placement(e){this._placement=e,this._material!=null&&this._material.setParameters({placement:this._placement})}get markerPrimitive(){return this._material?.parameters.markerPrimitive??this._markerPrimitive}set markerPrimitive(e){this._markerPrimitive=e,this._material!=null&&this._material.setParameters({markerPrimitive:e})}createExternalResources(){this._hasExternalMaterial||(this._material=new ji({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,markerPrimitive:this._markerPrimitive}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(e){for(const n of Dr(this.geometry,this.normal)){const i=Ar(this._material,n);e.addGeometry(i)}}forEachExternalMaterial(e){this._hasExternalMaterial||e(this._material)}}const ll=$n();class dl{set visible(e){for(const n of this._visualElements.values())n.attached=e}constructor(e){this.destroyed=!1,this._handles=new Wt,this._messages=null,this._labelSegment=new Ce;const{analysis:n,computation:i,view:s,messages:r}=e;this.analysis=n,this.computation=i,this.view=s,this._messages=r;const a=e.visible,l={view:s,attached:a},{fontSize:o,textColor:d,textBackgroundColor:c}=n.style;this._visualElements=new ml({marker:new ol(l,e.markerMaterial),dimension:new Se(l,e.dimensionLineMaterial),startOffset:new Se(l,e.offsetLineMaterial),endOffset:new Se(l,e.offsetLineMaterial),dimensionSmall:new Se(l,e.smallDimensionLineMaterial),startOffsetSmall:new Se(l,e.smallOffsetLineMaterial),endOffsetSmall:new Se(l,e.smallOffsetLineMaterial),label:new Wr({view:s,attached:a,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:se(o),textColor:d.clone(),backgroundColor:c.clone()})}),this._handles.add([S(()=>i.geometry,p=>{this.updateCameraDependentElements(s.state.camera,p,n.style),i.geometry!=null&&this._updateLines(i.geometry)},{...Gt,equals:Sn}),S(()=>i.length,p=>this._updateLabelContent(p),Gt)])}destroy(){this.destroyed=!0,this._handles=dt(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(e){const n=ci(ul,pt.Start,e.directSegment,e.dimensionSegment),i=ci(hl,pt.End,e.directSegment,e.dimensionSegment),s=this._visualElements;s.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),s.dimension.setGeometryFromSegment(e.dimensionSegment),s.startOffset.setGeometryFromSegment(n),s.endOffset.setGeometryFromSegment(i),s.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),s.startOffsetSmall.setGeometryFromSegment(n),s.endOffsetSmall.setGeometryFromSegment(i)}updateCameraDependentElements(e,n,i){const s=this._visualElements;if(n==null){for(const y of s.values())y.visible=!1;return}const r=e.computeScreenPixelSizeAt(n.dimensionSegment.eval(.5,pl)),a=Ma(n,r),l=a<(se(i.lineSize)*$.smallScreenLengthLineSizeFactor)**2,o=!l;s.marker.visible=o,s.dimension.visible=o,s.startOffset.visible=o,s.endOffset.visible=o,s.dimensionSmall.visible=l,s.startOffsetSmall.visible=l,s.endOffsetSmall.visible=l;const d=se(i.fontSize)*$.labels.minScreenLengthFontSizeFactor,{label:c}=s;if(c.visible=a>=d**2,!c.visible)return;const{dimensionSegment:p,primaryOffsetAxis:m}=n,{offset:f}=this.computation.dimension,v=(Math.sign(f)>=0?1:-1)*cl(i)*r;ya(this._labelSegment,p,m,v),c.updateLabelPosition()}updateLabelStyle(e){const{label:n}=this._visualElements;n.fontSize=se(e.fontSize),n.textColor=e.textColor,n.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:n}=this.computation;this._updateLabelContent(n)}_updateLabelContent(e){const{label:n}=this._visualElements;e!=null&&this._messages!=null?n.text=Zr(this._messages,e,e.unit):n.text=""}}function cl(t){return 1.5*se(t.fontSize)+$.labels.marginPx+se(t.lineSize/2)}const ul=new Ce,hl=new Ce,pl=g();class ml{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let me=class extends ue{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(t){super(t),this.loadingMessages=!1,this._messages=null,this._dimensionVisualizations=new Map,this._markerMaterial=new ji({width:1,anchor:Lr.Tip,color:Je,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:x.OccludeAndTransparent,markerPrimitive:"triangle"}),this._dimensionLineMaterial=new le({width:1,color:Je,renderOccluded:x.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters}),this._offsetLineMaterial=new le({width:1,color:Je,renderOccluded:x.OccludeAndTransparent,stipplePattern:Ft(5),stippleScaleWithLineWidth:!0}),this._smallDimensionLineMaterial=new le({width:1,color:Je,renderOccluded:x.OccludeAndTransparent}),this._smallOffsetLineMaterial=new le({width:1,color:Je,renderOccluded:x.OccludeAndTransparent,stipplePattern:Ft(5),stippleScaleWithLineWidth:!0})}initialize(){for(const e of this._lineMaterials())this.view._stage.add(e),this.addHandles(On(()=>{this.view._stage?.remove(e),e.dispose()}));const{computations:t}=this.analysisViewData;for(const e of t)this._addComputation(e);this.addHandles([t.on("change",({added:e,removed:n})=>{for(const i of n)this._removeComputation(i);for(const i of e)this._addComputation(i)}),S(()=>Z.toUnitRGBA(this.analysis.style.color),e=>{for(const n of this._lineMaterials())n.setParameters({color:e})},G),S(()=>this.analysis.style.lineSize,e=>{const n=se(e);this._markerMaterial.setParameters({width:n*$.markers.lineSizeFraction}),this._dimensionLineMaterial.setParameters({width:n,markerParameters:this._markerMaterial.parameters});const i=Math.max(n*$.offsetLine.lineSizeFraction,1);this._offsetLineMaterial.setParameters({width:i})},G),S(()=>({camera:this.view.state.camera,style:fl(this.analysis)}),({camera:e,style:n})=>{for(const[i,s]of this._dimensionVisualizations)s.updateCameraDependentElements(e,i.geometry,n),s.updateLabelStyle(n)}),S(()=>this.visible,e=>{for(const n of this._dimensionVisualizations.values())n.visible=e})]),this.addHandles([zr(()=>this._updateMessageBundle()),Rn(()=>!this.loadingMessages,()=>{for(const e of this._dimensionVisualizations.values())e.updateUnitsMessages(this._messages)},Ue)]),this._updateMessageBundle()}destroy(){this._dimensionVisualizations.forEach(t=>{t.destroy()}),this._dimensionVisualizations.clear()}get testInfo(){return{visualizations:Array.from(this._dimensionVisualizations.values()),disablePartialOcclusion:()=>{for(const t of this._lineMaterials())t.setParameters({renderOccluded:x.Occlude})}}}_addComputation(t){this._dimensionVisualizations.has(t)||this._dimensionVisualizations.set(t,new dl({analysis:this.analysis,computation:t,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages}))}_removeComputation(t){const e=this._dimensionVisualizations.get(t);e!=null&&(e.destroy(),this._dimensionVisualizations.delete(t))}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await Hr("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function fl(t){const{fontSize:e,lineSize:n,textColor:i,textBackgroundColor:s}=t.style;return{fontSize:e,lineSize:n,textBackgroundColor:s.clone(),textColor:i.clone()}}u([h({constructOnly:!0})],me.prototype,"analysisViewData",void 0),u([h({constructOnly:!0,nonNullable:!0})],me.prototype,"view",void 0),u([h()],me.prototype,"analysis",null),u([h()],me.prototype,"visible",null),u([h()],me.prototype,"loadingMessages",void 0),me=u([H("esri.views.3d.analysis.Dimension.DimensionVisualization")],me);let it=class extends ue{constructor(t){super(t),this.dimension=null,this.length=null}};u([h({constructOnly:!0,nonNullable:!0})],it.prototype,"dimension",void 0),u([h()],it.prototype,"length",void 0),it=u([H("esri.views.3d.analysis.LengthDimensionResult")],it);const gl=it;let W=class extends ue{constructor(t){super(t),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(t){const{dimension:e,...n}=t;return{result:new gl({dimension:e}),...n}}initialize(){this.addHandles([S(()=>this.dimension.startPoint,t=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(t),G),S(()=>this.dimension.endPoint,t=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(t),G)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};u([h({constructOnly:!0,nonNullable:!0})],W.prototype,"result",void 0),u([h({constructOnly:!0,nonNullable:!0})],W.prototype,"projectAndAlignPoint",void 0),u([h()],W.prototype,"dimension",null),u([h()],W.prototype,"length",null),u([h()],W.prototype,"geometry",void 0),u([h()],W.prototype,"unconstrainedGeometry",void 0),u([h()],W.prototype,"elevationAlignedStartPoint",void 0),u([h()],W.prototype,"elevationAlignedEndPoint",void 0),u([h()],W.prototype,"preConstraintProperties",void 0),u([h()],W.prototype,"previousConstraint",void 0),W=u([H("esri.views.3d.analysis.LengthDimensionComputation")],W);const _l=t=>{let e=class extends t{constructor(...n){super(...n),this.analysis=null,this.tool=null,this.selectedDimension=null,this.interactive=!1,this.visible=null}get results(){return new Ye}createLengthDimensions(n){throw new Error("Method not implemented.")}};return u([h({constructOnly:!0})],e.prototype,"view",void 0),u([h({constructOnly:!0,nonNullable:!0})],e.prototype,"analysis",void 0),u([h()],e.prototype,"tool",void 0),u([h({readOnly:!0})],e.prototype,"results",null),u([h()],e.prototype,"selectedDimension",void 0),u([h()],e.prototype,"interactive",void 0),u([h()],e.prototype,"visible",void 0),e=u([H("esri.views.analysis.DimensionAnalysisView")],e),e};let k=class extends _l(Gr(ue)){constructor(t){super(t),this.type="dimension-view-3d",this.tool=null,this.computations=new Ye,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=t=>{if(t==null)return null;const{spatialReference:e,elevationProvider:n}=this.view,i=Fr(t,e,n);return i==null&&Ir(this.analysis,t.spatialReference,Ti.getLogger(this)),i},this.addHandles([Jr(this,U),oi(()=>this.analysis.dimensions,"after-add",t=>this._onDimensionAdd(t.item),{onListenerAdd:t=>{for(const e of t)this._onDimensionAdd(e)},onListenerRemove:()=>{this._onDimensionsClear()}}),oi(()=>this.analysis.dimensions,"after-remove",t=>this._onDimensionRemove(t.item))]),this._analysisVisualization=new me({analysisViewData:this,view:this.view}),this._analysisController=new we({analysisViewData:this,view:this.view})}destroy(){this._placementTask=ht(this._placementTask),this._analysisVisualization=dt(this._analysisVisualization),ea(this)}get updating(){return this._analysisVisualization?.loadingMessages??!1}get results(){return this.analysis.dimensions.map(t=>this._dimensionsToComputations.get(t).result)}get selectedComputation(){const{selectedDimension:t}=this;return t==null?null:this._dimensionsToComputations.get(t)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(t){return this.selectedDimension=null,this._placementTask=ht(this._placementTask),this._placementTask=ta(this,t),this._placementTask.promise}_onDimensionAdd(t){const{computations:e,_dimensionsToComputations:n}=this;if(n.has(t))return;const i=new W({dimension:t,projectAndAlignPoint:this._projectAndAlignPoint});e.add(i),n.set(t,i)}_onDimensionRemove(t){const{computations:e,_dimensionsToComputations:n}=this,i=e.findIndex(r=>r.dimension===t),s=e.at(i);s.dimension===this.selectedDimension&&(this.selectedDimension=null),e.removeAt(i),n.delete(t),dt(s)}_onDimensionsClear(){this.computations.drain(t=>t.destroy()),this._dimensionsToComputations.clear()}};u([h({readOnly:!0})],k.prototype,"type",void 0),u([h()],k.prototype,"tool",void 0),u([h()],k.prototype,"updating",null),u([h({readOnly:!0})],k.prototype,"results",null),u([h({readOnly:!0})],k.prototype,"computations",void 0),u([h()],k.prototype,"selectedDimension",void 0),u([h()],k.prototype,"selectedComputation",null),u([h()],k.prototype,"_analysisVisualization",void 0),u([h()],k.prototype,"_analysisController",void 0),u([h()],k.prototype,"_dimensionsToComputations",void 0),u([h()],k.prototype,"_placementTask",void 0),k=u([H("esri.views.3d.analysis.DimensionAnalysisView3D")],k);const yl=k;var Ll=Object.freeze(Object.defineProperty({__proto__:null,default:yl},Symbol.toStringTag,{value:"Module"}));export{Ll as D,Al as E,Eo as T,In as a,Dl as b,Rl as l,Un as n,Lo as r,Ao as s,Fn as u};
